<!DOCTYPE html>
<html lang="hi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Panel - UP Outsourcing Sangh</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- QR, PDF & Canvas Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase_config.js"></script>
    <style>
        /* Global & Reset */
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
        }

        /* Layout */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #2c3e50;
            color: white;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        .sidebar-header {
            padding: 20px;
            background: #1a252f;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #34495e;
        }

        .sidebar-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
        }

        .sidebar-menu li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: #bdc3c7;
            text-decoration: none;
            border-left: 4px solid transparent;
            transition: all 0.2s;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .sidebar-menu li a:hover,
        .sidebar-menu li a.active {
            background: #34495e;
            color: white;
            border-left-color: #3498db;
        }

        .sidebar-menu li a i {
            width: 25px;
            margin-right: 10px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* Top Header */
        .top-header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .notification-icon {
            position: relative;
            cursor: pointer;
            color: #666;
            font-size: 1.2rem;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            font-size: 0.7rem;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-profile-h {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .user-profile-h img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ddd;
        }

        /* Dashboard Content Area */
        .content-padding {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        /* Welcome Card */
        .welcome-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            margin-bottom: 25px;
        }

        .welcome-avatar {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid #eee;
        }

        .welcome-info h1 {
            margin: 0 0 5px 0;
            font-size: 1.6rem;
            color: #2c3e50;
        }

        .welcome-details {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .welcome-detail-item strong {
            color: #333;
        }

        /* Status Strip */
        .status-strip {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            padding: 20px;
            border-radius: 8px;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status-card.green {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .status-card.blue {
            background: linear-gradient(135deg, #2980b9, #3498db);
        }

        .status-card.orange {
            background: linear-gradient(135deg, #d35400, #e67e22);
            cursor: pointer;
        }

        .status-card.info {
            background: linear-gradient(135deg, #34495e, #556c81);
            cursor: pointer;
        }

        .status-icon {
            font-size: 2rem;
            opacity: 0.8;
        }

        .status-text h4 {
            margin: 0;
            font-size: 1.1rem;
        }

        .status-text p {
            margin: 5px 0 0 0;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Feature Grid */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #f0f0f0;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-color: #3498db;
        }

        .feature-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: #ebf5fb;
            color: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .feature-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.15rem;
            color: #2c3e50;
        }

        .feature-info p {
            margin: 0;
            font-size: 0.85rem;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Notices & Documents Split */
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .content-box {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            overflow: hidden;
        }

        .box-header {
            padding: 15px 20px;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .box-header h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 500;
        }

        .list-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .list-item:hover {
            background: #f9f9f9;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-icon {
            color: #3498db;
            font-size: 1.2rem;
        }

        .list-text {
            flex: 1;
        }

        .list-text h4 {
            margin: 0 0 3px 0;
            font-size: 0.95rem;
            color: #333;
        }

        .list-text p {
            margin: 0;
            font-size: 0.8rem;
            color: #888;
        }

        /* Section Visibility */
        .section-view {
            display: none;
        }

        .section-view.active {
            display: block;
        }

        @media (max-width: 900px) {
            .sidebar {
                display: none;
                /* Mobile sidebar toggle logic would be needed here */
            }

            .bottom-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="logo.jpg" alt="Logo">
                <h2>Union Panel</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a onclick="switchSection('dashboard')" id="nav-dashboard" class="active"><i
                            class="fa-solid fa-house"></i> Dashboard</a></li>
                <li><a onclick="switchSection('profile')" id="nav-profile"><i class="fa-solid fa-user"></i> My
                        Profile</a></li>
                <li><a onclick="switchSection('membership')" id="nav-membership"><i
                            class="fa-solid fa-address-card"></i> Membership</a></li>
                <li><a onclick="switchSection('idcard')" id="nav-idcard"><i class="fa-solid fa-id-badge"></i> My ID
                        Card</a></li>
                <li><a onclick="switchSection('applications')" id="nav-applications"><i
                            class="fa-solid fa-clipboard-list"></i> Applications</a></li>
                <li><a onclick="switchSection('complaints')" id="nav-complaints"><i class="fa-solid fa-bullhorn"></i>
                        Complaints</a></li>
                <li><a onclick="switchSection('payments')" id="nav-payments"><i
                            class="fa-solid fa-indian-rupee-sign"></i> Payments</a></li>
                <li><a onclick="switchSection('notices')" id="nav-notices"><i class="fa-solid fa-bell"></i> Notices</a>
                </li>
                <li><a onclick="switchSection('downloads')" id="nav-downloads"><i class="fa-solid fa-download"></i>
                        Downloads</a></li>
                <li><a onclick="switchSection('support')" id="nav-support"><i class="fa-solid fa-headset"></i>
                        Support</a></li>
                <li style="margin-top: auto; border-top: 1px solid #34495e;"><a onclick="logoutMember()"
                        style="color: #e74c3c;"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="header-title">Union Member Panel</div>
                <div class="user-menu">
                    <div class="notification-icon" onclick="switchSection('notices')" title="Notifications/Notices">
                        <i class="fa-solid fa-bell"></i>
                        <span class="notification-badge" id="notificationBtnBadge" style="display:none;">0</span>
                    </div>
                    <div class="notification-icon" onclick="switchSection('complaints')" title="Messages/Complaints">
                        <i class="fa-solid fa-envelope"></i>
                        <span class="notification-badge" id="messageBtnBadge" style="display:none;">0</span>
                    </div>
                    <div class="user-profile-h" onclick="switchSection('profile')">
                        <img id="headerAvatar" src="member_def_photo.jpg" alt="User">
                        <i class="fa-solid fa-caret-down" style="font-size: 0.8rem; color: #666;"></i>
                    </div>
                </div>
            </header>

            <div class="content-padding">

                <!-- 1. DASHBOARD OVERVIEW SECTION -->
                <div id="section-dashboard" class="section-view active">

                    <!-- Welcome Card -->
                    <div class="welcome-card">
                        <img id="dashAvatar" src="member_def_photo.jpg" alt="Profile" class="welcome-avatar">
                        <div class="welcome-info">
                            <h1 id="welcomeName">Welcome, Member</h1>
                            <div class="welcome-details">
                                <div class="welcome-detail-item">
                                    Member ID: <strong id="dashMemId">--</strong>
                                </div>
                                <div class="welcome-detail-item"
                                    style="border-left: 1px solid #eee; padding-left: 20px;">
                                    District: <strong id="dashDist">--</strong>
                                </div>
                                <div class="welcome-detail-item"
                                    style="border-left: 1px solid #eee; padding-left: 20px;">
                                    Valid Till: <strong id="dashValid">31 Dec 2025</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Strip -->
                    <div class="status-strip">
                        <div class="status-card green">
                            <div class="status-icon"><i class="fa-solid fa-circle-check"></i></div>
                            <div class="status-text">
                                <h4>Active Member</h4>
                                <p>Membership Verified</p>
                            </div>
                        </div>
                        <div class="status-card blue" onclick="switchSection('idcard')">
                            <div class="status-icon"><i class="fa-solid fa-id-card"></i></div>
                            <div class="status-text">
                                <h4>ID Card</h4>
                                <p>Download Available ></p>
                            </div>
                        </div>
                        <div class="status-card orange" onclick="switchSection('payments')">
                            <div class="status-icon"><i class="fa-solid fa-circle-exclamation"></i></div>
                            <div class="status-text">
                                <h4>Payment Due: <span id="dashDue">₹0</span></h4>
                                <p>Tap to Pay Now ></p>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Grid -->
                    <div class="feature-grid">
                        <div class="feature-card" onclick="switchSection('profile')">
                            <div class="feature-icon"><i class="fa-solid fa-user-tie"></i></div>
                            <div class="feature-info">
                                <h3>My Profile</h3>
                                <p>View & Edit Details <i class="fa-solid fa-chevron-right"
                                        style="font-size: 0.7rem;"></i></p>
                            </div>
                        </div>
                        <div class="feature-card" onclick="switchSection('membership')">
                            <div class="feature-icon"><i class="fa-solid fa-address-book"></i></div>
                            <div class="feature-info">
                                <h3>Membership Details</h3>
                                <p>Renew & Status <i class="fa-solid fa-chevron-right" style="font-size: 0.7rem;"></i>
                                </p>
                            </div>
                        </div>
                        <div class="feature-card" onclick="switchSection('idcard')">
                            <div class="feature-icon"><i class="fa-solid fa-id-badge"></i></div>
                            <div class="feature-info">
                                <h3>My ID Card</h3>
                                <p>View / Download <i class="fa-solid fa-chevron-right" style="font-size: 0.7rem;"></i>
                                </p>
                            </div>
                        </div>
                        <div class="feature-card" onclick="switchSection('applications')">
                            <div class="feature-icon"><i class="fa-solid fa-file-pen"></i></div>
                            <div class="feature-info">
                                <h3>Applications</h3>
                                <p>Check Status <i class="fa-solid fa-chevron-right" style="font-size: 0.7rem;"></i></p>
                            </div>
                        </div>
                        <div class="feature-card" onclick="switchSection('complaints')">
                            <div class="feature-icon"><i class="fa-solid fa-bullhorn"></i></div>
                            <div class="feature-info">
                                <h3>Complaints</h3>
                                <p>Submit & Track <i class="fa-solid fa-chevron-right" style="font-size: 0.7rem;"></i>
                                </p>
                            </div>
                        </div>
                        <div class="feature-card" onclick="switchSection('payments')">
                            <div class="feature-icon"><i class="fa-solid fa-wallet"></i></div>
                            <div class="feature-info">
                                <h3>Payments</h3>
                                <p>Pay Fees / Receipts <i class="fa-solid fa-chevron-right"
                                        style="font-size: 0.7rem;"></i></p>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Lists -->
                    <div class="bottom-section">
                        <!-- Notices -->
                        <div class="content-box">
                            <div class="box-header">
                                <h3><i class="fa-solid fa-bullhorn"></i> Notices & Events</h3>
                                <small style="cursor: pointer; color: #3498db;">View All</small>
                            </div>
                            <div class="list-item">
                                <i class="fa-solid fa-calendar-check list-icon"></i>
                                <div class="list-text">
                                    <h4>Union General Meeting</h4>
                                    <p>5th Feb 2025 - Lucknow HQ</p>
                                </div>
                            </div>
                            <div class="list-item">
                                <i class="fa-solid fa-file-contract list-icon"></i>
                                <div class="list-text">
                                    <h4>New Membership Rules</h4>
                                    <p>Circular #UPOS-2025-01</p>
                                </div>
                            </div>
                        </div>

                        <!-- Documents -->
                        <div class="content-box">
                            <div class="box-header">
                                <h3><i class="fa-solid fa-folder-open"></i> Documents</h3>
                                <small style="cursor: pointer; color: #3498db;">View All</small>
                            </div>
                            <div class="list-item">
                                <i class="fa-solid fa-book list-icon"></i>
                                <div class="list-text">
                                    <h4>Union Constitution</h4>
                                    <p>PDF - 2.5 MB</p>
                                </div>
                                <i class="fa-solid fa-download" style="color:#aaa;"></i>
                            </div>
                            <div class="list-item">
                                <i class="fa-solid fa-file-lines list-icon"></i>
                                <div class="list-text">
                                    <h4>Membership Form</h4>
                                    <p>PDF - 1.0 MB</p>
                                </div>
                                <i class="fa-solid fa-download" style="color:#aaa;"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Help & Password -->
                    <div class="bottom-section" style="margin-top: 20px;">
                        <div class="content-box"
                            style="padding: 20px; display: flex; align-items: center; gap: 20px; cursor: pointer;"
                            onclick="switchSection('support')">
                            <div
                                style="width: 50px; height: 50px; background: #e8f8f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #1abc9c; font-size: 1.5rem;">
                                <i class="fa-solid fa-headset"></i>
                            </div>
                            <div>
                                <h4 style="margin: 0; font-size: 1.1rem;">Support / Helpdesk</h4>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">Contact Admin for
                                    assistance ></p>
                            </div>
                        </div>

                        <div class="content-box"
                            style="padding: 20px; display: flex; align-items: center; gap: 20px; cursor: pointer;">
                            <div
                                style="width: 50px; height: 50px; background: #fef9e7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #f1c40f; font-size: 1.5rem;">
                                <i class="fa-solid fa-key"></i>
                            </div>
                            <div>
                                <h4 style="margin: 0; font-size: 1.1rem;">Change Password</h4>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">Update your login password
                                    ></p>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- 2. PLACEHOLDER SECTIONS FOR OTHER VIEWS -->
                <div id="section-profile" class="section-view">
                    <div class="welcome-card">
                        <h2 style="margin:0;">My Profile</h2>
                    </div>
                    <div class="content-box" style="padding: 30px;">

                        <!-- Profile Edit Form & Full Details -->
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">

                            <!-- Header / Avatar Edit -->
                            <div style="text-align: center; position: relative;">
                                <div style="position: relative; display: inline-block;">
                                    <img id="editProfilePreview" src="member_def_photo.jpg"
                                        style="width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                                    <label id="photoEditBtn" for="profileUpload"
                                        style="position: absolute; bottom: 5px; right: 5px; background: #3498db; color: white; width: 35px; height: 35px; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"
                                        title="Change Photo">
                                        <i class="fa-solid fa-camera"></i>
                                    </label>
                                    <input type="file" id="profileUpload" accept="image/*" style="display: none;">
                                </div>
                                <div style="margin-top:10px;">
                                    <button id="btnToggleEdit" onclick="toggleEditMode()" class="btn-sm"
                                        style="background:#3498db; color:white; border:none; padding:5px 15px; border-radius:4px; cursor:pointer;">
                                        <i class="fa-solid fa-pen"></i> Edit Profile Fields
                                    </button>
                                </div>
                                <h2 id="dispName" style="margin: 10px 0 5px 0; color: #2c3e50;">Member Name</h2>
                                <p id="dispRole" style="margin: 0; color: #7f8c8d; font-size: 0.9rem;">Job Role</p>
                            </div>

                            <hr style="width: 100%; border: 0; border-top: 1px solid #eee; margin: 10px 0;">

                            <!-- Personal Details Grid -->
                            <div
                                style="width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; text-align: left;">

                                <!-- Personal Info -->
                                <div>
                                    <h4
                                        style="color: #3498db; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; margin-bottom: 15px;">
                                        <i class="fa-solid fa-user"></i> Personal Information
                                    </h4>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label
                                            style="font-size: 0.85rem; color: #888; display: block; margin-bottom: 5px;">Full
                                            Name</label>
                                        <input type="text" id="editName" class="form-control" disabled
                                            style="width: 100%; padding: 10px; border: 1px solid #eee; background: #f9f9f9; border-radius: 5px; color: #555;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label
                                            style="font-size: 0.85rem; color: #888; display: block; margin-bottom: 5px;">Father's
                                            Name</label>
                                        <input type="text" id="dispFname" class="editable-field" disabled
                                            style="width: 100%; padding: 10px; border: 1px solid #eee; background: #f9f9f9; border-radius: 5px; color: #555;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label
                                            style="font-size: 0.85rem; color: #888; display: block; margin-bottom: 5px;">Date
                                            of Birth</label>
                                        <input type="date" id="editDob" class="editable-field" disabled
                                            style="width: 100%; padding: 10px; border: 1px solid #eee; background: #f9f9f9; border-radius: 5px; color: #555;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label
                                            style="font-size: 0.85rem; color: #888; display: block; margin-bottom: 5px;">Mobile
                                            Number (Read Only)</label>
                                        <input type="text" id="editMobile" disabled
                                            style="width: 100%; padding: 10px; border: 1px solid #eee; background: #f9f9f9; border-radius: 5px; color: #555;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label
                                            style="font-size: 0.85rem; color: #888; display: block; margin-bottom: 5px;">My
                                            Signature</label>
                                        <div
                                            style="width: 100%; min-height: 100px; border: 1px solid #ddd; background: #f9f9f9; border-radius: 5px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 10px;">
                                            <img id="dispSignature" src=""
                                                style="max-width: 100%; max-height: 100px; object-fit: contain; display: none;">
                                            <span id="sigPlaceholder" style="color: #bbb; font-size: 0.8rem;">No
                                                signature uploaded</span>

                                            <label id="sigEditBtn" for="sigUpload"
                                                style="position: absolute; bottom: 5px; right: 5px; background: #3498db; color: white; width: 30px; height: 30px; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"
                                                title="Change Signature">
                                                <i class="fa-solid fa-camera"></i>
                                            </label>
                                            <input type="file" id="sigUpload" accept="image/*" style="display: none;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Professional & Address Info -->
                                <div>
                                    <h4
                                        style="color: #3498db; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; margin-bottom: 15px;">
                                        <i class="fa-solid fa-briefcase"></i> Work & Address
                                    </h4>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label
                                            style="font-size: 0.85rem; color: #888; display: block; margin-bottom: 5px;">Work
                                            Location (District/Block)</label>
                                        <input type="text" id="dispWorkLoc" disabled
                                            style="width: 100%; padding: 10px; border: 1px solid #eee; background: #f9f9f9; border-radius: 5px; color: #555;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label
                                            style="font-size: 0.85rem; color: #888; display: block; margin-bottom: 5px;">Department</label>
                                        <input type="text" id="dispDept" class="editable-field" disabled
                                            style="width: 100%; padding: 10px; border: 1px solid #eee; background: #f9f9f9; border-radius: 5px; color: #555;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label
                                            style="font-size: 0.85rem; color: #888; display: block; margin-bottom: 5px;">Post</label>
                                        <input type="text" id="dispPost" class="editable-field" disabled
                                            style="width: 100%; padding: 10px; border: 1px solid #eee; background: #f9f9f9; border-radius: 5px; color: #555;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label
                                            style="font-size: 0.85rem; color: #888; display: block; margin-bottom: 5px;">Home
                                            Location (District/Block)</label>
                                        <input type="text" id="dispHomeLoc" disabled
                                            style="width: 100%; padding: 10px; border: 1px solid #eee; background: #f9f9f9; border-radius: 5px; color: #555;">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label
                                            style="font-size: 0.85rem; color: #888; display: block; margin-bottom: 5px;">Home
                                            Address Details</label>
                                        <textarea id="dispHomeAddr" class="editable-field" disabled
                                            style="width: 100%; padding: 10px; border: 1px solid #eee; background: #f9f9f9; border-radius: 5px; resize: vertical; color: #555;"
                                            rows="4"></textarea>
                                    </div>
                                </div>

                            </div>

                            <!-- Save Action -->
                            <button id="btnSaveProfile" onclick="saveProfileChanges()" class="btn-primary"
                                style="display:none; background: #27ae60; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.95rem; width: 100%; max-width: 380px; margin-top: 20px; box-shadow: 0 4px 6px rgba(39, 174, 96, 0.2);">
                                <i class="fa-solid fa-cloud-upload"></i> Apply Admin Change Profile Request
                            </button>
                            <p id="editNote" style="display:none; font-size: 0.8rem; color: #e74c3c; margin-top: 5px;">
                                <i class="fa-solid fa-circle-info"></i> Note: Changes will be active after Block Panel
                                approval.
                            </p>

                        </div>

                        <button onclick="switchSection('dashboard')"
                            style="margin-top: 30px; background: none; border: none; color: #666; cursor: pointer;">
                            <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
                        </button>
                    </div>
                </div>

                <div id="section-membership" class="section-view">
                    <div class="welcome-card">
                        <h2 style="margin:0;"><i class="fa-solid fa-address-card"></i> Membership Details</h2>
                    </div>

                    <div class="status-strip">
                        <div class="status-card blue">
                            <div class="status-icon"><i class="fa-solid fa-calendar-check"></i></div>
                            <div class="status-text">
                                <h4>Validity Date</h4>
                                <p id="memExpiryDate">31 Dec 2025</p>
                            </div>
                        </div>
                        <div id="renewalStatusCard" class="status-card orange" onclick="initMembershipRenewal()"
                            style="display: none;">
                            <div class="status-icon"><i class="fa-solid fa-arrows-rotate"></i></div>
                            <div class="status-text">
                                <h4>Renew Now</h4>
                                <p>Membership Expiring Soon</p>
                            </div>
                        </div>
                    </div>

                    <div class="content-box">
                        <div class="box-header">
                            <h3><i class="fa-solid fa-history"></i> Membership History</h3>
                        </div>
                        <div style="padding: 0; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; text-align: left; font-size: 0.9rem;">
                                <thead style="background: #f8f9fa; border-bottom: 2px solid #eee;">
                                    <tr>
                                        <th style="padding: 12px 20px;">Event</th>
                                        <th style="padding: 12px 20px;">Date</th>
                                        <th style="padding: 12px 20px;">Status</th>
                                        <th style="padding: 12px 20px;">Valid Till</th>
                                    </tr>
                                </thead>
                                <tbody id="membershipHistoryBody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="switchSection('dashboard')" style="margin-top:20px;">
                        <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>

                <div id="section-idcard" class="section-view">
                    <div class="welcome-card">
                        <h2 style="margin:0;"><i class="fa-solid fa-id-card"></i> My Identity Card</h2>
                    </div>

                    <div class="content-box" style="padding:40px; text-align:center; background: #f8f9fa;">
                        <p style="margin-bottom:20px; color:#666;">Aapka official identity card yahan preview karein aur
                            download karein.</p>

                        <div id="idCardPreviewContainer"
                            style="margin: 0 auto 30px; display:inline-block; transform: scale(0.9);">
                            <!-- Professional card will be rendered here -->
                            <div
                                style="width:420px; height:250px; border: 2px dashed #ccc; border-radius:10px; display:flex; align-items:center; justify-content:center; background:white;">
                                <div style="text-align:center; color:#999;">
                                    <i class="fa-solid fa-id-badge" style="font-size:3rem; margin-bottom:10px;"></i>
                                    <p>Click "Preview Card" to Load</p>
                                </div>
                            </div>
                        </div>

                        <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                            <button onclick="viewIDCard()" class="btn btn-primary">
                                <i class="fa-solid fa-eye"></i> Preview ID Card
                            </button>
                            <button onclick="printIDCard()" class="btn btn-info">
                                <i class="fa-solid fa-print"></i> Print / Save
                            </button>
                            <button onclick="downloadIDCardPDF()" class="btn btn-success">
                                <i class="fa-solid fa-file-pdf"></i> Download PDF
                            </button>
                        </div>
                    </div>

                    <p style="text-align:center; margin-top:20px; color:#e67e22; font-size:0.85rem; font-weight:600;">
                        <i class="fa-solid fa-circle-info"></i> Note: Identity Card tabhi valid hai jab member status
                        "Approved" ho.
                    </p>
                </div>

                <div id="section-payments" class="section-view">
                    <div class="welcome-card">
                        <h2 style="margin:0;"><i class="fa-solid fa-indian-rupee-sign"></i> Payment History</h2>
                    </div>

                    <div class="content-box">
                        <div class="box-header">
                            <h3><i class="fa-solid fa-receipt"></i> Transaction Receipts</h3>
                        </div>
                        <div style="padding: 0; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; text-align: left; font-size: 0.9rem;">
                                <thead style="background: #f8f9fa; border-bottom: 2px solid #eee;">
                                    <tr>
                                        <th style="padding: 12px 20px;">Purpose</th>
                                        <th style="padding: 12px 20px;">Amount</th>
                                        <th style="padding: 12px 20px;">Date</th>
                                        <th style="padding: 12px 20px;">Status</th>
                                        <th style="padding: 12px 20px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentHistoryBody">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="switchSection('dashboard')" style="margin-top:20px;">
                        <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>

                <div id="section-applications" class="section-view">
                    <div
                        style="background: #006eb3; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; margin-bottom: 25px;">
                        <h1 style="margin: 0; font-size: 1.8rem;">आवेदन फॉर्म</h1>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;">नया आवेदन दर्ज करें</p>
                    </div>

                    <div class="content-box" style="padding: 30px; border-radius: 0 0 10px 10px; border-top: none;">
                        <form id="applicationForm" onsubmit="submitApplication(event)">
                            <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label
                                        style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">आवेदन
                                        का प्रकार :</label>
                                    <select id="appType" class="form-control"
                                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                                        <option value="Welfare Fund">वेलफेयर फंड सहायता</option>
                                        <option value="ID Correction">आईडी कार्ड सुधार</option>
                                        <option value="Other">अन्य सहायता</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label
                                        style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">पूरा
                                        नाम :</label>
                                    <input type="text" id="appFullName" class="form-control" readonly
                                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; color: #555;">
                                </div>

                                <div class="form-group">
                                    <label
                                        style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">सदस्य
                                        आईडी नंबर :</label>
                                    <input type="text" id="appMemberId" class="form-control" readonly
                                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; color: #555;">
                                </div>

                                <div class="form-group">
                                    <label
                                        style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">विभाग
                                        :</label>
                                    <select id="appDept" class="form-control"
                                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                                        <option value="Production">प्रोडक्शन</option>
                                        <option value="Maintenance">मेंटेनेंस</option>
                                        <option value="HR/Admin">एचआर/एडमिन</option>
                                        <option value="Security">सिक्योरिटी</option>
                                        <option value="Other">अन्य</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label
                                        style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">आवेदन
                                        का विषय :</label>
                                    <input type="text" id="appSubject" class="form-control" required
                                        placeholder="जैसे: वेलफेयर फंड हेतु आवेदन"
                                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label
                                        style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">विवरण
                                        :</label>
                                    <textarea id="appDetails" class="form-control" rows="5" required
                                        placeholder="अपना विवरण यहाँ लिखें..."
                                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: none;"></textarea>
                                </div>

                                <div class="form-group">
                                    <label
                                        style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">फ़ाइल
                                        अपलोड करें :</label>
                                    <input type="file" id="appFile"
                                        style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; background: #fdfdfd;">
                                </div>

                                <div
                                    style="display: flex; gap: 15px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 20px;">
                                    <button type="submit" class="btn"
                                        style="background: #007bff; color: white; padding: 12px 25px; border-radius: 6px; font-weight: bold; flex: 1; border: none; cursor: pointer;">आवेदन
                                        सबमिट करें</button>
                                    <button type="button" onclick="switchSection('dashboard')" class="btn"
                                        style="background: #e9ecef; color: #495057; padding: 12px 25px; border-radius: 6px; font-weight: bold; border: none; cursor: pointer;">रद्द
                                        करें</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Application Status List -->
                    <div style="margin-top: 30px;">
                        <h3
                            style="color: #1a5f7a; border-left: 4px solid #007bff; padding-left: 10px; margin-bottom: 15px;">
                            आवेदन स्थिति : <span id="latestAppStatus"
                                style="font-size: 0.9rem; margin-left: 10px;">वर्तमान स्थिति: <span
                                    style="background: #ffeaa7; color: #d35400; padding: 2px 10px; border-radius: 4px; font-weight: bold;">तवित</span></span>
                        </h3>
                        <div id="applicationHistory" style="display: flex; flex-direction: column; gap: 15px;">
                            <!-- Applications will be loaded here -->
                        </div>
                    </div>
                </div>

                <div id="section-complaints" class="section-view">
                    <div class="welcome-card"
                        style="background: linear-gradient(135deg, #1a5f7a, #007bff); text-align: center; display: block; padding: 25px;">
                        <h2 style="margin:0; color: white; font-size: 1.8rem;">शिकायत फॉर्म</h2>
                        <p style="margin: 5px 0 0 0; color: rgba(255,255,255,0.9); font-size: 1rem;">नई शिकायत दर्ज करें
                        </p>
                    </div>

                    <div class="content-box" style="padding: 30px; margin-top: 20px;">
                        <form id="complaintForm" onsubmit="submitComplaint(event)">
                            <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">

                                <div class="form-group">
                                    <label
                                        style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">शिकायत
                                        का प्रकार :*</label>
                                    <select id="compType" class="form-control"
                                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;"
                                        required>
                                        <option value="">चुनें...</option>
                                        <option value="Salary / Overtime">सैलरी / ओवरटाइम समस्या</option>
                                        <option value="Membership">सदस्यता संबंधी</option>
                                        <option value="ID Card">आईडी कार्ड समस्या</option>
                                        <option value="Management Behavior">प्रबंधन का व्यवहार</option>
                                        <option value="Other">अन्य</option>
                                    </select>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="form-group">
                                        <label
                                            style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">पूरा
                                            नाम :*</label>
                                        <input type="text" id="compName" class="form-control"
                                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa;"
                                            readonly>
                                    </div>
                                    <div class="form-group">
                                        <label
                                            style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">सदस्य
                                            आईडी नंबर :*</label>
                                        <input type="text" id="compMemberId" class="form-control"
                                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa;"
                                            readonly>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label
                                        style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">शिकायत
                                        का विषय :*</label>
                                    <select id="compSubject" class="form-control"
                                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;"
                                        required>
                                        <option value="">चुनें...</option>
                                        <option value="Salary Delay">सैलरी समय पर नहीं मिल रही</option>
                                        <option value="Overtime Issue">ओवरटाइम का भुगतान नहीं</option>
                                        <option value="Termination">बिना बताए काम से निकाला</option>
                                        <option value="Harassment">कार्यस्थल पर शोषण</option>
                                        <option value="Manual">अन्य (नीचे विवरण दें)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label
                                        style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">विवरण
                                        :*</label>
                                    <textarea id="compDetails" class="form-control" rows="5"
                                        style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"
                                        placeholder="अपनी शिकायत का विस्तृत विवरण यहाँ लिखें..." required></textarea>
                                </div>

                                <div class="form-group">
                                    <label
                                        style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a5f7a;">फाइल
                                        अपलोड करें :</label>
                                    <input type="file" id="compFile" class="form-control"
                                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <small style="color: #666;">(वैकल्पिक: यदि कोई दस्तावेज या फोटो है)</small>
                                </div>

                                <div style="display: flex; gap: 15px; margin-top: 10px;">
                                    <button type="submit" class="btn"
                                        style="background: #007bff; color: white; padding: 12px 25px; border-radius: 6px; font-weight: 600; flex: 1; border: none; cursor: pointer;">
                                        शिकायत सबमिट करें
                                    </button>
                                    <button type="reset" class="btn"
                                        style="background: #e9ecef; color: #495057; padding: 12px 25px; border-radius: 6px; font-weight: 600; flex: 1; border: none; cursor: pointer;">
                                        रद करें
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3
                            style="color: #1a5f7a; border-left: 4px solid #007bff; padding-left: 10px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                            शिकायत स्थिति :
                            <span id="latestCompStatus" style="font-size: 0.9rem; font-weight: normal;">
                                वर्तमान स्थिति: <span
                                    style="background: #ffeaa7; color: #d35400; padding: 2px 10px; border-radius: 4px; font-weight: bold;">लंबित</span>
                            </span>
                        </h3>
                        <div id="complaintHistory" style="display: flex; flex-direction: column; gap: 15px;">
                            <!-- Complaints history tracking -->
                        </div>
                    </div>
                </div>

                <!-- Support / Sahyog Section -->
                <div id="section-support" class="section-view">
                    <div class="welcome-card"
                        style="background: linear-gradient(135deg, #16a085, #27ae60); text-align: center; display: block; padding: 25px;">
                        <h2 style="margin:0; color: white; font-size: 1.8rem;">सहयोग (Support/Donation)</h2>
                        <p style="margin: 5px 0 0 0; color: rgba(255,255,255,0.9); font-size: 1rem;">संघ की मजबूती के
                            लिए अपना योगदान दें</p>
                    </div>

                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                        <!-- Payment Methods Info -->
                        <div class="content-box" style="padding: 25px;">
                            <h3 style="color: #1a5f7a; margin-top: 0;"><i class="fa-solid fa-building-columns"></i>
                                भुगतान विकल्प</h3>
                            <div style="background: #f0f7f4; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p style="margin: 5px 0;"><strong>खाता धारक:</strong> Deepak Bajpai</p>
                                <p style="margin: 5px 0;"><strong>बैंक:</strong> Kotak Mahindra Bank</p>
                                <p style="margin: 5px 0;"><strong>A/C:</strong> 8013132213</p>
                                <p style="margin: 5px 0;"><strong>IFSC:</strong> KKBK0005195</p>
                            </div>
                            <div style="text-align: center;">
                                <p style="font-weight: bold; margin-bottom: 10px;">Scan QR to Pay (Sahyog)</p>
                                <img src="donation_qr.jpg" alt="Donation QR"
                                    style="width: 150px; border: 1px solid #ddd; border-radius: 8px;">
                                <p style="color: #666; font-size: 0.85rem; margin-top: 5px;">UPI ID: upsangh@kotak</p>
                            </div>
                        </div>

                        <!-- Donation Report Form -->
                        <div class="content-box" style="padding: 25px;">
                            <h3 style="color: #1a5f7a; margin-top: 0;"><i class="fa-solid fa-file-invoice-dollar"></i>
                                सहयोग की सूचना दें</h3>
                            <form id="donationForm" onsubmit="submitDonation(event)">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">सहयोग राशि
                                        (Amount) :*</label>
                                    <input type="number" id="donAmount" class="form-control"
                                        placeholder="₹ Enter Amount"
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"
                                        required>
                                </div>
                                <div class="form-row" style="display: flex; gap: 15px; margin-bottom: 15px;">
                                    <div style="flex: 1;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">तारीख
                                            (Date) :*</label>
                                        <input type="date" id="donDate" class="form-control"
                                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"
                                            required>
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Transaction
                                            ID :*</label>
                                        <input type="text" id="donTxnId" class="form-control"
                                            placeholder="Last 6 Digits"
                                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;"
                                            required>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">टिप्पणी
                                        (Optional) :</label>
                                    <textarea id="donNote" class="form-control" placeholder="Any message..."
                                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: none;"></textarea>
                                </div>
                                <button type="submit" class="btn"
                                    style="width: 100%; background: #27ae60; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                                    सूचना सबमिट करें (Submit Info)
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Donation History -->
                    <div style="margin-top: 30px;">
                        <h3
                            style="color: #1a5f7a; border-left: 4px solid #27ae60; padding-left: 10px; margin-bottom: 15px;">
                            मेरे पिछले सहयोग (Donation History)
                        </h3>
                        <div id="donationHistory" class="content-box" style="padding: 0; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; text-align: left; font-size: 0.9rem;">
                                <thead style="background: #f8f9fa; border-bottom: 2px solid #eee;">
                                    <tr>
                                        <th style="padding: 12px 20px;">Date</th>
                                        <th style="padding: 12px 20px;">Amount</th>
                                        <th style="padding: 12px 20px;">Transaction ID</th>
                                        <th style="padding: 12px 20px;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="donationHistoryBody">
                                    <tr>
                                        <td colspan="4" style="text-align:center; padding: 20px; color: #999;">No
                                            history found.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 8. PAYMENTS SECTION -->
                <div id="section-payments" class="section-view">
                    <div class="header-flex">
                        <h2><i class="fa-solid fa-indian-rupee-sign"></i> शुल्क भुगतान इतिहास (Payment History)</h2>
                        <button class="btn btn-sm btn-primary" onclick="loadPaymentHistory()"><i
                                class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                    </div>

                    <div class="card-glass" style="margin-top:20px;">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Reason/Plan</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentHistoryBody">
                                    <tr>
                                        <td colspan="4" style="text-align:center; padding: 20px; color: #999;">No
                                            history found.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 9. NOTICES SECTION -->
                <div id="section-notices" class="section-view">
                    <div class="header-flex">
                        <h2><i class="fa-solid fa-bullhorn"></i> महत्वपूर्ण सूचनाएं (Important Notices)</h2>
                        <button class="btn btn-sm btn-primary" onclick="loadMemberNotices()"><i
                                class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                    </div>

                    <div id="noticesContainer" style="margin-top: 25px; display: grid; gap: 20px;">
                        <!-- Notices will be loaded here -->
                        <div
                            style="padding: 30px; text-align: center; color: #888; background: white; border-radius: 12px; border: 1px dashed #ccc;">
                            <i class="fa-solid fa-spinner fa-spin"
                                style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            कृपया प्रतीक्षा करें, सूचनाएं लोड हो रही हैं...
                        </div>
                    </div>
                </div>

                <!-- 10. DOWNLOADS SECTION -->
                <div id="section-downloads" class="section-view">
                    <div class="header-flex">
                        <h2><i class="fa-solid fa-download"></i> दस्तावेज़ डाउनलोड (Downloads)</h2>
                        <button class="btn btn-sm btn-primary" onclick="loadMemberDownloads()"><i
                                class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                    </div>

                    <div class="card-glass" style="margin-top:20px;">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Document Name</th>
                                        <th>Category</th>
                                        <th>Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="memberDownloadsBody">
                                    <tr>
                                        <td colspan="4" style="text-align:center; padding: 20px; color: #999;">Loading
                                            documents...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


            </div>
            <!-- End Content Padding -->
        </main>
    </div>

    <!-- Scripts -->
    <script src="script.js?v=2"></script>
    <script>
        // --- INLINE MEMBER DASHBOARD LOGIC ---

        // Switch Sections
        window.switchSection = function (id) {
            // Hide all
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));

            // Show target
            const target = document.getElementById('section-' + id);
            if (target) target.classList.add('active');

            // Highlight nav
            const nav = document.getElementById('nav-' + id);
            if (nav) nav.classList.add('active');

            // Persist for refresh
            localStorage.setItem('up_sangh_active_section', id);
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Check Auth
            const memberDataStr = localStorage.getItem('up_sangh_current_member');
            if (!memberDataStr) {
                window.location.replace('login.html');
                return;
            }
            const member = JSON.parse(memberDataStr);

            // Restore Section
            const lastSection = localStorage.getItem('up_sangh_active_section') || 'dashboard';
            switchSection(lastSection);

            let newPhotoBase64 = null;
            let newSigBase64 = null;

            // Check for Open Profile Update Request
            const allRequests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
            const myOpenRequest = allRequests.find(r => r.mobile === member.mobile && r.type === 'Profile Update' && r.status === 'Open');

            // Helper to set Avatar
            const setAvatar = (imgId, photoUrl, name) => {
                const imgEl = document.getElementById(imgId);
                const fallbackUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}+&background=random&color=fff&size=128`;

                if (photoUrl && photoUrl.trim() !== '') {
                    imgEl.src = photoUrl;
                    imgEl.onerror = () => { imgEl.src = fallbackUrl; }; // Fallback if 404
                } else {
                    imgEl.src = fallbackUrl;
                }
            };

            // Populate Header & Welcome
            const finalName = member.name || 'Member';
            setAvatar('headerAvatar', member.photo, finalName);
            setAvatar('dashAvatar', member.photo, finalName);

            document.getElementById('welcomeName').innerText = `Welcome, ${member.name}`;
            document.getElementById('dashMemId').innerText = member.member_id || member.id || 'UN' + Date.now().toString().slice(-6);
            document.getElementById('dashDist').innerText = (member.workDistrict || member.homeDistrict || 'UP') + ', UP';


            // Pre-fill Forms (Complaints & Applications)
            if (document.getElementById('compName')) document.getElementById('compName').value = member.name || '';
            if (document.getElementById('compMemberId')) document.getElementById('compMemberId').value = member.member_id || member.id || '';

            if (document.getElementById('appFullName')) document.getElementById('appFullName').value = member.name || '';
            if (document.getElementById('appMemberId')) document.getElementById('appMemberId').value = member.member_id || member.id || '';

            // loadApplicationHistory(); // Moved to bottom to avoid ReferenceError

            // Random/Mock Data for Visualization
            const mockDue = Math.floor(Math.random() * 500);
            document.getElementById('dashDue').innerText = "₹" + (member.fee_status === 'Paid' ? '0' : mockDue);

            // If fee is paid, change orange card
            if (member.fee_status === 'Paid') {
                const pCard = document.querySelector('.status-card.orange');
                if (pCard) {
                    pCard.classList.remove('orange');
                    pCard.classList.add('green');
                    pCard.querySelector('h4').innerText = "No Dues";
                    pCard.querySelector('p').innerText = "Payments Up to Date";
                }
            }

            // --- FIRESTORE REAL-TIME LISTENERS ---
            if (window.db && member.mobile) {
                console.log("Initializing Firestore Listeners for Member:", member.mobile);

                // 1. Sync User Profile (Members Collection)
                window.db.collection('members').where('mobile', '==', member.mobile).onSnapshot(snapshot => {
                    if (!snapshot.empty) {
                        const updatedMember = snapshot.docs[0].data();
                        updatedMember.firestoreId = snapshot.docs[0].id;
                        // Preserve session keys if needed, or just update
                        localStorage.setItem('up_sangh_current_member', JSON.stringify(updatedMember));

                        // Update UI seamlessly
                        if (updatedMember.status === 'Approved') {
                            document.querySelector('.status-card.green h4').innerText = "Active Member";
                            document.querySelector('.status-card.green p').innerText = "Membership Verified";
                        }
                    }
                });

                // 2. Sync Requests (User specific)
                window.db.collection('requests').where('mobile', '==', member.mobile).onSnapshot(snapshot => {
                    const reqs = []; // We only get ours, but local storage expects array.
                    // CAUTION: localStorage might hold ALL requests if we were admin. 
                    // But as member, we only care about ours. However, existing code might expect 'requests' to be a list.
                    // To be safe, we will read existing LS, remove our old ones, and append new ones? 
                    // No, simpler to just treat 'up_sangh_requests' as "My Requests" in this context?
                    // actually logic uses 'allRequests' but filters by mobile often. 
                    // Let's just store OUR requests.
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.firestoreId = doc.id;
                        reqs.push(d);
                    });
                    localStorage.setItem('up_sangh_requests', JSON.stringify(reqs));
                    if (window.loadMembershipHistory) window.loadMembershipHistory();
                    if (window.loadPaymentHistory) window.loadPaymentHistory();
                });

                // 3. Sync Applications
                window.db.collection('applications').where('mobile', '==', member.mobile).onSnapshot(snapshot => {
                    const apps = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.firestoreId = doc.id;
                        apps.push(d);
                    });
                    localStorage.setItem('up_sangh_member_applications', JSON.stringify(apps));
                    if (window.loadApplicationHistory) window.loadApplicationHistory();
                });

                // 4. Sync Complaints
                window.db.collection('complaints').where('mobile', '==', member.mobile).onSnapshot(snapshot => {
                    const comps = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.firestoreId = doc.id;
                        comps.push(d);
                    });
                    localStorage.setItem('up_sangh_member_complaints', JSON.stringify(comps));
                    if (window.loadComplaintHistory) window.loadComplaintHistory();
                });

                // 5. Sync Donations
                window.db.collection('donations').where('mobile', '==', member.mobile).onSnapshot(snapshot => {
                    const dons = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.firestoreId = doc.id;
                        dons.push(d);
                    });
                    localStorage.setItem('up_sangh_member_donations', JSON.stringify(dons));
                    if (window.loadDonationHistory) window.loadDonationHistory();
                });

                // 6. Sync Notices (Public)
                window.db.collection('notices').orderBy('id', 'desc').limit(20).onSnapshot(snapshot => {
                    const notices = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.firestoreId = doc.id;
                        notices.push(d);
                    });
                    // Merge or overwrite? Overwrite is safer for sync.
                    localStorage.setItem('up_sangh_notices', JSON.stringify(notices));
                    if (window.loadMemberNotices) window.loadMemberNotices();
                });

                // 7. Sync Documents (Public)
                window.db.collection('documents').onSnapshot(snapshot => {
                    const docs = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.firestoreId = doc.id;
                        docs.push(d);
                    });
                    localStorage.setItem('up_sangh_docs', JSON.stringify(docs));
                    if (window.loadMemberDownloads) window.loadMemberDownloads();
                });
            }

            // --- PROFILE EDIT LOGIC --- //
            const editPreview = document.getElementById('editProfilePreview');
            const editNameIn = document.getElementById('editName');
            const editMobileIn = document.getElementById('editMobile');

            // New Display Fields
            const dispName = document.getElementById('dispName');
            const dispRole = document.getElementById('dispRole');
            const dispFname = document.getElementById('dispFname');
            const dispDob = document.getElementById('editDob');
            const dispDept = document.getElementById('dispDept');
            const dispWorkLoc = document.getElementById('dispWorkLoc');
            const dispHomeAddr = document.getElementById('dispHomeAddr');

            const fileInput = document.getElementById('profileUpload');

            // Pre-fill Profile Data (EDITABLE)
            if (editNameIn) editNameIn.value = member.name || '';
            if (editMobileIn) editMobileIn.value = member.mobile || '';
            setAvatar('editProfilePreview', member.photo, finalName);

            // Populate Read-Only Details
            if (dispName) dispName.innerText = member.name || 'Member Name';
            if (dispRole) dispRole.innerText = member.post || 'Member';

            if (dispFname) dispFname.value = member.father_name || member.fatherName || '';
            if (dispDob) {
                dispDob.value = member.dob || '';
            }
            if (dispDept) dispDept.value = member.department || 'N/A';
            if (document.getElementById('dispPost')) {
                document.getElementById('dispPost').value = member.post || 'N/A';
            }

            // Work Location
            const wDist = member.work_district || member.workDistrict || 'N/A';
            const wTehsil = member.work_tahsil || '';
            const wBlock = member.work_block || member.block || '';
            if (dispWorkLoc) {
                dispWorkLoc.value = `${wDist}${wTehsil ? ' - ' + wTehsil : ''}${wBlock ? ' - ' + wBlock : ''}`;
            }

            // Home Location
            const hDist = member.home_district || member.homeDistrict || 'N/A';
            const hTehsil = member.home_tahsil || '';
            const hBlock = member.home_block || '';
            const dispHomeLoc = document.getElementById('dispHomeLoc');
            if (dispHomeLoc) {
                dispHomeLoc.value = `${hDist}${hTehsil ? ' - ' + hTehsil : ''}${hBlock ? ' - ' + hBlock : ''}`;
            }

            // Home Address
            const hAddr = member.home_address || member.homeAddress || '';
            if (dispHomeAddr) {
                dispHomeAddr.value = hAddr;
            }

            // Signature
            const sigImg = document.getElementById('dispSignature');
            const sigPlac = document.getElementById('sigPlaceholder');
            if (sigImg && member.signature) {
                sigImg.src = member.signature;
                sigImg.style.display = 'block';
                if (sigPlac) sigPlac.style.display = 'none';
            }

            // Handle File Select
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 1024 * 1024) {
                            alert("File too large! Max 1MB.");
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            newPhotoBase64 = ev.target.result;
                            editPreview.src = newPhotoBase64;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Toggle Edit Mode
            window.toggleEditMode = function () {
                const editName = document.getElementById('editName');
                if (!editName) return;
                const isEditing = editName.disabled === false;
                const fields = ['editName', 'dispFname', 'editDob', 'dispDept', 'dispPost', 'dispHomeAddr', 'dispWorkLoc', 'dispHomeLoc'];

                fields.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.disabled = !el.disabled;
                        el.style.background = el.disabled ? '#f9f9f9' : '#fff';
                        el.style.borderColor = el.disabled ? '#eee' : '#3498db';
                    }
                });

                const photoBtn = document.getElementById('photoEditBtn');
                const sigBtn = document.getElementById('sigEditBtn');
                const saveBtn = document.getElementById('btnSaveProfile');
                const note = document.getElementById('editNote');
                const toggleBtn = document.getElementById('btnToggleEdit');

                if (photoBtn) photoBtn.style.display = isEditing ? 'none' : 'flex';
                if (sigBtn) sigBtn.style.display = isEditing ? 'none' : 'flex';
                if (saveBtn) saveBtn.style.display = isEditing ? 'none' : 'block';
                if (note) note.style.display = isEditing ? 'none' : 'block';
                if (toggleBtn) toggleBtn.innerHTML = isEditing ? '<i class="fa-solid fa-pen"></i> Edit Profile Fields' : '<i class="fa-solid fa-xmark"></i> Cancel Editing';
            };

            // Save Changes Function (Request Mode)
            window.saveProfileChanges = function () {
                console.log("Button clicked: saveProfileChanges triggered.");
                try {
                    const getVal = (id) => {
                        const el = document.getElementById(id);
                        if (!el) {
                            console.warn(`Element with ID '${id}' not found.`);
                            return "";
                        }
                        return el.value.trim();
                    };

                    console.log("Gathering field values...");
                    const changes = {
                        name: getVal('editName'),
                        father_name: getVal('dispFname'),
                        dob: getVal('editDob'),
                        department: getVal('dispDept'),
                        post: getVal('dispPost'),
                        home_address: getVal('dispHomeAddr'),
                        photo: (typeof newPhotoBase64 !== 'undefined' ? newPhotoBase64 : null) || (member ? member.photo : null),
                        signature: (typeof newSigBase64 !== 'undefined' ? newSigBase64 : null) || (member ? member.signature : null)
                    };

                    console.log("Captured changes:", changes);

                    if (!changes.name) {
                        alert("Name cannot be empty.");
                        console.error("Validation failed: Name is empty.");
                        return;
                    }

                    if (confirm("Profile updates require Block Panel Verification. Proceed?")) {
                        const mMobile = (member && member.mobile ? member.mobile : "").toString().trim();
                        if (!mMobile) {
                            alert("Error: Member mobile number missing or invalid.");
                            console.error("Submission failed: Member mobile missing.");
                            return;
                        }

                        console.log("Creating request object for mobile:", mMobile);
                        const requestData = {
                            reqId: 'REQ' + Date.now(),
                            type: 'Profile Update',
                            mobile: mMobile,
                            name: member.name || "Member",
                            block: (member.work_block || member.home_block || member.block || "").toString().trim(),
                            district: (member.work_district || member.workDistrict || member.home_district || member.homeDistrict || "").toString().trim(),
                            changes: changes,
                            timestamp: new Date().toLocaleDateString('hi-IN'),
                            status: 'Open'
                        };

                        console.log("Saving request to Firestore:", requestData);
                        window.db.collection('requests').add(requestData)
                            .then(() => {
                                alert("Profile Update Request Submitted! Please wait for Block Panel approval.");
                                console.log("Success! Reloading page...");
                                location.reload();
                            })
                            .catch(err => {
                                console.error("Firestore Error:", err);
                                alert("Submission failed! Error: " + err.message);
                            });

                    } else {
                        console.log("User cancelled the confirmation.");
                    }
                } catch (err) {
                    console.error("CRITICAL ERROR in saveProfileChanges:", err);
                    alert("Submission failed! Error: " + err.message);
                }
            };

            // Handle Signature Upload
            const sigIn = document.getElementById('sigUpload');
            if (sigIn) {
                sigIn.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 500 * 1024) { alert("Signature max 500KB."); return; }
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            newSigBase64 = ev.target.result;
                            const dSig = document.getElementById('dispSignature');
                            const sPlac = document.getElementById('sigPlaceholder');
                            if (dSig) {
                                dSig.src = newSigBase64;
                                dSig.style.display = 'block';
                            }
                            if (sPlac) sPlac.style.display = 'none';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // --- MEMBERSHIP & PAYMENT HISTORY LOGIC ---

            window.loadMembershipHistory = function () {
                const historyBody = document.getElementById('membershipHistoryBody');
                if (!historyBody) return;

                // Simulate/Derived History
                let history = [
                    { event: 'Initial Registration', date: member.date || 'N/A', status: 'Approved', validTill: '31 Dec 2025' }
                ];

                // Add past renewal requests that were approved
                const allRequests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
                const myRenewals = allRequests.filter(r => r.mobile === member.mobile && r.type === 'Membership Renewal' && r.status === 'Approved');

                myRenewals.forEach(r => {
                    history.push({
                        event: 'Membership Renewal',
                        date: r.timestamp || 'N/A',
                        status: 'Approved',
                        validTill: r.newExpiry || 'N/A'
                    });
                });

                historyBody.innerHTML = history.map(h => `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px 20px;"><strong>${h.event}</strong></td>
                        <td style="padding: 12px 20px;">${h.date}</td>
                        <td style="padding: 12px 20px;"><span style="color: green;"><i class="fa-solid fa-check-circle"></i> ${h.status}</span></td>
                        <td style="padding: 12px 20px;">${h.validTill}</td>
                    </tr>
                `).join('');

                // Check for Renewal Eligibility
                const renewalCard = document.getElementById('renewalStatusCard');
                const expiryEl = document.getElementById('memExpiryDate');
                const dashValidEl = document.getElementById('dashValid');

                const expiryDate = '31 Dec 2025'; // Default for now
                if (expiryEl) expiryEl.innerText = expiryDate;
                if (dashValidEl) dashValidEl.innerText = expiryDate;

                // Simple check: if year is 2025, show renewal button (simulated)
                if (renewalCard) {
                    renewalCard.style.display = 'flex';
                }
            };

            let activePaymentReqId = null;

            window.loadPaymentHistory = function () {
                const paymentBody = document.getElementById('paymentHistoryBody');
                if (!paymentBody) return;

                let payments = [];

                // 1. Initial Membership Fee
                const initialAmt = member.membership_amount || 299;
                const initialPlan = member.membership_plan || 'Yearly';

                if (member.fee_status === 'Paid') {
                    payments.push({
                        purpose: `Initial Membership Fee (${initialPlan})`,
                        amount: `₹${initialAmt}`,
                        date: member.payment_date ? new Date(member.payment_date).toLocaleDateString('hi-IN') : member.date,
                        status: 'Success',
                        action: '<button class="btn-sm" style="background:#eee; border:none; padding:4px 8px; border-radius:3px; cursor:pointer;"><i class="fa-solid fa-download"></i> Receipt</button>'
                    });
                } else {
                    payments.push({
                        purpose: `Initial Membership Fee (${initialPlan})`,
                        amount: `₹${initialAmt}`,
                        date: member.date || 'Registration Date',
                        status: 'Pending',
                        action: `<button onclick="initiatePayment('INIT', 'Initial Membership Fee')" class="btn-sm" style="background:#ff9f1c; color:white; border:none; padding:4px 10px; border-radius:3px; cursor:pointer; font-weight:bold;">Pay Now</button>`
                    });
                }

                // 2. Renewal Payments (from requests)
                const allRequests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
                const myRenewals = allRequests.filter(r => r.mobile === member.mobile && r.type === 'Membership Renewal');

                myRenewals.forEach(r => {
                    let statusHtml = '';
                    let actionHtml = '';

                    if (r.status === 'Approved') {
                        statusHtml = '<span style="color: green;"><i class="fa-solid fa-circle-check"></i> Success</span>';
                        actionHtml = '<button class="btn-sm" style="background:#eee; border:none; padding:4px 8px; border-radius:3px; cursor:pointer;"><i class="fa-solid fa-download"></i> Receipt</button>';
                    } else if (r.status === 'Rejected') {
                        statusHtml = '<span style="color: red;"><i class="fa-solid fa-circle-xmark"></i> Rejected</span>';
                        actionHtml = '--';
                    } else if (r.payment_status === 'Payment Sent') {
                        statusHtml = '<span style="color: orange;"><i class="fa-solid fa-clock"></i> Verifying</span>';
                        actionHtml = '<small>Awaiting Admin</small>';
                    } else {
                        statusHtml = '<span style="color: #666;"><i class="fa-solid fa-circle-dot"></i> Unpaid</span>';
                        actionHtml = `<button onclick="initiatePayment('${r.reqId}', 'Membership Renewal Fee')" class="btn-sm" style="background:#ff9f1c; color:white; border:none; padding:4px 10px; border-radius:3px; cursor:pointer; font-weight:bold;">Pay Now</button>`;
                    }

                    payments.push({
                        purpose: 'Membership Renewal Fee',
                        amount: `₹${r.amount || 99}`,
                        date: r.timestamp || 'N/A',
                        status: statusHtml,
                        action: actionHtml
                    });
                });

                paymentBody.innerHTML = payments.map(p => `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px 20px;"><strong>${p.purpose}</strong></td>
                        <td style="padding: 12px 20px;">${p.amount}</td>
                        <td style="padding: 12px 20px;">${p.date}</td>
                        <td style="padding: 12px 20px;">${p.status.includes('<span') ? p.status : `<span style="color: ${p.status === 'Success' ? 'green' : 'orange'};">${p.status}</span>`}</td>
                        <td style="padding: 12px 20px;">${p.action}</td>
                    </tr>
                `).join('');

                if (payments.length === 0) {
                    paymentBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">No payment records found.</td></tr>';
                }
            };

            window.initiatePayment = function (reqId, purpose) {
                activePaymentReqId = reqId;
                let amount = 299; // Default
                const allRequests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
                const req = allRequests.find(r => r.reqId === reqId);

                if (req && req.amount) {
                    amount = req.amount;
                } else if (reqId === 'INIT') {
                    amount = member.membership_amount || 299;
                }

                const purposeEl = document.getElementById('paymentPurpose');
                if (purposeEl) purposeEl.innerText = purpose;

                const amountEl = document.getElementById('dispPaymentAmount');
                if (amountEl) amountEl.innerHTML = `Amount to Pay: ₹${amount}`;

                // Update QR Code
                const qrImg = document.getElementById('paymentQR');
                if (qrImg) {
                    const upiUrl = `upi://pay?pa=9919796060@okbizaxis&pn=UP%20Outsourcing%20Sangh%20Sangh&am=${amount}&cu=INR`;
                    qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiUrl)}`;
                }

                document.getElementById('paymentModal').style.display = 'flex';
            };

            window.confirmPaymentSent = function () {
                if (!activePaymentReqId) return;

                try {
                    if (activePaymentReqId === 'INIT') {
                        // Handle Initial Fee update request
                        const requests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
                        const existingInit = requests.find(r => r.mobile === member.mobile && r.type === 'Initial Fee Payment');

                        if (existingInit && existingInit.firestoreId) {
                            window.db.collection('requests').doc(existingInit.firestoreId).update({
                                payment_status: 'Payment Sent',
                                amount: member.membership_amount || 299,
                                membership_plan: member.membership_plan || 'Yearly'
                            }).then(() => {
                                alert("Payment confirmation sent to Admin! (Cloud Update)");
                                document.getElementById('paymentModal').style.display = 'none';
                            });
                        } else {
                            // Create new if not found
                            window.db.collection('requests').add({
                                reqId: 'PAY' + Date.now(),
                                type: 'Initial Fee Payment',
                                mobile: member.mobile,
                                name: member.name,
                                amount: member.membership_amount || 299,
                                membership_plan: member.membership_plan || 'Yearly',
                                status: 'Open',
                                payment_status: 'Payment Sent',
                                timestamp: new Date().toLocaleDateString('hi-IN'),
                                district: member.workDistrict || member.homeDistrict || '',
                                block: member.work_block || member.home_block || ''
                            }).then(() => {
                                alert("Payment confirmation sent to Admin! (Cloud Create)");
                                document.getElementById('paymentModal').style.display = 'none';
                            });
                        }
                    } else {
                        // Update existing request
                        const requests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
                        const req = requests.find(r => r.reqId === activePaymentReqId);
                        if (req && req.firestoreId) {
                            window.db.collection('requests').doc(req.firestoreId).update({
                                payment_status: 'Payment Sent'
                            }).then(() => {
                                alert("Payment confirmation sent to Admin! (Cloud Update)");
                                document.getElementById('paymentModal').style.display = 'none';
                            });
                        } else {
                            alert("Request not found in cloud to update.");
                        }
                    }
                } catch (e) {
                    console.error("Payment Confirmation Error:", e);
                    alert("Verification failed to submit. Please try again.");
                }
            };

            window.initMembershipRenewal = function () {
                const allRequests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
                const pendingRenewal = allRequests.find(r => r.mobile === member.mobile && r.type === 'Membership Renewal' && r.status === 'Open');

                if (pendingRenewal) {
                    alert("A renewal request is already pending approval.");
                    return;
                }

                const plan = confirm("Do you want Lifetime Membership (₹699)? \nClick 'OK' for Lifetime, 'Cancel' for Yearly (₹99).") ? 'Lifetime' : 'Yearly';
                const amount = plan === 'Lifetime' ? 699 : 99;

                if (confirm(`Do you want to submit a ${plan} Membership Renewal Request for ₹${amount}?`)) {
                    const requestData = {
                        reqId: 'REN' + Date.now(),
                        type: 'Membership Renewal',
                        mobile: member.mobile,
                        name: member.name,
                        district: member.workDistrict || member.homeDistrict || '',
                        block: member.work_block || member.home_block || '',
                        timestamp: new Date().toLocaleDateString('hi-IN'),
                        status: 'Open',
                        amount: amount,
                        membership_plan: plan
                    };

                    window.db.collection('requests').add(requestData)
                        .then(() => {
                            alert(`${plan} Renewal request submitted successfully! Please contact your Block/District admin for payment and approval.`);
                            location.reload();
                        })
                        .catch(err => {
                            console.error("Renewal Error:", err);
                            alert("Failed to submit renewal request.");
                        });
                }
            };
            window.viewIDCard = function () {
                if (member.status !== 'Approved') {
                    alert("ID Card ke liye aapka registration Approve hona zaroori hai. Kirpaya admin approval ka intezaar karein.");
                    return;
                }

                const logo = localStorage.getItem('up_sangh_logo') || 'admin_logo.jpg';
                const unionName = localStorage.getItem('up_sangh_name') || 'उ.प्र. आउटसोर्सिंग एवं संविदा कर्मचारी संघ';

                // Verification data for QR
                const verificationData = {
                    id: member.id,
                    member_id: member.member_id || `ID-${member.id}`,
                    name: member.name,
                    mobile: member.mobile,
                    district: member.workDistrict || member.work_district,
                    verified: true,
                    union: 'UP Outsourcing & Contract Employees Union'
                };

                const qrData = encodeURIComponent(JSON.stringify(verificationData));
                const qrCodeUrl = `https://chart.googleapis.com/chart?cht=qr&chs=150x150&chl=${qrData}`;

                const formatDate = (dateStr) => {
                    if (!dateStr) return '--';
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return dateStr;
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                };
                const formattedDOB = formatDate(member.dob);

                const cardHtml = `
                    <div id="printableIDCard" style="width:420px; height:250px; border-radius:10px; border:2.5px solid #0056b3; background: linear-gradient(135deg, #fff 75%, #f0f7ff 100%); position:relative; overflow:hidden; font-family:'Inter', sans-serif; box-shadow: 0 6px 20px rgba(0,0,0,0.12); margin: 0 auto; padding:10px; box-sizing:border-box;">
                        <!-- Card Header -->
                        <div style="display:flex; align-items:center; gap:10px; border-bottom:2.5px solid #0056b3; padding-bottom:3px; margin-bottom:5px;">
                            <img src="${logo}" style="width:48px; height:48px; border-radius:50%; border:2.5px solid #0056b3; padding:2px; background:white; flex-shrink:0; margin-left:8px;">
                            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; text-align:center; padding-right:8px;">
                                <h5 style="margin:0; font-size:16.5px; color:#0056b3; font-weight:800; line-height:1.05; letter-spacing:-0.1px; white-space:nowrap;">${unionName}</h5>
                                <p style="margin:1px 0 0 0; font-size:9.5px; color:#c0392b; font-weight:700; text-transform:uppercase; line-height:1; letter-spacing:0.2px; white-space:nowrap;">U.P. OUTSOURCING & CONTRACT EMPLOYEES UNION</p>
                            </div>
                        </div>
                        
                        <!-- Card Body -->
                        <div style="display:flex; gap:12px;">
                            <!-- Left: Photo -->
                            <div style="text-align:center; width:100px; flex-shrink:0;">
                                ${member.photo ? `<img src="${member.photo}" style="width:98px; height:108px; border:2px solid #0056b3; border-radius:5px; object-fit:cover; box-shadow:0 2px 8px rgba(0,0,0,0.1);">` : `<div style="width:98px; height:108px; border:2px solid #ddd; border-radius:5px; background:#f9f9f9; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-user" style="font-size:40px; color:#ccc;"></i></div>`}
                                <div style="margin-top:4px; padding:3px 5px; background:linear-gradient(135deg, #0056b3, #003d82); color:white; font-size:10px; border-radius:4px; font-weight:bold; width:100%; box-sizing:border-box; box-shadow:0 2px 5px rgba(0,0,0,0.15);">${member.member_id || 'ID: ' + member.id.toString().slice(-4)}</div>
                                <div style="margin-top:4px; padding:2px 5px; background:${member.membership_plan === 'Lifetime' ? 'linear-gradient(135deg, #f1c40f, #f39c12)' : 'linear-gradient(135deg, #27ae60, #2ecc71)'}; color:white; font-size:9px; border-radius:4px; font-weight:800; width:100%; box-sizing:border-box; box-shadow:0 1px 3px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.3); text-transform:uppercase;">${member.membership_plan || 'Yearly'} Plan</div>
                            </div>
                            
                            <!-- Right: Details -->
                            <div style="flex:1; font-size:10px; line-height:1.35; color:#2c3e50;">
                                <div style="margin-bottom:3px; text-align:center; padding:2px 4px; background:linear-gradient(135deg, #e74c3c, #c0392b); color:white; font-size:8px; border-radius:3px; font-weight:800; letter-spacing:0.3px; box-shadow:0 1px 3px rgba(0,0,0,0.15);">Reg. No UP754/35R/001</div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">NAME:</strong> <span style="color:#000; font-weight:700; font-size:11px;">${member.name}</span></div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">FATHER'S:</strong> <span>${member.fatherName || member.father_name || '--'}</span></div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">DOB:</strong> <span>${formattedDOB}</span></div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">DEPARTMENT:</strong> <span>${member.department || '--'}</span></div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">POST:</strong> <span>${member.post || '--'}</span></div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">DISTRICT:</strong> <span style="color:#c0392b; font-weight:700;">${member.workDistrict || member.work_district || '--'}</span></div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">MOBILE:</strong> <span>${member.mobile}</span></div>
                                <div style="margin-top:2px; font-size:8.5px; line-height:1.3; max-height:30px; overflow:hidden; display:flex;"><strong style="min-width:88px; color:#0056b3; flex-shrink:0;">ADDRESS:</strong> <span style="color:#555; flex:1; word-wrap:break-word; overflow-wrap:break-word;">${member.home_address || member.address || '--'}</span></div>
                            </div>
                        </div>
                        
                        <!-- Footer: QR & Signature -->
                        <div style="position:absolute; bottom:8px; left:0; right:0; display:flex; justify-content:flex-end; align-items:flex-end; padding:0 18px;">
                            <div style="text-align:center;">
                                <img src="${qrCodeUrl}" style="width:48px; height:48px; display:block; margin:0 auto 3px; border:1px solid #ddd; border-radius:3px; padding:2px; background:white;">
                                <p style="margin:0 0 4px 0; font-size:6px; color:#666; font-weight:700; text-transform:uppercase; letter-spacing:0.2px;">Scan for Verification</p>
                                <img src="digital_seal.jpg" style="width:60px; height:60px; object-fit:contain; opacity:0.9;">
                                <div style="border-top:1.5px solid #333; width:105px; margin:0 auto;"></div>
                                <p style="margin:0; font-size:8px; font-weight:bold; color:#333; text-transform:uppercase; letter-spacing:0.2px;">प्रदेश अध्यक्ष</p>
                            </div>
                        </div>
                        <div style="position:absolute; bottom:0; left:0; width:100%; height:8px; background:linear-gradient(90deg, #0056b3, #003d82);"></div>
                    </div>
                `;
                document.getElementById('idCardPreviewContainer').innerHTML = cardHtml;
                document.getElementById('idCardPreviewContainer').style.transform = 'scale(1)';

                const mCard = document.getElementById('modalCardContent');
                if (mCard) mCard.innerHTML = cardHtml;
                const mModal = document.getElementById('viewIDCardModal');
                if (mModal) mModal.style.display = 'flex';
            };

            window.printIDCard = function () {
                if (member.status !== 'Approved') { alert("Registration approve nahi hai."); return; }
                const content = document.getElementById('printableIDCard');
                if (!content) { viewIDCard(); return; }

                const originalContents = document.body.innerHTML;
                document.body.innerHTML = `
                    <style>
                        body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
                    </style>
                    ${content.outerHTML}
                `;
                window.print();
                location.reload();
            };

            window.downloadIDCardPDF = function () {
                if (member.status !== 'Approved') { alert("Registration approve nahi hai."); return; }
                if (typeof window.jspdf === 'undefined') { alert("Libraries loading..."); return; }

                const card = document.getElementById('printableIDCard');
                if (!card) { viewIDCard(); setTimeout(downloadIDCardPDF, 500); return; }

                const { jsPDF } = window.jspdf;
                html2canvas(card, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('l', 'mm', [85, 54]);
                    pdf.addImage(imgData, 'PNG', 0, 0, 85, 54);
                    pdf.save(`ID_Card_${member.name}.pdf`);
                });
            };

            // --- APPLICATIONS LOGIC ---
            window.submitApplication = function (e) {
                e.preventDefault();
                const type = document.getElementById('appType').value;
                const subject = document.getElementById('appSubject').value;
                const details = document.getElementById('appDetails').value;
                const dept = document.getElementById('appDept').value;

                if (!subject || !details) {
                    alert("Please fill all required fields.");
                    return;
                }

                const applications = JSON.parse(localStorage.getItem('up_sangh_member_applications')) || [];
                const newApp = {
                    id: 'APP-' + Date.now(),
                    type: type,
                    subject: subject,
                    details: details,
                    dept: dept,
                    mobile: member.mobile,
                    name: member.name,
                    memberId: member.member_id || member.id,
                    status: 'Pending',
                    timestamp: new Date().toLocaleString('hi-IN'),
                    date: new Date().toLocaleDateString('hi-IN')
                };

                console.log("Saving application to Firestore:", newApp);
                window.db.collection('applications').add(newApp)
                    .then(() => {
                        alert("Application submitted successfully!");
                        document.getElementById('applicationForm').reset();
                        // Re-prefill read-only fields
                        document.getElementById('appFullName').value = member.name || '';
                        document.getElementById('appMemberId').value = member.member_id || member.id || '';
                    })
                    .catch(err => {
                        console.error("Firestore Error:", err);
                        alert("Application failed: " + err.message);
                    });
            };

            window.loadApplicationHistory = function () {
                const applications = JSON.parse(localStorage.getItem('up_sangh_member_applications')) || [];
                const myApps = applications.filter(app => app.mobile === member.mobile);
                const container = document.getElementById('applicationHistory');
                const latestStatusEl = document.getElementById('latestAppStatus');

                if (myApps.length === 0) {
                    container.innerHTML = '<div style="padding:20px; text-align:center; color:#888; background:white; border-radius:8px; border:1px solid #eee;">No applications found.</div>';
                    latestStatusEl.innerHTML = 'वर्तमान स्थिति: <span style="background: #eee; color: #888; padding: 2px 10px; border-radius: 4px; font-weight: bold;">कोई नहीं</span>';
                    return;
                }

                // Show latest at top
                const recent = [...myApps].reverse();

                // Update latest status badge
                const latest = recent[0];
                let statusColor = '#ffeaa7';
                let textColor = '#d35400';
                let statusTextHindi = 'लंबित'; // Pending

                if (latest.status === 'Approved') {
                    statusColor = '#d1fadf';
                    textColor = '#027a48';
                    statusTextHindi = 'स्वीकृत';
                } else if (latest.status === 'Rejected') {
                    statusColor = '#fee4e2';
                    textColor = '#b42318';
                    statusTextHindi = 'अस्वीकृत';
                }

                latestStatusEl.innerHTML = `वर्तमान स्थिति: <span style="background: ${statusColor}; color: ${textColor}; padding: 2px 10px; border-radius: 4px; font-weight: bold;">${statusTextHindi}</span>`;

                container.innerHTML = '';
                recent.forEach(app => {
                    let badgeCol = '#ffeaa7';
                    let textCol = '#d35400';
                    let hindiStatus = 'लंबित';

                    if (app.status === 'Approved') { badgeCol = '#d1fadf'; textCol = '#027a48'; hindiStatus = 'स्वीकृत'; }
                    if (app.status === 'Rejected') { badgeCol = '#fee4e2'; textCol = '#b42318'; hindiStatus = 'अस्वीकृत'; }

                    container.innerHTML += `
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid ${app.status === 'Approved' ? '#27ae60' : (app.status === 'Rejected' ? '#e74c3c' : '#f1c40f')};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <h4 style="margin: 0; color: #1a5f7a;">${app.subject}</h4>
                                    <small style="color: #888;">${app.type} • ${app.date}</small>
                                </div>
                                <span style="background: ${badgeCol}; color: ${textCol}; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">${hindiStatus}</span>
                            </div>
                            <p style="font-size: 0.9rem; color: #555; margin: 0; line-height: 1.5;">${app.details}</p>
                            ${app.admin_note ? `<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.85rem; color: #666; font-style: italic;"><i class="fa-solid fa-comment-dots"></i> Admin Note: ${app.admin_note}</div>` : ''}
                        </div>
                    `;
                });
            };

            // --- COMPLAINTS LOGIC ---
            window.submitComplaint = function (e) {
                e.preventDefault();
                const type = document.getElementById('compType').value;
                const subject = document.getElementById('compSubject').value;
                const details = document.getElementById('compDetails').value;
                const fileIn = document.getElementById('compFile');

                if (!type || !subject || !details) {
                    alert("कृपया सभी आवश्यक जानकारी भरें।");
                    return;
                }

                const processSubmission = (fileData = null) => {
                    const complaints = JSON.parse(localStorage.getItem('up_sangh_member_complaints')) || [];
                    const newComp = {
                        id: 'COMP-' + Date.now(),
                        type: type,
                        subject: subject,
                        details: details,
                        file: fileData,
                        mobile: member.mobile,
                        name: member.name,
                        memberId: member.member_id || member.id,
                        status: 'Pending',
                        timestamp: new Date().toLocaleString('hi-IN'),
                        date: new Date().toLocaleDateString('hi-IN')
                    };

                    console.log("Saving complaint to Firestore:", newComp);
                    window.db.collection('complaints').add(newComp)
                        .then(() => {
                            alert("आपकी शिकायत सफलतापूर्वक दर्ज कर ली गई है! (Cloud Synced)");
                            document.getElementById('complaintForm').reset();
                            // Re-prefill
                            document.getElementById('compName').value = member.name || '';
                            document.getElementById('compMemberId').value = member.member_id || member.id || '';
                        })
                        .catch(err => {
                            console.error("Firestore Error:", err);
                            alert("Complaint failed: " + err.message);
                        });
                };

                if (fileIn && fileIn.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (ev) => processSubmission(ev.target.result);
                    reader.readAsDataURL(fileIn.files[0]);
                } else {
                    processSubmission();
                }
            };

            window.loadComplaintHistory = function () {
                const complaints = JSON.parse(localStorage.getItem('up_sangh_member_complaints')) || [];
                const myComps = complaints.filter(c => c.mobile === member.mobile);
                const container = document.getElementById('complaintHistory');
                const latestStatusEl = document.getElementById('latestCompStatus');

                if (myComps.length === 0) {
                    container.innerHTML = '<div style="padding:20px; text-align:center; color:#888; background:white; border-radius:8px; border:1px solid #eee;">कोई शिकायत नहीं मिली।</div>';
                    latestStatusEl.innerHTML = 'वर्तमान स्थिति: <span style="background: #eee; color: #888; padding: 2px 10px; border-radius: 4px; font-weight: bold;">कोई नहीं</span>';
                    return;
                }

                const recent = [...myComps].reverse();
                const latest = recent[0];

                // Update Header Message Badge
                const msgBadge = document.getElementById('messageBtnBadge');
                if (msgBadge) {
                    msgBadge.innerText = myComps.length;
                    msgBadge.style.display = myComps.length > 0 ? 'flex' : 'none';
                }

                let statusColor = '#ffeaa7';
                let textColor = '#d35400';
                let statusTextHindi = 'लंबित';

                if (latest.status === 'Resolved') {
                    statusColor = '#d1fadf';
                    textColor = '#027a48';
                    statusTextHindi = 'समाधानित';
                } else if (latest.status === 'Rejected') {
                    statusColor = '#fee4e2';
                    textColor = '#b42318';
                    statusTextHindi = 'अस्वीकृत';
                }

                latestStatusEl.innerHTML = `वर्तमान स्थिति: <span style="background: ${statusColor}; color: ${textColor}; padding: 2px 10px; border-radius: 4px; font-weight: bold;">${statusTextHindi}</span>`;

                container.innerHTML = '';
                recent.forEach(comp => {
                    let badgeCol = '#ffeaa7';
                    let textCol = '#d35400';
                    let hindiStatus = 'लंबित';

                    if (comp.status === 'Resolved') { badgeCol = '#d1fadf'; textCol = '#027a48'; hindiStatus = 'समाधानित'; }
                    if (comp.status === 'Rejected') { badgeCol = '#fee4e2'; textCol = '#b42318'; hindiStatus = 'अस्वीकृत'; }

                    container.innerHTML += `
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 5px solid ${comp.status === 'Resolved' ? '#27ae60' : (comp.status === 'Rejected' ? '#e74c3c' : '#f1c40f')};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div>
                                    <h4 style="margin: 0; color: #1a5f7a; font-size: 1.1rem;">${comp.subject}</h4>
                                    <small style="color: #888;">${comp.type} • ${comp.date} • ID: ${comp.id}</small>
                                </div>
                                <span style="background: ${badgeCol}; color: ${textCol}; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">${hindiStatus}</span>
                            </div>
                            <p style="font-size: 0.95rem; color: #555; margin: 0; line-height: 1.6; background: #f8f9fa; padding: 10px; border-radius: 6px;">${comp.details}</p>
                            ${comp.admin_note ? `<div style="margin-top: 12px; padding: 12px; background: #eef2f7; border-radius: 6px; font-size: 0.85rem; color: #2c3e50; border-left: 3px solid #1a5f7a;"><i class="fa-solid fa-comment-dots"></i> <strong>एडमिन नोट:</strong> ${comp.admin_note}</div>` : ''}
                        </div>
                    `;
                });
            };

            // --- DONATION (SAHYOG) LOGIC ---
            window.submitDonation = function (e) {
                e.preventDefault();
                const amount = document.getElementById('donAmount').value;
                const date = document.getElementById('donDate').value;
                const txnId = document.getElementById('donTxnId').value;
                const note = document.getElementById('donNote').value;

                if (!amount || !date || !txnId) {
                    alert("कृपया सभी आवश्यक जानकारी (राशि, तारीख, ट्रांजैक्शन आईडी) भरें।");
                    return;
                }

                if (confirm(`क्या आप ₹${amount} के सहयोग की सूचना सबमिट करना चाहते हैं?`)) {
                    // 1. Save to Personal Donation History
                    const newDonation = {
                        id: 'DON-' + Date.now(),
                        amount: parseFloat(amount),
                        date: date,
                        txnId: txnId,
                        note: note,
                        mobile: member.mobile,
                        status: 'Pending',
                        timestamp: new Date().toLocaleString('hi-IN')
                    };

                    window.db.collection('donations').add(newDonation)
                        .then(() => {
                            // 2. Also create a request for Admin Approval
                            const reqData = {
                                reqId: 'REQ-DON-' + Date.now(),
                                type: 'Donation',
                                mobile: member.mobile,
                                name: member.name,
                                amount: parseFloat(amount),
                                txnId: txnId,
                                date: date,
                                note: note,
                                status: 'Open',
                                timestamp: new Date().toLocaleString('hi-IN'),
                                payment_status: 'Payment Sent' // It's a donation, so payment is already sent
                            };
                            return window.db.collection('requests').add(reqData);
                        })
                        .then(() => {
                            alert("सहयोग की सूचना सफलतापूर्वक सबमिट कर दी गई है। एडमिन सत्यापन के बाद यह आपके इतिहास में स्वीकृत दिखेगा। (Cloud Synced)");
                            document.getElementById('donationForm').reset();
                        })
                        .catch(err => {
                            console.error("Donation Error:", err);
                            alert("Error submitting donation: " + err.message);
                        });
                }
            };

            window.loadDonationHistory = function () {
                const donations = JSON.parse(localStorage.getItem('up_sangh_member_donations')) || [];
                const myDons = donations.filter(d => d.mobile === member.mobile);
                const tbody = document.getElementById('donationHistoryBody');

                if (!tbody) return;

                if (myDons.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; color: #999;">कोई रिकॉर्ड नहीं मिला। (No history found).</td></tr>';
                    return;
                }

                // Show latest first
                const recent = [...myDons].reverse();
                tbody.innerHTML = recent.map(d => {
                    let statusBadge = `<span style="background: #ffeaa7; color: #d35400; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;">लंबित (Pending)</span>`;
                    if (d.status === 'Approved') {
                        statusBadge = `<span style="background: #d1fadf; color: #027a48; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;">स्वीकृत (Approved)</span>`;
                    } else if (d.status === 'Rejected') {
                        statusBadge = `<span style="background: #fee4e2; color: #b42318; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;">अस्वीकृत (Rejected)</span>`;
                    }

                    return `
                        <tr>
                            <td style="padding: 12px 20px;">${d.date}</td>
                            <td style="padding: 12px 20px; font-weight: bold;">₹${d.amount}</td>
                            <td style="padding: 12px 20px;">${d.txnId}</td>
                            <td style="padding: 12px 20px;">${statusBadge}</td>
                        </tr>
                    `;
                }).join('');
            };


            // Check for Open Requests (Generic)
            if (typeof myOpenRequest !== 'undefined' && myOpenRequest) {
                const statusDiv = document.createElement('div');
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.border = '1px solid #ffeeba';
                statusDiv.style.color = '#856404';
                statusDiv.style.padding = '10px';
                statusDiv.style.borderRadius = '5px';
                statusDiv.style.marginBottom = '15px';
                statusDiv.style.fontSize = '0.9rem';
                statusDiv.innerHTML = `<i class="fa-solid fa-clock-rotate-left"></i> Your profile update request is <strong>Pending Approval</strong> from the Block Panel. You cannot make further edits until it is processed.`;
                const profSection = document.querySelector('.section-profile');
                if (profSection) profSection.prepend(statusDiv);

                // Disable Edit Button
                const btnEdit = document.getElementById('btnToggleEdit');
                if (btnEdit) {
                    btnEdit.disabled = true;
                    btnEdit.style.background = '#ccc';
                    btnEdit.innerHTML = '<i class="fa-solid fa-lock"></i> Request Pending';
                }
            }

            // --- NOTICES LOGIC ---
            window.loadMemberNotices = function () {
                const notices = JSON.parse(localStorage.getItem('up_sangh_notices')) || [];
                // Filter: target 'All' or 'Members' (or empty/null for legacy)
                const memberNotices = notices.filter(n => !n.target || n.target === 'All' || n.target === 'Members');
                const container = document.getElementById('noticesContainer');

                if (!container) return;

                if (memberNotices.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #888; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee;">
                            <i class="fa-solid fa-bell-slash" style="font-size: 3rem; color: #ddd; margin-bottom: 15px; display: block;"></i>
                            <h3 style="margin: 0; color: #555;">कोई वर्तमान सूचना नहीं है (No current notices)</h3>
                            <p style="margin: 10px 0 0; font-size: 0.9rem;">जब भी एडमिन कोई नई सूचना जारी करेंगे, वह यहाँ दिखाई देगी।</p>
                        </div>
                    `;
                    return;
                }

                // Show latest first
                const sorted = [...memberNotices].reverse();

                // Update Header Notification Badge
                const notifyBadge = document.getElementById('notificationBtnBadge');
                if (notifyBadge) {
                    notifyBadge.innerText = memberNotices.length;
                    notifyBadge.style.display = memberNotices.length > 0 ? 'flex' : 'none';
                }

                container.innerHTML = sorted.map(n => `
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-left: 6px solid #1a5f7a; transition: transform 0.2s;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <h3 style="margin: 0; color: #1a5f7a; font-size: 1.2rem; line-height: 1.4;">${n.title}</h3>
                            <span style="background: #eef2f7; color: #1a5f7a; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; white-space: nowrap;">
                                <i class="fa-solid fa-calendar-day"></i> ${n.date}
                            </span>
                        </div>
                        <div style="color: #444; font-size: 1rem; line-height: 1.6; white-space: pre-wrap;">${n.content}</div>
                        <div style="margin-top: 15px; padding-top: 12px; border-top: 1px solid #f0f0f0; display: flex; align-items: center; gap: 10px;">
                            <img src="logo.jpg" style="width: 24px; height: 24px; border-radius: 50%;" alt="Union">
                            <span style="font-size: 0.8rem; color: #888; font-weight: 500;">जारीकर्ता: मुख्य एडमिन (Published by: Central Admin)</span>
                        </div>
                    </div>
                `).join('');
            };

            // --- DOWNLOADS LOGIC ---
            window.loadMemberDownloads = function () {
                const docs = JSON.parse(localStorage.getItem('up_sangh_docs')) || [];
                const tbody = document.getElementById('memberDownloadsBody');
                if (!tbody) return;

                if (docs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 30px; color: #999;">कोई दस्तावेज़ उपलब्ध नहीं है (No documents available).</td></tr>';
                    return;
                }

                tbody.innerHTML = docs.reverse().map(d => `
                    <tr>
                        <td><strong style="color:#1a5f7a;">${d.title}</strong></td>
                        <td><span class="badge ${d.category === 'Govt Order' ? 'bg-primary' : (d.category === 'Union Circular' ? 'bg-info' : 'bg-secondary')}">${d.category}</span></td>
                        <td>${d.date}</td>
                        <td>
                            <button onclick="downloadMemberDocument(${d.id})" class="btn btn-sm btn-outline-primary">
                                <i class="fa-solid fa-download"></i> Download
                            </button>
                        </td>
                    </tr>
                `).join('');
            };

            window.downloadMemberDocument = function (id) {
                const docs = JSON.parse(localStorage.getItem('up_sangh_docs')) || [];
                const doc = docs.find(d => d.id === id);
                if (!doc) return;
                const a = document.createElement('a');
                a.href = doc.data;
                a.download = doc.title;
                a.click();
            };

            // Final List Initializations
            loadApplicationHistory();
            loadComplaintHistory();
            loadDonationHistory();
            loadMembershipHistory();
            loadPaymentHistory();
            loadMemberNotices();
            loadMemberDownloads();
        });
    </script>
    <!-- ID Card Modal -->
    <div id="viewIDCardModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1003; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:15px; border-radius:15px; width:95%; max-width:450px; position:relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <button onclick="document.getElementById('viewIDCardModal').style.display='none'"
                style="position:absolute; right:10px; top:10px; border:none; background:#eee; width:30px; height:30px; border-radius:50%; font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
            <div id="modalCardContent" style="margin-top:10px;">
                <!-- Card rendering -->
            </div>
            <div style="margin-top: 15px; text-align: center; display: flex; gap: 10px; justify-content: center;">
                <button onclick="printIDCard()" class="btn"
                    style="background:#007bff; color:white; font-size:0.8rem;"><i class="fa-solid fa-print"></i> Print
                </button>
                <button onclick="downloadIDCardPDF()" class="btn"
                    style="background:#28a745; color:white; font-size:0.8rem;"><i class="fa-solid fa-file-pdf"></i>
                    Download PDF</button>
            </div>
        </div>
    </div>
    <!-- Payment Modal -->
    <div id="paymentModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1004; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:25px; border-radius:15px; width:95%; max-width:400px; position:relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align:center;">
            <button onclick="document.getElementById('paymentModal').style.display='none'"
                style="position:absolute; right:10px; top:10px; border:none; background:#eee; width:30px; height:30px; border-radius:50%; font-size:1.2rem; cursor:pointer;">&times;</button>

            <h3 style="color: #1a5f7a; margin-bottom: 15px;"><i class="fa-solid fa-indian-rupee-sign"></i> Complete Your
                Payment</h3>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">Scan the QR code below using any UPI app
                (Google Pay, PhonePe, Paytm) to pay the fee.</p>

            <div id="paymentQRContainer"
                style="margin: 0 auto 20px; background: white; padding:15px; border: 1px solid #eee; border-radius:10px; width: fit-content;">
                <!-- QR will be generated here -->
                <img id="paymentQR"
                    src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi://pay?pa=9919796060@okbizaxis%26pn=UP%20Outsourcing%20Sangh%20Sangh%26am=99%26cu=INR"
                    style="width:200px; height:200px;" alt="UPI QR Code">
            </div>

            <div
                style="background: #fdf2f2; padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #fee2e2;">
                <p id="dispPaymentAmount" style="font-size: 0.85rem; color: #991b1b; font-weight: 600; margin: 0;">
                    Amount to Pay: ₹99</p>
                <p style="font-size: 0.75rem; color: #b91c1c; margin-top: 4px;">Purpose: <span
                        id="paymentPurpose">Membership Fee</span></p>
            </div>

            <button onclick="confirmPaymentSent()" class="btn"
                style="background:#28a745; color:white; width: 100%; padding: 12px; font-weight: bold; border-radius: 8px;">
                <i class="fa-solid fa-check-circle"></i> I Have Paid (Confirm)
            </button>

            <p style="font-size: 0.7rem; color: #999; margin-top: 15px;">After clicking "Confirm", admins will verify
                your payment and approve your request.</p>
        </div>
    </div>
</body>

</html>