<!DOCTYPE html>
<html lang="hi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - UP Outsourcing Sangh</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- QR, PDF & Canvas Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase_config.js"></script>
    <style>
        /* Global & Reset */
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
        }

        /* --- THEME VARIABLES (Default Blue) --- */
        :root {
            --sidebar-bg: #2b5494;
            --sidebar-header: #1e3c6e;
            --sidebar-link-active: #1e3c6e;
            --sidebar-link-hover: #1e3c6e;
            --highlight-color: #ffd700;
            --primary-btn: #2b5494;
        }

        /* District Admin Theme (Purple) */
        body.theme-district {
            --sidebar-bg: #6a0dad;
            --sidebar-header: #4b0082;
            --sidebar-link-active: #4b0082;
            --sidebar-link-hover: #4b0082;
            --highlight-color: #00ffcc;
            --primary-btn: #6a0dad;
        }

        /* Division Admin Theme (Teal/Green) */
        body.theme-division {
            --sidebar-bg: #008080;
            --sidebar-header: #004d4d;
            --sidebar-link-active: #004d4d;
            --sidebar-link-hover: #004d4d;
            --highlight-color: #ffe4b5;
            --primary-btn: #008080;
        }

        /* Layout */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar using Variables */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--sidebar-header);
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            padding: 2px;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
        }

        .sidebar-menu li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-left: 4px solid transparent;
            transition: all 0.2s;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .sidebar-menu li a:hover,
        .sidebar-menu li a.active {
            background: var(--sidebar-link-active);
            color: white;
            border-left-color: var(--highlight-color);
        }

        .sidebar-menu li a i {
            width: 25px;
            margin-right: 10px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* Top Header */
        .top-header {
            background: var(--sidebar-bg);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .notification-icon {
            position: relative;
            cursor: pointer;
            color: white;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            font-size: 0.7rem;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-profile-h {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .user-profile-h img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        /* Content Padding */
        .content-padding {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        /* Welcome Card */
        .welcome-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            margin-bottom: 25px;
        }

        .welcome-avatar {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid #eee;
        }

        .welcome-info h1 {
            margin: 0 0 5px 0;
            font-size: 1.6rem;
            color: #2c3e50;
        }

        .welcome-info p {
            margin: 0;
            color: #666;
            font-size: 0.95rem;
        }

        .welcome-details-right {
            margin-left: auto;
            text-align: right;
            border-left: 1px solid #eee;
            padding-left: 20px;
        }

        /* Status Strip */
        .status-strip {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            padding: 20px;
            border-radius: 8px;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .status-card.green {
            background: #4ca154;
        }

        .status-card.navy {
            background: #34495e;
        }

        .status-card.orange {
            background: #e67e22;
        }

        .status-card.blue {
            background: #3498db;
        }

        /* Specialized Stats Colors for Higher Admins */
        .theme-district .status-card.green {
            background: #8e44ad;
        }

        /* Purple Tone */
        .theme-division .status-card.green {
            background: #008080;
        }

        /* Teal Tone */

        .status-card h3 {
            font-size: 1.8rem;
            margin: 0;
            font-weight: 700;
        }

        .status-card p {
            margin: 5px 0 0 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* GRID: Recent Members & Pending Actions */
        .dashboard-split-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .content-box {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .box-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fcfcfc;
        }

        .box-header h3 {
            margin: 0;
            font-size: 1.05rem;
            color: #2c3e50;
            font-weight: 600;
        }

        /* Member List Item */
        .member-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .member-item:last-child {
            border-bottom: none;
        }

        .member-item img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }

        .member-info h4 {
            margin: 0;
            font-size: 0.95rem;
            color: #333;
        }

        .member-info p {
            margin: 2px 0 0;
            font-size: 0.8rem;
            color: #777;
        }

        /* Action List Item */
        .action-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            transition: background 0.2s;
        }

        .action-item:hover {
            background: #fbfbfb;
        }

        .action-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .action-icon {
            width: 35px;
            height: 35px;
            background: #eef2f7;
            color: var(--primary-btn);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .action-text h4 {
            margin: 0;
            font-size: 0.9rem;
        }

        .btn-view {
            padding: 5px 12px;
            background: var(--primary-btn);
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
            text-decoration: none;
        }

        /* Role Specific Show/Hide */
        .role-feature {
            display: none;
        }

        .show-district .role-feature.district-only {
            display: block;
        }

        .show-division .role-feature.division-only {
            display: block;
        }

        /* Data Reports Section at Bottom */
        .reports-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        /* Section Visibility Logic */
        .section-view {
            display: none;
        }

        .section-view.active {
            display: block;
        }

        @media (max-width: 900px) {
            .sidebar {
                display: none;
            }

            .dashboard-split-grid,
            .reports-grid {
                grid-template-columns: 1fr;
            }

            .welcome-card {
                flex-direction: column;
                text-align: center;
            }

            .welcome-details-right {
                border-left: none;
                border-top: 1px solid #eee;
                padding-left: 0;
                padding-top: 15px;
                margin-top: 10px;
                text-align: center;
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="logo.jpg" alt="Logo">
                <h2 id="panelTitle">Admin Panel</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a onclick="showSection('dashboard')" id="nav-dashboard" class="active"><i
                            class="fa-solid fa-house"></i> Dashboard</a></li>

                <!-- Expanded for Higher Admins -->
                <li class="role-feature division-only"><a onclick="showSection('districts')" id="nav-districts"><i
                            class="fa-solid fa-map"></i> My Districts</a></li>
                <li class="role-feature district-only"><a onclick="showSection('blocks')" id="nav-blocks"><i
                            class="fa-solid fa-cubes"></i> My Blocks</a></li>

                <li><a onclick="showSection('members')" id="nav-members"><i class="fa-solid fa-users"></i> Members</a>
                </li>

                <!-- Officer Management for Higher Admins -->
                <li class="role-feature district-only division-only"><a onclick="showSection('officers')"
                        id="nav-officers"><i class="fa-solid fa-user-tie"></i> Officers</a></li>

                <li><a onclick="showSection('complaints')" id="nav-complaints"><i class="fa-solid fa-bullhorn"></i>
                        Complaints</a></li>
                <li><a onclick="showSection('payments')" id="nav-payments"><i class="fa-solid fa-indian-rupee-sign"></i>
                        Payments</a></li>
                <li><a onclick="showSection('applications')" id="nav-applications"><i
                            class="fa-solid fa-clipboard-list"></i> Applications</a></li>
                <li><a onclick="showSection('notices')" id="nav-notices"><i class="fa-solid fa-bell"></i> Notices</a>
                </li>
                <li><a onclick="showSection('reports')" id="nav-reports"><i class="fa-solid fa-chart-line"></i>
                        Reports</a></li>
                <li><a onclick="showSection('idcard')" id="nav-idcard"><i class="fa-solid fa-id-badge"></i>
                        My ID Card</a></li>
                <li><a onclick="showSection('downloads')" id="nav-downloads"><i class="fa-solid fa-download"></i>
                        Downloads</a></li>
                <li><a onclick="showSection('support')" id="nav-support"><i class="fa-solid fa-headset"></i>
                        Support</a></li>
                <li style="margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1);"><a onclick="logoutOfficer()"
                        style="color: #ff8b8b;"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="header-title">
                    <img src="logo_white_sm.png" onerror="this.style.display='none'" style="height:25px;">
                    <span id="headerTitle">Board Panel</span>
                </div>
                <div class="user-menu">
                    <div class="notification-icon">
                        <i class="fa-solid fa-bell"></i>
                        <span class="notification-badge">5</span>
                    </div>
                    <div class="user-profile-h" onclick="showSection('dashboard')">
                        <img id="headerAvatar" src="member_def_photo.jpg" alt="User">
                        <i class="fa-solid fa-caret-down" style="font-size: 0.8rem; color: #fff;"></i>
                    </div>
                </div>
            </header>

            <div class="content-padding">

                <!-- 1. DASHBOARD OVERVIEW SECTION -->
                <div id="section-dashboard" class="section-view active">

                    <!-- Welcome Card -->
                    <div class="welcome-card">
                        <img id="dashAvatar" src="member_def_photo.jpg" alt="Profile" class="welcome-avatar">
                        <div class="welcome-info">
                            <h1 id="welcomeName">Welcome, Admin</h1>
                            <p id="welcomeRole">Role • Post</p>
                            <p id="welcomeLocation"
                                style="color: var(--primary-btn); font-weight: 500; margin-top: 5px;">Location</p>
                        </div>
                        <div class="welcome-details-right">
                            <span>Valid Till: <strong>31-12-2025</strong></span>
                        </div>
                    </div>

                    <!-- Stats Strip -->
                    <div class="status-strip">
                        <div class="status-card green">
                            <div class="icon"><i class="fa-solid fa-users"
                                    style="font-size: 2.5rem; opacity: 0.5; position: absolute; right: 20px;"></i></div>
                            <div>
                                <h3 id="statMembers">0</h3>
                                <p>Total Members</p>
                            </div>
                        </div>
                        <div class="status-card navy">
                            <div class="icon"><i class="fa-solid fa-comment-dots"
                                    style="font-size: 2.5rem; opacity: 0.5; position: absolute; right: 20px;"></i></div>
                            <div>
                                <h3 id="statComplaints">0</h3>
                                <p>Pending Complaints</p>
                            </div>
                        </div>
                        <div class="status-card orange">
                            <div class="icon"><i class="fa-solid fa-indian-rupee-sign"
                                    style="font-size: 2.5rem; opacity: 0.5; position: absolute; right: 20px;"></i></div>
                            <div>
                                <h3 id="statFees">₹ 0</h3>
                                <p>Fees Collection</p>
                            </div>
                        </div>
                        <div class="status-card blue">
                            <div class="icon"><i class="fa-solid fa-layer-group"
                                    style="font-size: 2.5rem; opacity: 0.5; position: absolute; right: 20px;"></i></div>
                            <div>
                                <h3 id="statExtra">--</h3>
                                <p id="labelExtra">Latest Notice</p>
                            </div>
                        </div>
                    </div>

                    <!-- Main Grid -->
                    <div class="dashboard-split-grid">

                        <!-- Recent Members -->
                        <div class="content-box">
                            <div class="box-header">
                                <h3 style="color: var(--primary-btn);"><i class="fa-solid fa-user-plus"></i> Recently
                                    Joined Members</h3>
                                <small style="color: var(--primary-btn); cursor: pointer;"
                                    onclick="showSection('members')">View All ></small>
                            </div>
                            <div id="recentMembersList">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Pending Requests / Expiring -->
                        <div class="content-box">
                            <div class="box-header">
                                <h3 style="color: var(--primary-btn);"><i class="fa-solid fa-clock-rotate-left"></i>
                                    Pending Requests</h3>
                                <small style="color: var(--primary-btn); cursor: pointer;">View All ></small>
                            </div>
                            <!-- Mock Items -->
                            <div class="action-item">
                                <div class="action-left">
                                    <div class="action-icon"><i class="fa-solid fa-id-card"></i></div>
                                    <div class="action-text">
                                        <h4>ID Card Correction</h4>
                                    </div>
                                </div>
                                <a href="#" class="btn-view">Details ></a>
                            </div>
                            <div class="action-item">
                                <div class="action-left">
                                    <div class="action-icon"><i class="fa-solid fa-pen-to-square"></i></div>
                                    <div class="action-text">
                                        <h4>Detail Correction</h4>
                                    </div>
                                </div>
                                <a href="#" class="btn-view">Details ></a>
                            </div>
                            <div class="action-item">
                                <div class="action-left">
                                    <div class="action-icon"><i class="fa-solid fa-calendar-xmark"></i></div>
                                    <div class="action-text">
                                        <h4>Membership Renewal</h4>
                                    </div>
                                </div>
                                <a href="#" class="btn-view">Details ></a>
                            </div>
                        </div>

                    </div>

                    <!-- Reports Section -->
                    <div class="reports-grid">
                        <div class="content-box">
                            <div class="box-header" style="background: var(--sidebar-bg); color: white;">
                                <h3 style="color: white;"><i class="fa-solid fa-folder"></i> Data Reports</h3>
                            </div>
                            <div class="action-item">
                                <div class="action-left">
                                    <div class="action-icon"><i class="fa-solid fa-file-csv"></i></div>
                                    <div class="action-text">
                                        <h4>Membership Report</h4>
                                    </div>
                                </div>
                                <i class="fa-solid fa-chevron-right" style="color: grey;"></i>
                            </div>
                            <div class="action-item">
                                <div class="action-left">
                                    <div class="action-icon"><i class="fa-solid fa-file-invoice"></i></div>
                                    <div class="action-text">
                                        <h4>Payment Report</h4>
                                    </div>
                                </div>
                                <i class="fa-solid fa-chevron-right" style="color: grey;"></i>
                            </div>
                        </div>

                        <div class="content-box">
                            <div class="box-header" style="background: var(--sidebar-bg); color: white;">
                                <h3 style="color: white;"><i class="fa-solid fa-bullhorn"></i> Notices</h3>
                            </div>
                            <div style="padding: 20px; color: #666; text-align: center;">
                                No new notices sent from State Admin.
                            </div>
                        </div>
                    </div>

                </div>

                <!-- 2. MEMBERS VIEW (Simplified) -->
                <div id="section-members" class="section-view">
                    <div class="welcome-card">
                        <h2 style="margin:0;">Members List</h2>
                    </div>
                    <div class="content-box" style="padding: 0;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #fcfcfc; border-bottom: 2px solid #eee;">
                                <tr>
                                    <th style="padding: 15px; text-align: left;">Name</th>
                                    <th style="padding: 15px; text-align: left;">Mobile</th>
                                    <th style="padding: 15px; text-align: left;">Status</th>
                                    <th style="padding: 15px; text-align: left;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="fullMembersTable">
                                <!-- JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- NEW: BLOCKS VIEW (For District Admin) -->
                <div id="section-blocks" class="section-view">
                    <div class="welcome-card">
                        <h2 style="margin:0;">My Blocks</h2>
                    </div>
                    <div class="content-box" style="padding:30px; text-align:center; color:#666;">
                        <i class="fa-solid fa-cubes" style="font-size:3rem; margin-bottom:10px;"></i>
                        <p>Detailed list of Blocks in this District will be shown here.</p>
                    </div>
                </div>

                <!-- NEW: DISTRICTS VIEW (For Division Admin) -->
                <div id="section-districts" class="section-view">
                    <div class="welcome-card">
                        <h2 style="margin:0;">My Districts</h2>
                    </div>
                    <div class="content-box" style="padding:30px; text-align:center; color:#666;">
                        <i class="fa-solid fa-map" style="font-size:3rem; margin-bottom:10px;"></i>
                        <p>Detailed list of Districts in this Division will be shown here.</p>
                    </div>
                </div>

                <!-- NEW: OFFICERS VIEW (For Higher Admins) -->
                <div id="section-officers" class="section-view">
                    <div class="welcome-card">
                        <h2 style="margin:0;">Manage Officers</h2>
                    </div>
                    <div class="content-box" style="padding:30px; text-align:center; color:#666;">
                        <i class="fa-solid fa-user-tie" style="font-size:3rem; margin-bottom:10px;"></i>
                        <p>List of subordinate officers will be shown here.</p>
                    </div>
                </div>

                <!-- 3. COMPLAINTS VIEW -->
                <div id="section-complaints" class="section-view">
                    <div class="welcome-card">
                        <h2 style="margin:0;">Pending Complaints</h2>
                    </div>
                    <div class="content-box" style="padding: 0;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #fcfcfc; border-bottom: 2px solid #eee;">
                                <tr>
                                    <th style="padding: 15px; text-align: left;">Subject</th>
                                    <th style="padding: 15px; text-align: left;">Member</th>
                                    <th style="padding: 15px; text-align: left;">Date</th>
                                </tr>
                            </thead>
                            <tbody id="fullComplaintsTable">
                                <!-- JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- PLACEHOLDER VIEWS -->
                <div id="section-payments" class="section-view">
                    <div class="welcome-card">
                        <h2>Fees & Payments (Member Data)</h2>
                    </div>
                    <div class="content-box">
                        <div class="table-responsive">
                            <table style="width:100%; border-collapse:collapse;">
                                <thead>
                                    <tr style="background:#f8f9fa; border-bottom:2px solid #eee;">
                                        <th style="padding:12px; text-align:left;">Member</th>
                                        <th style="padding:12px; text-align:left;">Amount</th>
                                        <th style="padding:12px; text-align:left;">Status</th>
                                        <th style="padding:12px; text-align:left;">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="section-applications" class="section-view">
                    <div class="welcome-card">
                        <h2>Applications & Updates</h2>
                    </div>
                    <div id="applicationsContainer"></div>
                </div>
                <div id="section-notices" class="section-view">
                    <div class="welcome-card">
                        <h2>Official Notices (From State Admin)</h2>
                    </div>
                    <div id="noticesContainer" style="display:grid; gap:15px;"></div>
                </div>
                <div id="section-reports" class="section-view">
                    <div class="welcome-card">
                        <h2>Area Statistics & Reports</h2>
                    </div>
                    <div class="dashboard-split-grid">
                        <div class="content-box">
                            <h3>Area Summary</h3>
                            <div id="areaSummaryReport"></div>
                        </div>
                        <div class="content-box">
                            <h3>Revenue Analysis</h3>
                            <div id="revenueAnalysisReport"></div>
                        </div>
                    </div>
                </div>
                <div id="section-downloads" class="section-view">
                    <div class="welcome-card">
                        <h2>Download Documents</h2>
                    </div>
                    <div id="downloadsContainer" class="content-box"></div>
                </div>
                <div id="section-support" class="section-view">
                    <div class="welcome-card">
                        <h2>Support & Assistance</h2>
                    </div>
                    <div class="content-box">
                        <p>If you encounter any issues with the dashboard or member data, please contact the State IT
                            Cell.</p>
                        <p><strong>Email:</strong> support@upsanghsangh.org</p>
                        <p><strong>Helpline:</strong> +91 9919796060</p>
                    </div>
                </div>

                <!-- NEW: ID CARD SECTION -->
                <div id="section-idcard" class="section-view">
                    <div class="welcome-card">
                        <h2 style="margin:0;"><i class="fa-solid fa-id-card"></i> My Official ID Card</h2>
                    </div>

                    <div class="content-box" style="padding:40px; text-align:center; background: #f8f9fa;">
                        <p style="margin-bottom:20px; color:#666;">Preview and download your official Officer Identity
                            Card.</p>

                        <div id="idCardPreviewContainer"
                            style="margin: 0 auto 30px; display:inline-block; transform: scale(0.9);">
                            <!-- Card rendered by JS -->
                            <div
                                style="width:420px; height:250px; border: 2px dashed #ccc; border-radius:10px; display:flex; align-items:center; justify-content:center; background:white;">
                                <div style="text-align:center; color:#999;">
                                    <i class="fa-solid fa-id-badge" style="font-size:3rem; margin-bottom:10px;"></i>
                                    <p>Click "Generate Card" to Load</p>
                                </div>
                            </div>
                        </div>

                        <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                            <button onclick="viewIDCard()" class="btn"
                                style="background:var(--primary-btn); color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">
                                <i class="fa-solid fa-sync" style="margin-right:5px;"></i> Generate/Refresh
                            </button>
                            <button onclick="printIDCard()" class="btn"
                                style="background:#17a2b8; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">
                                <i class="fa-solid fa-print" style="margin-right:5px;"></i> Print
                            </button>
                            <button onclick="downloadIDCardPDF()" class="btn"
                                style="background:#28a745; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">
                                <i class="fa-solid fa-file-pdf" style="margin-right:5px;"></i> Download PDF
                            </button>
                        </div>
                    </div>
                </div>

            </div>
            <!-- End Padding -->
        </main>
    </div>

    <!-- ID Card Modal -->
    <div id="viewIDCardModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1003; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:15px; border-radius:15px; width:95%; max-width:450px; position:relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <button onclick="document.getElementById('viewIDCardModal').style.display='none'"
                style="position:absolute; right:10px; top:10px; border:none; background:#eee; width:30px; height:30px; border-radius:50%; font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
            <div id="modalCardContent" style="margin-top:10px; display:flex; justify-content:center;">
                <!-- Card rendering -->
            </div>
            <div style="margin-top: 15px; text-align: center; display: flex; gap: 10px; justify-content: center;">
                <button onclick="printIDCard()" class="btn"
                    style="background:#007bff; color:white; font-size:0.8rem; padding:8px 15px; border-radius:4px; border:none; cursor:pointer;"><i
                        class="fa-solid fa-print"></i> Print</button>
                <button onclick="downloadIDCardPDF()" class="btn"
                    style="background:#28a745; color:white; font-size:0.8rem; padding:8px 15px; border-radius:4px; border:none; cursor:pointer;"><i
                        class="fa-solid fa-file-pdf"></i> Download PDF</button>
            </div>
        </div>
    </div>

    <script src="script.js?v=7"></script>
    <script>
        // --- NAVIGATION LOGIC ---
        window.showSection = function (id) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));

            const target = document.getElementById('section-' + id);
            if (target) target.classList.add('active');

            const nav = document.getElementById('nav-' + id);
            if (nav) nav.classList.add('active');

            // Load Data for section if function exists
            if (typeof loadSectionData === 'function') {
                loadSectionData(id);
            }

            // Persist for refresh
            localStorage.setItem('up_sangh_active_section_officer', id);
        }

        window.logoutOfficer = function () {
            if (confirm('Logout?')) {
                localStorage.removeItem('up_sangh_officer_token');
                localStorage.removeItem('up_sangh_current_officer_session');
                localStorage.removeItem('up_sangh_active_section_officer');
                window.location.replace('login.html');
            }
        }

        // --- 4. DATA LOADING LOGIC ---
        window.loadSectionData = function (sectionId) {
            const members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
            const requests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
            const officer = JSON.parse(localStorage.getItem('up_sangh_current_officer_session'));
            if (!officer) return;

            const myDist = officer.district;
            const myBlock = officer.block;

            // Filter data based on officer's location
            const myMembers = members.filter(m => {
                if (officer.role === 'District Admin') return (m.work_district || m.workDistrict) === myDist;
                if (officer.role === 'Block Admin') return (m.work_block || m.block) === myBlock;
                if (officer.role === 'Division Admin') return (m.work_division || m.division) === officer.division;
                return true;
            });

            if (sectionId === 'payments') displayPayments(myMembers);
            if (sectionId === 'applications') displayApplications(requests, myDist, myBlock, officer.role);
            if (sectionId === 'notices') displayNotices();
            if (sectionId === 'reports') displayReports(myMembers);
            if (sectionId === 'downloads') displayDownloads();
        };

        function displayPayments(myMembers) {
            const tbody = document.getElementById('paymentsTableBody');
            if (!tbody) return;
            const payments = myMembers.filter(m => m.fee_status === 'Paid');
            tbody.innerHTML = payments.map(m => `
                <tr style="border-bottom:1px solid #eee; font-size: 0.9rem;">
                    <td style="padding:12px;"><strong>${m.name}</strong><br><small>${m.mobile}</small></td>
                    <td style="padding:12px;">₹${m.membership_amount || 299}</td>
                    <td style="padding:12px;"><span style="color:green; font-weight:bold;">Success</span></td>
                    <td style="padding:12px;">${m.payment_date ? new Date(m.payment_date).toLocaleDateString() : '--'}</td>
                </tr>
            `).join('') || '<tr><td colspan="4" style="padding:20px; text-align:center; color:#999;">No payments found in your area.</td></tr>';
        }

        function displayApplications(allRequests, myDist, myBlock, role) {
            const container = document.getElementById('applicationsContainer');
            if (!container) return;
            const myRequests = allRequests.filter(r => {
                if (r.status !== 'Open') return false;
                if (role === 'District Admin') return r.district === myDist;
                if (role === 'Block Admin') return r.block === myBlock;
                return true;
            });

            container.innerHTML = myRequests.map(req => `
                <div class="action-item">
                    <div class="action-left">
                        <div class="action-icon"><i class="fa-solid fa-file-signature"></i></div>
                        <div class="action-text">
                            <h4>${req.type}</h4>
                            <p>${req.name} • ${req.mobile}</p>
                        </div>
                    </div>
                    <button onclick="processRequest('${req.reqId}')" class="btn-view">Process ></button>
                </div>
            `).join('') || '<div style="padding:20px; text-align:center; color:#999;">No pending applications in your area.</div>';
        }

        function displayNotices() {
            const container = document.getElementById('noticesContainer');
            if (!container) return;
            const notices = JSON.parse(localStorage.getItem('up_sangh_notices')) || [];
            container.innerHTML = notices.reverse().map(n => `
                <div class="content-box">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                        <h3 style="margin:0; color:var(--primary-btn);">${n.title}</h3>
                        <span style="font-size:0.8rem; color:#888;">${n.date}</span>
                    </div>
                    <p style="margin:0; font-size:0.9rem; line-height:1.4;">${n.content}</p>
                </div>
            `).join('') || '<div style="padding:20px; text-align:center; color:#999;">No official notices at this time.</div>';
        }

        function displayReports(myMembers) {
            const summary = document.getElementById('areaSummaryReport');
            const revenue = document.getElementById('revenueAnalysisReport');
            if (!summary || !revenue) return;

            const approved = myMembers.filter(m => m.status === 'Approved').length;
            const pending = myMembers.filter(m => m.status === 'Pending').length;
            const totalFees = myMembers.reduce((sum, m) => sum + (m.membership_amount || 0), 0);

            summary.innerHTML = `
                <div style="padding:10px; line-height:1.8;">
                    <div>Total Members: <strong>${myMembers.length}</strong></div>
                    <div>Approved: <strong style="color:green;">${approved}</strong></div>
                    <div>Pending: <strong style="color:orange;">${pending}</strong></div>
                </div>
            `;
            revenue.innerHTML = `
                <div style="padding:10px; line-height:1.8;">
                    <div>Total Revenue: <strong style="color:#2c3e50;">₹${totalFees.toLocaleString()}</strong></div>
                    <div>Avg per Member: <strong>₹${myMembers.length ? Math.round(totalFees / myMembers.length) : 0}</strong></div>
                </div>
            `;
        }

        function displayDownloads() {
            const container = document.getElementById('downloadsContainer');
            if (!container) return;
            const docs = JSON.parse(localStorage.getItem('up_sangh_docs')) || [];
            container.innerHTML = docs.map(d => `
                <div class="action-item">
                    <div class="action-left">
                        <div class="action-icon"><i class="fa-solid fa-file-pdf"></i></div>
                        <div class="action-text">
                            <h4>${d.title}</h4>
                            <p>${d.category} • ${d.date}</p>
                        </div>
                    </div>
                    <button onclick="downloadDocument(${d.id})" class="btn-view"><i class="fa-solid fa-download"></i> Download</button>
                </div>
            `).join('') || '<div style="padding:20px; text-align:center; color:#999;">No documents available for download.</div>';
        }

        window.downloadDocument = function (id) {
            const docs = JSON.parse(localStorage.getItem('up_sangh_docs')) || [];
            const doc = docs.find(d => d.id === id);
            if (!doc) return;
            const a = document.createElement('a');
            a.href = doc.data;
            a.download = doc.title;
            a.click();
        };

        // --- DATA LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            // Auth Check
            const token = localStorage.getItem('up_sangh_officer_token');
            const officerData = localStorage.getItem('up_sangh_current_officer_session');

            if (!token || !officerData) {
                window.location.replace('login.html');
                return;
            }

            const officer = JSON.parse(officerData);
            const role = officer.role;
            const myBlock = officer.block;
            const myDist = officer.district;
            const myDiv = officer.division;

            // --- REAL-TIME LISTENERS (Added for Sync) ---
            if (window.db) {
                // Members
                window.db.collection("members").onSnapshot(snapshot => {
                    const members = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.firestoreId = doc.id;
                        members.push(d);
                    });
                    localStorage.setItem("up_sangh_members", JSON.stringify(members));
                    // Reload current section if needed
                    const activeSec = localStorage.getItem('up_sangh_active_section_officer') || 'dashboard';
                    showSection(activeSec);
                });

                // Requests
                window.db.collection("requests").onSnapshot(snapshot => {
                    const reqs = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.firestoreId = doc.id;
                        reqs.push(d);
                    });
                    localStorage.setItem("up_sangh_requests", JSON.stringify(reqs));
                    if (document.getElementById('section-applications').classList.contains('active')) showSection('applications');
                });

                // Notices
                window.db.collection("notices").onSnapshot(snapshot => {
                    const notices = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.firestoreId = doc.id;
                        notices.push(d);
                    });
                    localStorage.setItem("up_sangh_notices", JSON.stringify(notices));
                    if (document.getElementById('section-notices').classList.contains('active')) showSection('notices');
                });

                // Documents (for Downloads)
                window.db.collection("documents").onSnapshot(snapshot => {
                    const docs = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.firestoreId = doc.id;
                        docs.push(d);
                    });
                    localStorage.setItem("up_sangh_docs", JSON.stringify(docs));
                    if (document.getElementById('section-downloads').classList.contains('active')) showSection('downloads');
                });
            }

            // --- 1. APPLY THEME & CLASSES ---
            if (role === 'District Admin') {
                document.body.classList.add('theme-district');
                document.body.classList.add('show-district');
            } else if (role === 'Division Admin') {
                document.body.classList.add('theme-division');
                document.body.classList.add('show-division');
            } else {
                // Block Admin (Default Blue)
                // No extra classes needed for now if we default to block
            }

            // --- 2. Set Labels & UI Text ---
            document.getElementById('headerTitle').innerText = `${role} Panel`;
            document.getElementById('panelTitle').innerText = (role === 'Block Admin') ? 'Block Board' : ((role === 'District Admin') ? 'District Board' : ((role === 'Division Admin') ? 'Division Board' : 'State Board'));

            document.getElementById('welcomeName').innerText = `Welcome, ${officer.name}`;
            document.getElementById('welcomeRole').innerText = `${role}`;

            // Set Location
            let locText = "";
            if (role === 'Block Admin') locText = `${myBlock}, ${myDist}`;
            else if (role === 'District Admin') locText = `${myDist}, UP`;
            else if (role === 'Division Admin') locText = `${myDiv} Division, UP`;
            document.getElementById('welcomeLocation').innerText = locText;

            // Avatars
            document.getElementById('headerAvatar').src = officer.photo || 'member_def_photo.jpg';
            document.getElementById('dashAvatar').src = officer.photo || 'member_def_photo.jpg';

            // Restore Section
            const lastSection = localStorage.getItem('up_sangh_active_section_officer') || 'dashboard';
            showSection(lastSection);

            // --- 3. Filter Members ---
            const allMembers = JSON.parse(localStorage.getItem('up_sangh_members')) || [];

            const myMembers = allMembers.filter(m => {
                const mWorkDist = (m.work_district || m.workDistrict || "").trim();
                const mBlock = (m.block || m.work_block || "").trim();

                if (role === 'Block Admin') return checkMatch(mBlock, myBlock) && checkMatch(mWorkDist, myDist);
                if (role === 'District Admin') return checkMatch(mWorkDist, myDist);
                // For Division (Approximate check if no division field in member, checking district match list would be better but simplified here)
                // Assuming we can't easily filter by division on members yet without a map, so we might show all or mock. 
                // Let's assume Division Admin handles multiple districts.
                if (role === 'Division Admin') return (m.division === myDiv) || true; // Fallback to all for demo if division not set
                return false;
            });

            // --- 4. Update Stats ---
            document.getElementById('statMembers').innerText = myMembers.length;
            const fees = myMembers.length * 99;
            document.getElementById('statFees').innerText = "₹ " + fees.toLocaleString();

            // Extra Card Logic (4th Card)
            const extraCountEl = document.getElementById('statExtra');
            const extraLabelEl = document.getElementById('labelExtra');

            if (role === 'District Admin') {
                // Show Block Count
                const uniqueBlocks = new Set(myMembers.map(m => m.block || m.work_block).filter(b => b));
                extraCountEl.innerText = uniqueBlocks.size;
                extraLabelEl.innerText = "Total Blocks";
            } else if (role === 'Division Admin') {
                // Show District Count
                extraCountEl.innerText = "5"; // Mock
                extraLabelEl.innerText = "Total Districts";
            } else {
                // Block Admin: Show Notice or something
                extraCountEl.innerText = "New";
                extraLabelEl.innerText = "Latest Notices";
            }

            // --- 5. Complaints ---
            const allIssues = JSON.parse(localStorage.getItem('up_sangh_issues')) || [];
            document.getElementById('statComplaints').innerText = allIssues.length; // Placeholder

            // --- 6. Recent List ---
            const listContainer = document.getElementById('recentMembersList');
            const recent = myMembers.slice(-4).reverse();

            if (recent.length === 0) {
                listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">No members found in your area.</div>';
            } else {
                listContainer.innerHTML = ''; // Clear items
                recent.forEach(m => {
                    listContainer.innerHTML += `
                        <div class="member-item">
                            <img src="${m.photo || 'member_def_photo.jpg'}" alt="User">
                            <div class="member-info">
                                <h4>${m.name}</h4>
                                <p>${m.member_id || m.mobile} • ${m.date || 'N/A'}</p>
                            </div>
                        </div>
                    `;
                });
            }

            // --- 7. Full Tables ---
            const memTbody = document.getElementById('fullMembersTable');
            memTbody.innerHTML = '';
            myMembers.forEach(m => {
                const isPending = m.status !== 'Approved' && m.status !== 'Rejected';
                const actionBtns = isPending ? `
                    <button onclick="verifyMemberDirect(${m.id})" style="background:none; border:none; cursor:pointer; color:green; margin-right:5px;" title="Approve"><i class="fa-solid fa-circle-check" style="font-size:1.2rem;"></i></button>
                    <button onclick="rejectMemberDirect(${m.id})" style="background:none; border:none; cursor:pointer; color:red; margin-right:5px;" title="Reject"><i class="fa-solid fa-circle-xmark" style="font-size:1.2rem;"></i></button>
                ` : '';

                memTbody.innerHTML += `<tr>
                    <td style="padding:15px; border-bottom:1px solid #eee;">${m.name}</td>
                    <td style="padding:15px; border-bottom:1px solid #eee;">${m.mobile}</td>
                    <td style="padding:15px; border-bottom:1px solid #eee; color:${m.status === 'Approved' ? 'green' : (m.status === 'Rejected' ? 'red' : 'orange')}">${m.status || 'Pending'}</td>
                    <td style="padding:15px; border-bottom:1px solid #eee;">
                        ${actionBtns}
                        <button onclick="viewMember(${m.id})" class="btn-view" style="border:none; cursor:pointer; padding:5px 10px;">View</button>
                    </td>
                </tr>`;
            });

            const issTbody = document.getElementById('fullComplaintsTable');
            issTbody.innerHTML = '';
            allIssues.forEach(i => {
                issTbody.innerHTML += `<tr>
                    <td style="padding:15px; border-bottom:1px solid #eee;">${i.subject}</td>
                    <td style="padding:15px; border-bottom:1px solid #eee;">${i.name}</td>
                    <td style="padding:15px; border-bottom:1px solid #eee;">${i.date}</td>
                </tr>`;
            });

            // Normalize for bilingual strings
            function checkMatch(val, target) {
                if (!target) return false;
                const v = (val || "").toString().trim().toLowerCase();
                const t = (target || "").toString().trim().toLowerCase();
                return v.includes(t) || t.includes(v);
            }

            // --- 8. LOAD PENDING REQUESTS (REAL DATA) ---
            const allRequests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
            // Filter by Admin Area
            const myRequests = allRequests.filter(req => {
                if (req.status !== 'Open') return false;
                const rDist = req.district || "";
                const rBlock = req.block || "";

                console.log(`Checking Req ${req.reqId}: Role=${role}, MyDist=${myDist}, MyBlock=${myBlock}, ReqDist=${rDist}, ReqBlock=${rBlock}`);

                if (role === 'Block Admin') {
                    const match = checkMatch(rDist, myDist) && checkMatch(rBlock, myBlock);
                    console.log(`Block Admin Match Result: ${match}`);
                    return match;
                }
                if (role === 'District Admin') {
                    const match = checkMatch(rDist, myDist);
                    console.log(`District Admin Match Result: ${match}`);
                    return match;
                }
                if (role === 'Division Admin') {
                    return true;
                }
                return false;
            });

            const reqContainer = document.querySelector('.content-box:nth-child(2) .action-item');
            // The above selector is tricky because I have mock items there. 
            // I should target the parent container and Clear it first.

            // Find the container: It's the one with "Pending Requests" header.
            const boxes = document.querySelectorAll('.content-box');
            let reqBox = null;
            boxes.forEach(box => {
                if (box.innerText.includes('Pending Requests')) reqBox = box;
            });

            if (reqBox) {
                // Keep Header, Clear Mock Items
                const header = reqBox.querySelector('.box-header');
                reqBox.innerHTML = '';
                reqBox.appendChild(header);

                if (myRequests.length === 0) {
                    reqBox.innerHTML += `
                        <div style="padding:20px; color:#999; text-align:center;">
                            No pending requests.
                            <div style="margin-top:10px; font-size:0.7rem; color:#ccc; border-top:1px dashed #eee; padding-top:10px; text-align:left;">
                                <strong>Diagnostic Info:</strong><br>
                                Your Role: ${role}<br>
                                Your Dist: ${myDist || 'Not Set'}<br>
                                Your Block: ${myBlock || 'Not Set'}<br>
                                Total Open Requests (Global): ${allRequests.filter(r => r.status === 'Open').length}<br>
                                <small>If "Total Open" is > 0 but none show here, there is a location mismatch.</small>
                            </div>
                        </div>`;
                } else {
                    myRequests.forEach(req => {
                        const planLabel = req.membership_plan ? `<span style="background:#f3e5f5; color:#7b1fa2; font-size:0.65rem; padding:2px 6px; border-radius:10px; font-weight:bold; margin-top:5px; display:inline-block;">Plan: ${req.membership_plan} (₹${req.amount || 299})</span><br>` : "";
                        const payBadge = req.payment_status === 'Payment Sent'
                            ? `<span style="background:#e1f5fe; color:#01579b; font-size:0.65rem; padding:2px 6px; border-radius:10px; font-weight:bold; margin-top:5px; display:inline-block;"><i class="fa-solid fa-circle-check"></i> Payment Verification Pending</span>`
                            : `<span style="background:#fff3e0; color:#e65100; font-size:0.65rem; padding:2px 6px; border-radius:10px; font-weight:bold; margin-top:5px; display:inline-block;"><i class="fa-solid fa-circle-info"></i> Payment Not Sent Yet</span>`;

                        reqBox.innerHTML += `
                            <div class="action-item">
                                <div class="action-left">
                                    <div class="action-icon"><i class="fa-solid fa-user-pen"></i></div>
                                    <div class="action-text">
                                        <h4 style="margin-bottom:2px;">${req.type}</h4>
                                        <p style="font-size:0.8rem; color:#666; margin:0;">${req.name} • ${req.mobile}</p>
                                        ${planLabel}${payBadge}
                                    </div>
                                </div>
                                <button onclick="processRequest('${req.reqId}')" class="btn-view" style="cursor:pointer;">Review ></button>
                            </div>
                        `;
                    });
                }
            }

            // --- PROCESS REQUEST FUNCTION (Cloud Refactor) ---
            window.processRequest = async function (reqId) {
                try {
                    const requests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
                    const req = requests.find(r => r.reqId === reqId);
                    if (!req) { alert("Request not found."); return; }

                    if (req.type === 'Membership Renewal' || req.type === 'Initial Fee Payment') {
                        const plan = req.membership_plan || 'Yearly';
                        const amt = req.amount || 299;
                        const payInfo = req.payment_status === 'Payment Sent'
                            ? `\n\n[Member has confirmed they SENT the ₹${amt} payment. Please verify.]`
                            : `\n\n[WARNING: Payment NOT confirmed.]`;

                        if (confirm(`Process ${req.type} for ${req.name}?\nPlan: ${plan} (₹${amt})\nMobile: ${req.mobile}${payInfo}\n\nClick OK to APPROVE.`)) {

                            // Find Member in Cloud
                            const memQS = await window.db.collection('members').where('mobile', '==', req.mobile).get();

                            if (!memQS.empty) {
                                const mDoc = memQS.docs[0];
                                const updates = {
                                    fee_status: 'Paid',
                                    membership_plan: plan,
                                    membership_amount: amt,
                                    valid_till: (plan === 'Lifetime' ? 'Lifetime' : '31 Dec 2026')
                                };

                                if (req.type === 'Initial Fee Payment') {
                                    updates.status = 'Approved';
                                    updates.payment_date = new Date().toISOString();
                                    // Approval Metadata
                                    const curOfficer = JSON.parse(localStorage.getItem('up_sangh_current_officer_session'));
                                    if (curOfficer) {
                                        updates.approved_by = curOfficer.name;
                                        updates.approved_role = curOfficer.role;
                                        updates.approved_location = (curOfficer.role === 'Block Admin') ? curOfficer.block : ((curOfficer.role === 'District Admin') ? curOfficer.district : curOfficer.division);
                                        updates.approved_date = new Date().toLocaleDateString('en-GB');
                                    }
                                }

                                await mDoc.ref.update(updates);

                                // Update Request
                                const reqQS = await window.db.collection('requests').where('reqId', '==', reqId).get();
                                if (!reqQS.empty) {
                                    reqQS.docs[0].ref.update({ status: 'Approved', newExpiry: '31 Dec 2026' });
                                }

                                alert('Renewal Approved! (Cloud Synced)');
                            } else {
                                alert("Member not found in Cloud database.");
                            }
                        }
                        return;
                    }

                    // Profile Update
                    const c = req.changes;
                    const changeList = [];
                    if (c.name) changeList.push(`Name: ${req.name} -> ${c.name}`);
                    if (c.father_name) changeList.push(`Father: ${c.father_name}`);
                    if (c.post) changeList.push(`Post: ${c.post}`);

                    if (confirm(`Approve profile updates for ${req.name}?\n\n${changeList.join('\n')}`)) {
                        const memQS = await window.db.collection('members').where('mobile', '==', req.mobile).get();
                        if (!memQS.empty) {
                            const mDoc = memQS.docs[0];
                            const updates = {};

                            Object.keys(c).forEach(key => {
                                if (c[key] !== undefined && c[key] !== null) {
                                    let tKey = key;
                                    if (key === 'father_name') tKey = 'fatherName';
                                    if (key === 'home_address') tKey = 'homeAddress';
                                    if (key === 'home_district') tKey = 'homeDistrict';
                                    if (key === 'work_district') tKey = 'workDistrict';
                                    updates[tKey] = c[key];
                                }
                            });
                            updates.status = 'Approved';

                            // Approval Metadata
                            const curOfficer = JSON.parse(localStorage.getItem('up_sangh_current_officer_session'));
                            if (curOfficer) {
                                updates.approved_by = curOfficer.name;
                                updates.approved_role = curOfficer.role;
                                updates.approved_location = (curOfficer.role === 'Block Admin') ? curOfficer.block : ((curOfficer.role === 'District Admin') ? curOfficer.district : curOfficer.division);
                                updates.approved_date = new Date().toLocaleDateString('en-GB');
                            }

                            await mDoc.ref.update(updates);

                            const reqQS = await window.db.collection('requests').where('reqId', '==', reqId).get();
                            if (!reqQS.empty) reqQS.docs[0].ref.update({ status: 'Approved' });

                            alert('Request Approved! Member profile updated (Cloud).');
                        } else {
                            alert("Member not found in Cloud.");
                        }

                    } else if (confirm("Do you want to REJECT this request?")) {
                        const reqQS = await window.db.collection('requests').where('reqId', '==', reqId).get();
                        if (!reqQS.empty) {
                            reqQS.docs[0].ref.update({ status: 'Rejected' }).then(() => alert("Request Rejected (Cloud)."));
                        }
                    }
                } catch (err) {
                    console.error("Process Request Error:", err);
                    alert("Error: " + err.message);
                }
            };

            window.verifyMemberDirect = async function (id) {
                if (!confirm("Approve this member?")) return;

                const members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
                const m = members.find(x => x.id === id);

                if (m && m.firestoreId) {
                    const updates = { status: 'Approved' };
                    // Metadata
                    try {
                        const curOfficer = JSON.parse(localStorage.getItem('up_sangh_current_officer_session'));
                        if (curOfficer) {
                            updates.approved_by = curOfficer.name;
                            updates.approved_role = curOfficer.role;
                            updates.approved_location = (curOfficer.role === 'Block Admin') ? curOfficer.block : ((curOfficer.role === 'District Admin') ? curOfficer.district : curOfficer.division);
                            updates.approved_date = new Date().toLocaleDateString('en-GB');
                        }
                    } catch (e) { }

                    window.db.collection('members').doc(m.firestoreId).update(updates)
                        .then(() => alert("Member Approved (Cloud)"));
                } else {
                    // Fallback query
                    const qs = await window.db.collection('members').where('id', '==', id).get();
                    if (!qs.empty) {
                        qs.docs[0].ref.update({ status: 'Approved' }).then(() => alert("Member Approved (Cloud Query)"));
                    } else {
                        alert("Member not found in Cloud.");
                    }
                }
            };

            window.rejectMemberDirect = async function (id) {
                if (!confirm("Reject this member?")) return;
                const members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
                const m = members.find(x => x.id === id);

                if (m && m.firestoreId) {
                    window.db.collection('members').doc(m.firestoreId).update({ status: 'Rejected' })
                        .then(() => alert("Member Rejected (Cloud)"));
                } else {
                    const qs = await window.db.collection('members').where('id', '==', id).get();
                    if (!qs.empty) {
                        qs.docs[0].ref.update({ status: 'Rejected' }).then(() => alert("Member Rejected (Cloud Query)"));
                    } else {
                        alert("Member not found in Cloud.");
                    }
                }
            };

            window.viewMember = function (id) {
                const members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
                const m = members.find(x => x.id === id);
                if (m) {
                    const wDist = m.work_district || m.workDistrict || '--';
                    const wTehsil = m.work_tahsil || '';
                    const wBlock = m.work_block || m.block || '';

                    const hDist = m.home_district || m.homeDistrict || '--';
                    const hTehsil = m.home_tahsil || '';
                    const hBlock = m.home_block || '';

                    const content = `
                        <div style="display:flex; gap:20px; align-items:start; flex-wrap: wrap;">
                            <div style="text-align: center;">
                                ${m.photo ? `<img src="${m.photo}" style="width:120px; border-radius:8px; border:1px solid #ddd;">` : '<i class="fa-solid fa-user-circle" style="font-size:120px; color:#ccc;"></i>'}
                                <div style="margin-top:10px;">
                                    <strong>हस्ताक्षर (Signature):</strong><br>
                                    ${m.signature ? `<img src="${m.signature}" style="max-width:150px; height:60px; object-fit:contain; border:1px solid #eee; margin-top:5px; background:#f9f9f9;">` : '<span style="color:#999; font-size:0.8rem;">Not Uploaded</span>'}
                                </div>
                            </div>
                            <div style="flex:1; min-width: 250px;">
                                <h2 style="margin:0;">${m.name}</h2>
                                <p style="color:#666;">Status: <strong style="color:${m.status === 'Approved' ? 'green' : (m.status === 'Rejected' ? 'red' : 'orange')}">${m.status}</strong></p>
                                <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:0.9rem;">
                                    <span><strong>पिता:</strong> ${m.father_name || m.fatherName || '--'}</span>
                                    <span><strong>मोबाइल:</strong> ${m.mobile}</span>
                                    <span><strong>जन्म तिथि:</strong> ${m.dob || '--'}</span>
                                    <span><strong>विभाग:</strong> ${m.department}</span>
                                    <span><strong>पद:</strong> ${m.post}</span>
                                    <span><strong>कार्यस्थल (District-T-B):</strong><br>${wDist}${wTehsil ? ' - ' + wTehsil : ''}${wBlock ? ' - ' + wBlock : ''}</span>
                                    <span><strong>गृह जनपद (District-T-B):</strong><br>${hDist}${hTehsil ? ' - ' + hTehsil : ''}${hBlock ? ' - ' + hBlock : ''}</span>
                                </div>
                                <div style="margin-top:15px; font-size:0.9rem;">
                                    <strong>पूरा पता (Address Details):</strong><br>
                                    ${m.home_address || m.homeAddress || m.address || '--'}
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('memberProfileContent').innerHTML = content;
                    document.getElementById('viewMemberModal').style.display = 'flex';
                }
            };

            // --- ID CARD LOGIC ---
            window.viewIDCard = function () {
                const officerStr = localStorage.getItem('up_sangh_current_officer_session');
                if (!officerStr) { alert("Please login first"); return; }
                const officer = JSON.parse(officerStr);

                const logo = localStorage.getItem('up_sangh_logo') || 'admin_logo.jpg';
                const unionName = localStorage.getItem('up_sangh_name') || 'उ.प्र. आउटसोर्सिंग एवं संविदा कर्मचारी संघ';

                // Verification data for QR
                const verificationData = {
                    id: officer.id || 'OFF-' + Date.now(),
                    name: officer.name,
                    role: officer.role,
                    location: officer.district || officer.block || officer.division || 'UP',
                    verified: true,
                    union: 'UP Outsourcing & Contract Employees Union'
                };

                const qrData = encodeURIComponent(JSON.stringify(verificationData));
                const qrCodeUrl = `https://chart.googleapis.com/chart?cht=qr&chs=150x150&chl=${qrData}`;

                const currentDate = new Date().toLocaleDateString('en-GB');

                // Determine Color based on Role
                let headerColor = '#2b5494';
                let roleBadgeColor = 'linear-gradient(135deg, #2b5494, #1e3c6e)';

                if (officer.role === 'District Admin') {
                    headerColor = '#6a0dad';
                    roleBadgeColor = 'linear-gradient(135deg, #6a0dad, #4b0082)';
                } else if (officer.role === 'Division Admin') {
                    headerColor = '#008080';
                    roleBadgeColor = 'linear-gradient(135deg, #008080, #004d4d)';
                }

                const cardHtml = `
                    <div id="printableIDCard" style="width:420px; height:250px; border-radius:10px; border:2.5px solid ${headerColor}; background: linear-gradient(135deg, #fff 75%, #f0f7ff 100%); position:relative; overflow:hidden; font-family:'Inter', sans-serif; box-shadow: 0 6px 20px rgba(0,0,0,0.12); margin: 0 auto; padding:10px; box-sizing:border-box;">
                        <!-- Card Header -->
                        <div style="display:flex; align-items:center; gap:10px; border-bottom:2.5px solid ${headerColor}; padding-bottom:3px; margin-bottom:5px;">
                            <img src="${logo}" style="width:48px; height:48px; border-radius:50%; border:2.5px solid ${headerColor}; padding:2px; background:white; flex-shrink:0; margin-left:8px;">
                            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; text-align:center; padding-right:8px;">
                                <h5 style="margin:0; font-size:16.5px; color:${headerColor}; font-weight:800; line-height:1.05; letter-spacing:-0.1px; white-space:nowrap;">${unionName}</h5>
                                <p style="margin:1px 0 0 0; font-size:9.5px; color:#c0392b; font-weight:700; text-transform:uppercase; line-height:1; letter-spacing:0.2px; white-space:nowrap;">OFFICIAL OFFICER IDENTITY CARD</p>
                            </div>
                        </div>
                        
                        <!-- Card Body -->
                        <div style="display:flex; gap:12px;">
                            <!-- Left: Photo -->
                            <div style="text-align:center; width:100px; flex-shrink:0;">
                                ${officer.photo ? `<img src="${officer.photo}" style="width:98px; height:108px; border:2px solid ${headerColor}; border-radius:5px; object-fit:cover; box-shadow:0 2px 8px rgba(0,0,0,0.1);">` : `<div style="width:98px; height:108px; border:2px solid #ddd; border-radius:5px; background:#f9f9f9; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-user-tie" style="font-size:40px; color:#ccc;"></i></div>`}
                                <div style="margin-top:4px; padding:3px 5px; background:${roleBadgeColor}; color:white; font-size:10px; border-radius:4px; font-weight:bold; width:100%; box-sizing:border-box; box-shadow:0 2px 5px rgba(0,0,0,0.15); text-transform:uppercase;">${officer.role.replace(' Admin', '')}</div>
                            </div>
                            
                            <!-- Right: Details -->
                            <div style="flex:1; font-size:10px; line-height:1.45; color:#2c3e50;">
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">NAME:</strong> <span style="color:#000; font-weight:700; font-size:11px;">${officer.name}</span></div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">POST:</strong> <span style="font-weight:700; color:#c0392b;">${officer.post || '--'}</span></div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">ROLE:</strong> <span style="font-weight:600;">${officer.role}</span></div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">LOCATION:</strong> <span style="color:#c0392b; font-weight:700;">${officer.district || officer.block || officer.division || 'Headquarters'}</span></div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">MOBILE:</strong> <span>${officer.mobile || officer.userId || '--'}</span></div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">ISSUED:</strong> <span>${currentDate}</span></div>
                                <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">VALID TILL:</strong> <span>31 Dec 2026</span></div>
                            </div>
                        </div>
                        
                        <!-- Footer: QR & Signature -->
                        <div style="position:absolute; bottom:8px; left:0; right:0; display:flex; justify-content:flex-end; align-items:flex-end; padding:0 18px;">
                            <div style="text-align:center;">
                                <img src="${qrCodeUrl}" style="width:48px; height:48px; display:block; margin:0 auto 3px; border:1px solid #ddd; border-radius:3px; padding:2px; background:white;">
                                <p style="margin:0 0 4px 0; font-size:6px; color:#666; font-weight:700; text-transform:uppercase; letter-spacing:0.2px;">Scan for Verification</p>
                                <img src="digital_seal.jpg" style="width:60px; height:60px; object-fit:contain; opacity:0.9;">
                                <div style="border-top:1.5px solid #333; width:105px; margin:0 auto;"></div>
                                <p style="margin:0; font-size:8px; font-weight:bold; color:#333; text-transform:uppercase; letter-spacing:0.2px;">प्रदेश अध्यक्ष</p>
                            </div>
                        </div>
                        <div style="position:absolute; bottom:0; left:0; width:100%; height:8px; background:${roleBadgeColor};"></div>
                    </div>
                `;
                document.getElementById('idCardPreviewContainer').innerHTML = cardHtml;
                document.getElementById('idCardPreviewContainer').style.transform = 'scale(1)';

                const mCard = document.getElementById('modalCardContent');
                if (mCard) mCard.innerHTML = cardHtml;
                const mModal = document.getElementById('viewIDCardModal');
                if (mModal) mModal.style.display = 'flex';
            };

            window.printIDCard = function () {
                const content = document.getElementById('printableIDCard');
                if (!content) { viewIDCard(); return; }

                const originalContents = document.body.innerHTML;
                document.body.innerHTML = `
                    <style>
                        body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
                    </style>
                    ${content.outerHTML}
                `;
                window.print();
                location.reload();
            };

            window.downloadIDCardPDF = function () {
                if (typeof window.jspdf === 'undefined') { alert("Libraries loading..."); return; }

                const card = document.getElementById('printableIDCard');
                if (!card) { viewIDCard(); setTimeout(downloadIDCardPDF, 500); return; }

                const { jsPDF } = window.jspdf;
                html2canvas(card, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('l', 'mm', [85, 54]);
                    pdf.addImage(imgData, 'PNG', 0, 0, 85, 54);
                    pdf.save(`Officer_ID_Card.pdf`);
                });
            };

        });

        // --- ID CARD LOGIC (Global) ---
        window.viewIDCard = function () {
            const officerStr = localStorage.getItem('up_sangh_current_officer_session');
            if (!officerStr) { alert("Please login first"); return; }
            const officer = JSON.parse(officerStr);

            const logo = localStorage.getItem('up_sangh_logo') || 'admin_logo.jpg';
            const unionName = localStorage.getItem('up_sangh_name') || 'उ.प्र. आउटसोर्सिंग एवं संविदा कर्मचारी संघ';

            // Verification data for QR
            const verificationData = {
                id: officer.id || 'OFF-' + Date.now(),
                name: officer.name,
                role: officer.role,
                location: officer.district || officer.block || officer.division || 'UP',
                verified: true,
                union: 'UP Outsourcing & Contract Employees Union'
            };

            const qrData = encodeURIComponent(JSON.stringify(verificationData));
            const qrCodeUrl = `https://chart.googleapis.com/chart?cht=qr&chs=150x150&chl=${qrData}`;

            const currentDate = new Date().toLocaleDateString('en-GB');

            // Determine Color based on Role
            let headerColor = '#2b5494';
            let roleBadgeColor = 'linear-gradient(135deg, #2b5494, #1e3c6e)';

            if (officer.role === 'District Admin') {
                headerColor = '#6a0dad';
                roleBadgeColor = 'linear-gradient(135deg, #6a0dad, #4b0082)';
            } else if (officer.role === 'Division Admin') {
                headerColor = '#008080';
                roleBadgeColor = 'linear-gradient(135deg, #008080, #004d4d)';
            }

            const cardHtml = `
                <div id="printableIDCard" style="width:420px; height:250px; border-radius:10px; border:2.5px solid ${headerColor}; background: linear-gradient(135deg, #fff 75%, #f0f7ff 100%); position:relative; overflow:hidden; font-family:'Inter', sans-serif; box-shadow: 0 6px 20px rgba(0,0,0,0.12); margin: 0 auto; padding:10px; box-sizing:border-box;">
                    <!-- Card Header -->
                    <div style="display:flex; align-items:center; gap:10px; border-bottom:2.5px solid ${headerColor}; padding-bottom:3px; margin-bottom:5px;">
                        <img src="${logo}" style="width:48px; height:48px; border-radius:50%; border:2.5px solid ${headerColor}; padding:2px; background:white; flex-shrink:0; margin-left:8px;">
                        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; text-align:center; padding-right:8px;">
                            <h5 style="margin:0; font-size:16.5px; color:${headerColor}; font-weight:800; line-height:1.05; letter-spacing:-0.1px; white-space:nowrap;">${unionName}</h5>
                            <p style="margin:2px 0 0 0; font-size:10px; color:#c0392b; font-weight:800; text-transform:uppercase; line-height:1; letter-spacing:0.3px; white-space:nowrap;">U.P. OUTSOURCING & CONTRACT EMPLOYEES UNION</p>
                            <p style="margin:2px 0 0 0; font-size:8.5px; color:#333; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; background:#f0f0f0; padding:1px 6px; border-radius:4px; display:inline-block;">OFFICIAL OFFICER IDENTITY CARD</p>
                        </div>
                    </div>
                    
                    <!-- Card Body -->
                    <div style="display:flex; gap:12px;">
                        <!-- Left: Photo -->
                        <div style="text-align:center; width:100px; flex-shrink:0;">
                            ${officer.photo ? `<img src="${officer.photo}" style="width:98px; height:108px; border:2px solid ${headerColor}; border-radius:5px; object-fit:cover; box-shadow:0 2px 8px rgba(0,0,0,0.1);">` : `<div style="width:98px; height:108px; border:2px solid #ddd; border-radius:5px; background:#f9f9f9; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-user-tie" style="font-size:40px; color:#ccc;"></i></div>`}
                            <div style="margin-top:4px; padding:3px 5px; background:${roleBadgeColor}; color:white; font-size:10px; border-radius:4px; font-weight:bold; width:100%; box-sizing:border-box; box-shadow:0 2px 5px rgba(0,0,0,0.15); text-transform:uppercase;">${officer.role.replace(' Admin', '')}</div>
                        </div>
                        
                        <!-- Right: Details -->
                        <div style="flex:1; font-size:10px; line-height:1.45; color:#2c3e50;">
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">NAME:</strong> <span style="color:#000; font-weight:700; font-size:11px;">${officer.name}</span></div>
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">ROLE:</strong> <span style="font-weight:600;">${officer.role}</span></div>
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">LOCATION:</strong> <span style="color:#c0392b; font-weight:700;">${officer.district || officer.block || officer.division || 'Headquarters'}</span></div>
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">MOBILE:</strong> <span>${officer.mobile || officer.userId || '--'}</span></div>
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">ISSUED:</strong> <span>${currentDate}</span></div>
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:70px; color:${headerColor};">VALID TILL:</strong> <span>31 Dec 2026</span></div>
                        </div>
                    </div>
                    
                    <!-- Footer: QR & Signature -->
                    <div style="position:absolute; bottom:8px; left:0; right:0; display:flex; justify-content:flex-end; align-items:flex-end; padding:0 18px;">
                        <div style="text-align:center;">
                            <img src="${qrCodeUrl}" style="width:48px; height:48px; display:block; margin:0 auto 3px; border:1px solid #ddd; border-radius:3px; padding:2px; background:white;">
                            <p style="margin:0 0 4px 0; font-size:6px; color:#666; font-weight:700; text-transform:uppercase; letter-spacing:0.2px;">Scan for Verification</p>
                            <img src="digital_seal.jpg" style="width:60px; height:60px; object-fit:contain; opacity:0.9;">
                            <div style="border-top:1.5px solid #333; width:105px; margin:0 auto;"></div>
                            <p style="margin:0; font-size:8px; font-weight:bold; color:#333; text-transform:uppercase; letter-spacing:0.2px;">State President</p>
                        </div>
                    </div>
                    <div style="position:absolute; bottom:0; left:0; width:100%; height:8px; background:${roleBadgeColor};"></div>
                </div>
            `;
            document.getElementById('idCardPreviewContainer').innerHTML = cardHtml;
            document.getElementById('idCardPreviewContainer').style.transform = 'scale(1)';

            const mCard = document.getElementById('modalCardContent');
            if (mCard) mCard.innerHTML = cardHtml;
            const mModal = document.getElementById('viewIDCardModal');
            if (mModal) mModal.style.display = 'flex';
        };

        window.printIDCard = function () {
            const content = document.getElementById('printableIDCard');
            if (!content) { viewIDCard(); return; }

            const originalContents = document.body.innerHTML;
            document.body.innerHTML = `
                <style>
                    body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
                </style>
                ${content.outerHTML}
            `;
            window.print();
            location.reload();
        };

        window.downloadIDCardPDF = function () {
            if (typeof window.jspdf === 'undefined') { alert("Libraries loading..."); return; }

            const card = document.getElementById('printableIDCard');
            if (!card) { viewIDCard(); setTimeout(downloadIDCardPDF, 500); return; }

            const { jsPDF } = window.jspdf;
            html2canvas(card, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('l', 'mm', [85, 54]);
                pdf.addImage(imgData, 'PNG', 0, 0, 85, 54);
                pdf.save(`Officer_ID_Card.pdf`);
            });
        };
    </script>

    <!-- View Member Modal -->
    <div id="viewMemberModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:20px; border-radius:10px; width:95%; max-width:650px; max-height: 90vh; overflow-y: auto; position:relative;">
            <button onclick="document.getElementById('viewMemberModal').style.display='none'"
                style="position:absolute; right:15px; top:15px; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            <h3 style="border-bottom:1px solid #eee; padding-bottom:10px;">सदस्य विवरण (Member Profile)</h3>
            <div id="memberProfileContent" style="margin-top:20px;">
                <!-- JS Populated -->
            </div>
        </div>
    </div>
</body>

</html>