<!DOCTYPE html>
<html lang="hi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>सुपर एडमिन पैनल (Super Admin Panel) - उ.प्र. आउटसोर्सिंग एवं संविदा कर्मचारी संघ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase_config.js"></script>
    <style>
        /* Dashboard Layout */
        body {
            background-color: #f4f6f9;
        }

        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: #343a40;
            color: white;
            flex-shrink: 0;
            padding-top: 20px;
            transition: width 0.3s;
        }

        .sidebar h2 {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 2rem;
            color: #ffd700;
            border-bottom: 1px solid #4b545c;
            padding-bottom: 10px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
        }

        .sidebar-menu li {
            padding: 0;
        }

        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: #c2c7d0;
            text-decoration: none;
            font-size: 1rem;
            transition: background 0.3s;
            cursor: pointer;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: #007bff;
            color: white;
        }

        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .section-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: none;
            /* Hidden by default, toggled via JS */
        }

        .section-card.active {
            display: block;
        }

        .header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #007bff;
        }

        .stat-box h3 {
            font-size: 2.5rem;
            margin: 0;
            color: #333;
        }

        .stat-box p {
            margin: 5px 0 0;
            color: #666;
        }

        /* Tables & Forms */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px dashed #ccc;
        }

        .form-row input,
        .form-row select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #333;
        }

        .btn-primary {
            background-color: #007bff;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        .btn-xs {
            padding: 2px 6px;
            font-size: 0.75rem;
        }

        .btn-info {
            background-color: #17a2b8;
        }

        .btn-outline-success {
            border: 1px solid #28a745;
            color: #28a745;
            background: transparent;
        }

        .btn-outline-success:hover {
            background: #28a745;
            color: white;
        }

        .btn-outline-info {
            border: 1px solid #17a2b8;
            color: #17a2b8;
            background: transparent;
        }

        .btn-outline-info:hover {
            background: #17a2b8;
            color: white;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .bg-success {
            background: #d4edda;
            color: #155724;
        }

        .bg-warning {
            background: #fff3cd;
            color: #856404;
        }

        .bg-primary {
            background: #cce5ff;
            color: #004085;
        }

        .bg-secondary {
            background: #e2e3e5;
            color: #383d41;
        }

        /* Full Control Panel Styling */
        .control-panel-container {
            margin-top: 10px;
        }

        .category-group {
            margin-bottom: 40px;
        }

        .category-header {
            font-size: 0.9rem;
            font-weight: 700;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .control-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #f0f0f0;
            position: relative;
            overflow: hidden;
        }

        .control-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
            border-color: #007bff;
        }

        .control-card::after {
            content: "\f054";
            /* FontAwesome chevron-right */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            right: 20px;
            color: #ccc;
            opacity: 0;
            transition: all 0.3s;
        }

        .control-card:hover::after {
            opacity: 1;
            right: 15px;
            color: #007bff;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: #007bff;
            transition: all 0.3s;
        }

        .control-card:hover .card-icon {
            background: #007bff;
            color: white;
        }

        .card-info h4 {
            margin: 0;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 4px;
        }

        .card-info p {
            margin: 0;
            font-size: 0.85rem;
            color: #777;
            line-height: 1.3;
        }

        .badge-count {
            position: absolute;
            top: 20px;
            right: 40px;
            background: #ff4757;
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 700;
        }

        /* Tabs Styling */
        .tab-container {
            display: flex;
            gap: 20px;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
            margin-top: 10px;
        }

        .tab-item {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-item.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Invoice & Print Styling */
        @media print {

            .sidebar,
            .header-flex,
            .btn,
            .tab-container,
            .dashboard-container,
            .stats-grid,
            .developer-tools,
            .badge-count,
            .sidebar-menu,
            .no-print,
            .btn-close-invoice {
                display: none !important;
            }

            .main-content {
                padding: 0 !important;
                margin: 0 !important;
            }

            .section-card {
                box-shadow: none !important;
                border: none !important;
            }

            #viewInvoiceModal {
                position: static !important;
                display: block !important;
                background: white !important;
            }

            .invoice-box {
                box-shadow: none !important;
                border: 1px solid #eee !important;
            }
        }

        .invoice-box {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: auto;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .invoice-title {
            font-size: 1.8rem;
            color: #333;
            font-weight: 800;
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
    </style>
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase_config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>

    <!-- Admin Check -->
    <div class="dashboard-container"></div> <!-- Marker for script.js protection -->

    <div class="admin-wrapper">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div style="text-align: center; padding: 10px 0; border-bottom: 1px solid #4b545c; margin-bottom: 15px;">
                <img src="admin_logo.jpg" alt="Logo"
                    style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid #ffd700; background: white; margin-bottom: 10px;">
                <h2
                    style="font-size: 1.1rem; color: #ffd700; margin-bottom: 5px; border-bottom: none; padding-bottom: 0; line-height: 1.4;">
                    Super Admin Panel</h2>
                <p style="font-size: 0.75rem; color: #ffd700; margin-bottom: 5px;">संगठित शक्ति, सुरक्षित भविष्य</p>
                <div style="font-size: 0.6rem; color: #aaa; margin-top: 5px;">Version: 3.1 (Reports Fixed)</div>
            </div>
            <ul class="sidebar-menu">
                <li><a onclick="showSection('dashboard')" id="link-dashboard" class="active"><i
                            class="fa-solid fa-gauge"></i> डैशबोर्ड (Dashboard)</a></li>
                <li><a onclick="showSection('members')" id="link-members"><i class="fa-solid fa-users"></i> सदस्य
                        (Members)</a></li>
                <li><a onclick="showSection('officers')" id="link-officers"><i class="fa-solid fa-user-tie"></i>
                        पदाधिकारी (Officers)</a></li>
                <li><a onclick="showSection('issues')" id="link-issues"><i class="fa-solid fa-comments"></i> समस्याएं
                        (Issues)</a></li>
                <li><a onclick="showSection('reports')" id="link-reports"><i class="fa-solid fa-file-contract"></i>
                        रिपोर्ट्स (Reports)</a></li>
                <li><a onclick="showSection('id-cards-fees')" id="link-id-cards-fees"><i
                            class="fa-solid fa-id-card"></i> ID कार्ड और शुल्क (ID Cards & Fees)</a></li>
                <li><a onclick="showSection('notices')" id="link-notices"><i class="fa-solid fa-bullhorn"></i> नोटिस
                        (Notices)</a></li>
                <li><a onclick="showSection('complaints')" id="link-complaints"><i
                            class="fa-solid fa-circle-exclamation"></i> यूनियन शिकायतें (Union Complaints)</a></li>
                <li><a onclick="showSection('documents')" id="link-documents"><i class="fa-solid fa-file-pdf"></i>
                        दस्तावेज़ प्रबंधन (Documents)</a></li>
                <li><a onclick="showSection('roles')" id="link-roles"><i class="fa-solid fa-user-lock"></i> पहुँच
                        नियंत्रण (Roles & Access)</a></li>
                <li><a onclick="showSection('media-gallery')" id="link-media-gallery"><i class="fa-solid fa-images"></i>
                        मीडिया गैलरी (Media Gallery)</a></li>
                <li><a onclick="showSection('settings')" id="link-settings"><i class="fa-solid fa-gears"></i> सिस्टम
                        सेटिंग्स (System Settings)</a></li>

                <li><a href="index.html"><i class="fa-solid fa-globe"></i> वेबसाइट देखें (Go to Website)</a></li>
                <li><a onclick="logoutAdmin()" style="color: #ff6b6b;"><i class="fa-solid fa-right-from-bracket"></i>
                        लॉगआउट (Logout)</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">

            <!-- 1. DASHBOARD HOME -->
            <div id="section-dashboard" class="section-card active">
                <div class="header-flex">
                    <h2>स्वागत है, एडमिन! (Welcome Admin)</h2>
                    <button onclick="loadDashboardData()" class="btn btn-sm btn-primary"><i
                            class="fa-solid fa-arrows-rotate"></i> ताज़ा करें (Refresh)</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-box" style="border-left-color: #28a745;">
                        <h3 id="statTotalMembers">0</h3>
                        <p>कुल पंजीकृत सदस्य</p>
                    </div>
                    <div class="stat-box" style="border-left-color: #17a2b8;">
                        <h3 id="statTotalOfficers">0</h3>
                        <p>कुल पदाधिकारी</p>
                    </div>
                    <div class="stat-box" style="border-left-color: #ffc107;">
                        <h3 id="statTotalIssues">0</h3>
                        <p>प्राप्त समस्याएं</p>
                    </div>
                </div>


                <!-- Developer Tools for Mock Data -->
                <div
                    style="margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 8px; border: 1px dashed #6c757d;">
                    <h4 style="margin-bottom: 10px; color: #495057;"><i class="fa-solid fa-flask"></i> टेस्टिंग
                        टूल्स
                        (Testing Tools)</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="generateCompleteMockDataset()" class="btn btn-sm btn-primary">
                            <i class="fa-solid fa-database"></i> पूरा डमी डेटा (Complete Dataset)
                        </button>
                        <button onclick="generateMockMembers(500)" class="btn btn-sm btn-info">
                            <i class="fa-solid fa-users"></i> 500 डमी सदस्य (Members)
                        </button>
                        <button onclick="generateMockDistrictAdmins()" class="btn btn-sm btn-info">
                            <i class="fa-solid fa-user-shield"></i> जिला एडमिन (Dist Admins)
                        </button>
                        <button onclick="generateMockReports()" class="btn btn-sm btn-info">
                            <i class="fa-solid fa-file-invoice"></i> डमी रिपोर्ट्स (Reports)
                        </button>
                        <button onclick="generateMockIssues()" class="btn btn-sm btn-info">
                            <i class="fa-solid fa-headset"></i> डमी समस्याएं (Issues)
                        </button>
                        <button onclick="generateMockFees()" class="btn btn-sm btn-info">
                            <i class="fa-solid fa-credit-card"></i> डमी शुल्क (Fees)
                        </button>
                        <button onclick="generateMockComplaints()" class="btn btn-sm btn-info">
                            <i class="fa-solid fa-file-circle-exclamation"></i> डमी शिकायतें (Complaints)
                        </button>
                        <button onclick="generateMockMedia()" class="btn btn-sm btn-info">
                            <i class="fa-solid fa-images"></i> डमी मीडिया (Gallery)
                        </button>
                        <button onclick="generateMockDocs()" class="btn btn-sm btn-info">
                            <i class="fa-solid fa-file-pdf"></i> डमी दस्तावेज़ (Docs)
                        </button>
                        <button onclick="clearAllData()" class="btn btn-sm btn-danger">
                            <i class="fa-solid fa-trash-can"></i> सारा डेटा क्लियर (Clear All)
                        </button>
                    </div>
                    <p style="font-size: 0.75rem; color: #6c757d; margin-top: 5px;">*ये टूल्स केवल टेस्टिंग के लिए
                        हैं।
                        (For testing purposes only)</p>
                </div>

                <div style="margin-top:30px;">
                    <div class="header-flex">
                        <h3>प्रोफ़ाइल अपडेट अनुरोध (Profile Update Requests)</h3>
                        <span id="reqCountBadge"
                            style="background:#e74c3c; color:white; padding:2px 8px; border-radius:10px; font-size:0.8rem; display:none;">0</span>
                    </div>
                    <div id="adminRequestsList" class="table-responsive"
                        style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
                        <table id="requestsTable">
                            <thead>
                                <tr style="background:#f8f9fa;">
                                    <th>प्रकार (Type)</th>
                                    <th>नाम (Name)</th>
                                    <th>मोबाइल (Mobile)</th>
                                    <th>ब्लॉक/जिला (Area)</th>
                                    <th>दिनांक (Date)</th>
                                    <th>एक्शन (Action)</th>
                                </tr>
                            </thead>
                            <tbody id="adminRequestsBody">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="margin-top:30px;">
                    <h3>हाल ही में जुड़े सदस्य (Recently Joined Members)</h3>
                    <div class="table-responsive">
                        <table id="recentMembersTable">
                            <thead>
                                <tr>
                                    <th>नाम (Name)</th>
                                    <th>मोबाइल (Mobile)</th>
                                    <th>विभाग (Dept)</th>
                                    <th>पद (Post)</th>
                                    <th>जिला (District)</th>
                                    <th>दिनांक (Date)</th>
                                </tr>
                            </thead>
                            <tbody><!-- JS Populated --></tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- NEW: SYSTEM SETTINGS SECTION -->
            <div id="section-settings" class="section-card">
                <div class="header-flex">
                    <h2>सिस्टम सेटिंग्स और सुरक्षा (System Settings & Security)</h2>
                    <button onclick="loadSystemSettings()" class="btn btn-sm btn-primary"><i
                            class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                </div>

                <div class="stats-grid" style="margin-bottom:20px;">
                    <div class="stat-box" style="border-left-color: #6c757d;">
                        <h3 id="statTotalRecords">Total</h3>
                        <p>Total Local Storage Size</p>
                    </div>
                    <div class="stat-box" style="border-left-color: #e83e8c;">
                        <h3 id="statLastBackup">N/A</h3>
                        <p>Last Activity Timestamp</p>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <!-- Admin Security -->
                    <div style="background:#fff5f5; padding:20px; border-radius:10px; border:1px solid #ffcccc;">
                        <h3 style="margin-top:0; color:#c82333;"><i class="fa-solid fa-shield-halved"></i> एडमिन सुरक्षा
                            (Admin Security)</h3>
                        <div class="form-group" style="margin-bottom:15px;">
                            <label>नया एडमिन पासवर्ड (New Password):</label>
                            <input type="password" id="newAdminPass" placeholder="Enter new password"
                                style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div class="form-group" style="margin-bottom:15px;">
                            <label>पासवर्ड की पुष्टि करें (Confirm Password):</label>
                            <input type="password" id="confirmAdminPass" placeholder="Confirm new password"
                                style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <button onclick="updateAdminSecurity()" class="btn btn-danger" style="width:100%;"><i
                                class="fa-solid fa-key"></i> पासवर्ड बदलें (Update Password)</button>
                    </div>

                    <!-- Branding Settings -->
                    <div style="background:#f0f8ff; padding:20px; border-radius:10px; border:1px solid #b0d4ff;">
                        <h3 style="margin-top:0; color:#0056b3;"><i class="fa-solid fa-palette"></i> साइट ब्रांडिंग
                            (Site Branding)</h3>
                        <div class="form-group" style="margin-bottom:15px;">
                            <label>यूनियन का नाम (Union Name):</label>
                            <input type="text" id="settingUnionName" placeholder="Union Name"
                                style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div class="form-group" style="margin-bottom:15px;">
                            <label>वर्जन / टैगलाइन (Version/Tagline):</label>
                            <input type="text" id="settingTagline" placeholder="Tagline"
                                style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div class="form-group" style="margin-bottom:15px;">
                            <label>साइट लोगो (Site Logo):</label>
                            <input type="file" id="settingLogo" accept="image/*"
                                style="width:100%; padding:5px; border:1px solid #ccc; border-radius:4px; background:white;">
                        </div>
                        <button onclick="updateSystemBranding()" class="btn btn-primary" style="width:100%;"><i
                                class="fa-solid fa-floppy-disk"></i> सेटिंग्स अपडेट करें (Save Branding)</button>
                    </div>
                </div>

                <!-- Backup & Master Tools -->
                <div
                    style="margin-top:20px; background:#f4f6f9; padding:20px; border-radius:10px; border:1px solid #dee2e6;">
                    <h3 style="margin-top:0;"><i class="fa-solid fa-database"></i> डेटा बैकअप और रिकवरी (Data Backup &
                        Recovery)</h3>
                    <p style="font-size:0.85rem; color:#666;">आपका सारा डेटा लोकल ब्राउज़र में सुरक्षित है। हम सलाह देते
                        हैं कि आप नियमित रूप से बैकअप डाउनलोड करें।</p>
                    <div style="display:flex; gap:15px; margin-top:20px;">
                        <button onclick="exportSystemData()" class="btn btn-success" style="flex:1;"><i
                                class="fa-solid fa-download"></i> बैकअप डाउनलोड करें (Export JSON)</button>
                        <div style="flex:1; display:flex; gap:10px;">
                            <input type="file" id="importFile" accept=".json"
                                style="flex:1; padding:5px; background:white; border:1px solid #ccc; border-radius:4px;">
                            <button onclick="importSystemData()" class="btn btn-warning"><i
                                    class="fa-solid fa-upload"></i> रिस्टोर (Import)</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: DOCUMENTS MANAGEMENT SECTION -->
            <div id="section-documents" class="section-card">
                <div class="header-flex">
                    <h2>दस्तावेज़ प्रबंधन (Upload & Manage Documents)</h2>
                    <button onclick="loadDocumentsData()" class="btn btn-sm btn-primary"><i
                            class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                </div>

                <!-- Document Upload Form -->
                <div
                    style="background:#f0f4f8; padding:20px; border-radius:8px; border:1px solid #d1d9e6; margin-bottom:20px;">
                    <h4 style="margin-top:0;"><i class="fa-solid fa-upload"></i> नया दस्तावेज़ जोड़ें (Upload New
                        Document)</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 100px; gap:15px; align-items: end;">
                        <div>
                            <label style="font-size:0.85rem; display:block; margin-bottom:5px;">दस्तावेज़ फाइल
                                (PDF/Doc):</label>
                            <input type="file" id="docFile" accept=".pdf,.doc,.docx"
                                style="width:100%; border:1px solid #ccc; padding:5px; border-radius:4px; background:white;">
                        </div>
                        <div>
                            <label style="font-size:0.85rem; display:block; margin-bottom:5px;">दस्तावेज़ का नाम
                                (Title):</label>
                            <input type="text" id="docTitle" placeholder="Document Title"
                                style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div>
                            <label style="font-size:0.85rem; display:block; margin-bottom:5px;">श्रेणी
                                (Category):</label>
                            <select id="docCategory"
                                style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                <option>Union Circular</option>
                                <option>Govt Order</option>
                                <option>Membership Form</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <button onclick="uploadDocument()" class="btn btn-success" style="padding:10px;"><i
                                class="fa-solid fa-plus"></i> अपलोड</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="documentsTable">
                        <thead>
                            <tr>
                                <th>नाम (Document Name)</th>
                                <th>श्रेणी (Category)</th>
                                <th>अपलोड तिथि (Date)</th>
                                <th>एक्शन (Action)</th>
                            </tr>
                        </thead>
                        <tbody><!-- JS Populated --></tbody>
                    </table>
                </div>
            </div>

            <!-- NEW: ROLES & ACCESS MANAGEMENT SECTION -->
            <div id="section-roles" class="section-card">
                <div class="header-flex">
                    <h2>भूमिका और पहुँँच नियंत्रण (Assign Roles & Control Access)</h2>
                    <button onclick="loadRolesData()" class="btn btn-sm btn-primary"><i
                            class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                </div>

                <div
                    style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px; margin-bottom:20px;">
                    <div style="background:#fff9e6; padding:15px; border-radius:8px; border:1px solid #ffeeba;">
                        <h4 style="margin:0 0 10px 0; color:#856404;"><i class="fa-solid fa-user-secret"></i> State
                            Admin</h4>
                        <p style="font-size:0.8rem; margin:0;">Full access to system, finances, and member verification.
                        </p>
                    </div>
                    <div style="background:#e8f4fd; padding:15px; border-radius:8px; border:1px solid #bee5eb;">
                        <h4 style="margin:0 0 10px 0; color:#0c5460;"><i class="fa-solid fa-user-tie"></i> District
                            Admin</h4>
                        <p style="font-size:0.8rem; margin:0;">Can verify members and view reports for their district
                            only.</p>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="rolesTable">
                        <thead>
                            <tr>
                                <th>नाम (Name)</th>
                                <th>पहुँच स्तर (Current Role)</th>
                                <th>पहुँच बदलें (Change Access)</th>
                                <th>एक्शन</th>
                            </tr>
                        </thead>
                        <tbody><!-- JS Populated --></tbody>
                    </table>
                </div>
            </div>

            <!-- NEW: MEDIA GALLERY SECTION -->
            <div id="section-media-gallery" class="section-card">
                <div class="header-flex">
                    <h2>मीडिया गैलरी प्रबंधन (Media Gallery Management)</h2>
                    <div style="display:flex; gap:10px;">
                        <button onclick="loadMediaGallery()" class="btn btn-sm btn-primary"><i
                                class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                    </div>
                </div>

                <!-- Media Upload Form -->
                <div
                    style="background:#f9f9f9; padding:20px; border-radius:8px; border:1px solid #eee; margin-bottom:20px;">
                    <h4 style="margin-top:0;"><i class="fa-solid fa-upload"></i> नया मीडिया अपलोड करें (Upload New
                        Media)</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 100px; gap:15px; align-items: end;">
                        <div>
                            <label style="font-size:0.85rem; display:block; margin-bottom:5px;">मीडिया फाइल
                                (Photo/Video):</label>
                            <input type="file" id="mediaFile" accept="image/*,video/*"
                                style="width:100%; border:1px solid #ccc; padding:5px; border-radius:4px; background:white;">
                        </div>
                        <div>
                            <label style="font-size:0.85rem; display:block; margin-bottom:5px;">कैप्शन
                                (Caption/Description):</label>
                            <input type="text" id="mediaCaption" placeholder="मीडिया के बारे में लिखें..."
                                style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <button onclick="uploadMedia()" class="btn btn-success" style="padding:10px;"><i
                                class="fa-solid fa-plus"></i> जोड़ें</button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom:20px;">
                    <div class="stat-box" style="border-left-color: #007bff;">
                        <h3 id="mediaStatTotal">0</h3>
                        <p>Total Items</p>
                    </div>
                    <div class="stat-box" style="border-left-color: #28a745;">
                        <h3 id="mediaStatImages">0</h3>
                        <p>Images</p>
                    </div>
                    <div class="stat-box" style="border-left-color: #17a2b8;">
                        <h3 id="mediaStatVideos">0</h3>
                        <p>Videos</p>
                    </div>
                </div>

                <!-- Media Display Grid -->
                <div id="mediaGrid"
                    style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:20px;">
                    <!-- JS Populated -->
                </div>
            </div>

            <!-- NEW: UNION COMPLAINTS SECTION -->
            <div id="section-complaints" class="section-card">
                <div class="header-flex">
                    <h2>यूनियन की सभी शिकायतें (Manage All Union Complaints)</h2>
                    <div style="display:flex; gap:10px;">
                        <button onclick="loadComplaintsData()" class="btn btn-sm btn-primary"><i
                                class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom:20px;">
                    <div class="stat-box" style="border-left-color: #28a745;">
                        <h3 id="complaintStatTotal">0</h3>
                        <p>Total Complaints</p>
                    </div>
                    <div class="stat-box" style="border-left-color: #ffc107;">
                        <h3 id="complaintStatPending">0</h3>
                        <p>Pending Review</p>
                    </div>
                    <div class="stat-box" style="border-left-color: #dc3545;">
                        <h3 id="complaintStatResolved">0</h3>
                        <p>Resolved Cases</p>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="complaintsTable">
                        <thead>
                            <tr>
                                <th>दिनांक</th>
                                <th>नाम (Name)</th>
                                <th>विभाग (Dept)</th>
                                <th>प्रकार (Type)</th>
                                <th>विवरण (Description)</th>
                                <th>स्थिति (Status)</th>
                                <th>एक्शन (Actions)</th>
                            </tr>
                        </thead>
                        <tbody><!-- JS Populated --></tbody>
                    </table>
                </div>
            </div>

            <!-- NEW: NOTICES MANAGEMENT SECTION (ADDED) -->
            <div id="section-notices" class="section-card">
                <div class="header-flex">
                    <h2>नोटिस और घोषणाएँ (Notices & Announcements)</h2>
                    <button onclick="publishNotice()" class="btn btn-sm btn-primary"><i class="fa-solid fa-plus"></i>
                        नया नोटिस</button>
                </div>
                <div
                    style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #eee;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr 100px; gap:10px; align-items:end;">
                        <div>
                            <label style="font-size:0.8rem; font-weight:bold;">टाइटल (Title):</label>
                            <input type="text" id="noticeTitle"
                                style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div>
                            <label style="font-size:0.8rem; font-weight:bold;">कंटेंट (Content):</label>
                            <input type="text" id="noticeContent"
                                style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div>
                            <select id="noticeTarget"
                                style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                <option value="All">All</option>
                                <option value="Officers">Officers</option>
                                <option value="Members">Members</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="noticesTable">
                        <thead>
                            <tr>
                                <th>दिनांक</th>
                                <th>टाइटल (Title)</th>
                                <th>कंटेंट (Content)</th>
                                <th>वर्ग (Target)</th>
                                <th>एक्शन</th>
                            </tr>
                        </thead>
                        <tbody id="noticesBody"><!-- JS Populated --></tbody>
                    </table>
                </div>
            </div>

            <!-- NEW: ID CARDS & FEES SECTION -->
            <div id="section-id-cards-fees" class="section-card">
                <div class="header-flex">
                    <h2>ID कार्ड और शुल्क प्रबंधन (ID Cards & Fees Management)</h2>
                    <div style="display:flex; gap:10px;">
                        <button onclick="loadIDCardsFeesData()" class="btn btn-sm btn-primary"><i
                                class="fa-solid fa-arrows-rotate"></i> Refresh</button>
                        <button onclick="batchPrintIDCards()" class="btn btn-sm btn-success"><i
                                class="fa-solid fa-print"></i> Batch Print IDs</button>
                    </div>
                </div>

                <div class="stats-grid" style="margin-bottom:20px;">
                    <div class="stat-box" style="border-left-color: #28a745;">
                        <h3 id="feeStatPaid">₹0</h3>
                        <p>Total Collection</p>
                    </div>
                    <div class="stat-box" style="border-left-color: #ffc107;">
                        <h3 id="feeStatPending">0</h3>
                        <p>Pending Payments</p>
                    </div>
                    <div class="stat-box" style="border-left-color: #17a2b8;">
                        <h3 id="feeStatCards">0</h3>
                        <p>IDs to Generate</p>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="idCardsFeesTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>नाम (Name)</th>
                                <th>सदस्य ID</th>
                                <th>शुल्क (Fee) Status</th>
                                <th>ID Card Status</th>
                                <th>एक्शन (Actions)</th>
                            </tr>
                        </thead>
                        <tbody><!-- JS Populated --></tbody>
                    </table>
                </div>
            </div>

            <!-- 2. MEMBERS MANAGEMENT -->
            <div id="section-members" class="section-card">
                <div class="header-flex">
                    <h2>पंजीकृत सदस्य (Registered Members)</h2>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="searchMembers" onkeyup="filterTables('membersTable', 'searchMembers')"
                            placeholder="Search names or mobile..."
                            style="padding:5px 10px; border-radius:4px; border:1px solid #ccc;">
                        <button onclick="openAddMemberModal()" class="btn btn-success"><i
                                class="fa-solid fa-user-plus"></i> नया
                            सदस्य</button>
                        <button onclick="window.print()" class="btn btn-warning"><i class="fa-solid fa-print"></i>
                            प्रिंट</button>
                        <button onclick="downloadMembersPDF()" class="btn"
                            style="background-color: #dc3545; color: white;"><i class="fa-solid fa-file-pdf"></i>
                            PDF</button>
                        <button onclick="downloadMembersExcel()" class="btn"
                            style="background-color: #28a745; color: white;"><i class="fa-solid fa-file-excel"></i>
                            Excel</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="membersTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>फोटो</th>
                                <th>नाम</th>
                                <th>मोबाइल</th>
                                <th>विभाग</th>
                                <th>पद</th>
                                <th>जिला</th>
                                <th>दिनांक</th>
                                <th>एक्शन</th>
                            </tr>
                        </thead>
                        <tbody><!-- JS Populated --></tbody>
                    </table>
                </div>
            </div>

            <!-- 3. OFFICERS MANAGEMENT -->
            <div id="section-officers" class="section-card">
                <div class="header-flex" style="flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin-right: auto;">पदाधिकारी प्रबंधन (Manage Officers)</h2>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="downloadOfficersPDF()" class="btn"
                            style="background-color: #dc3545; color: white;"><i class="fa-solid fa-file-pdf"></i>
                            PDF</button>
                        <button onclick="downloadOfficersExcel()" class="btn"
                            style="background-color: #28a745; color: white;"><i class="fa-solid fa-file-excel"></i>
                            Excel</button>
                        <input type="text" id="searchOfficers" onkeyup="loadDashboardData()"
                            placeholder="Search name/mobile..."
                            style="padding:5px 10px; border-radius:4px; border:1px solid #ccc; width: 180px;">

                        <select id="filterOffDivision" onchange="handleFilterLocationChange()"
                            style="padding:5px 10px; border-radius:4px; border:1px solid #ccc;">
                            <option value="">-- मंडल (Division) --</option>
                            <option value="Agra">Agra (आगरा)</option>
                            <option value="Aligarh">Aligarh (अलीगढ़)</option>
                            <option value="Ayodhya">Ayodhya (अयोध्या)</option>
                            <option value="Azamgarh">Azamgarh (आजमगढ़)</option>
                            <option value="Bareilly">Bareilly (बरेली)</option>
                            <option value="Basti">Basti (बस्ती)</option>
                            <option value="Chitrakoot">Chitrakoot (चित्रकूट)</option>
                            <option value="Devipatan">Devipatan (देवीपाटन)</option>
                            <option value="Gorakhpur">Gorakhpur (गोरखपुर)</option>
                            <option value="Jhansi">Jhansi (झांसी)</option>
                            <option value="Kanpur">Kanpur (कानपुर)</option>
                            <option value="Lucknow">Lucknow (लखनऊ)</option>
                            <option value="Meerut">Meerut (मेरठ)</option>
                            <option value="Mirzapur">Mirzapur (मिर्जापुर)</option>
                            <option value="Moradabad">Moradabad (मुरादाबाद)</option>
                            <option value="Prayagraj">Prayagraj (प्रयागराज)</option>
                            <option value="Saharanpur">Saharanpur (सहारनपुर)</option>
                            <option value="Varanasi">Varanasi (वाराणसी)</option>
                        </select>

                        <select id="filterOffDistrict" onchange="loadDashboardData()"
                            style="padding:5px 10px; border-radius:4px; border:1px solid #ccc;">
                            <option value="">-- जिला (District) --</option>
                        </select>

                        <button onclick="resetOfficerFilters()" class="btn btn-sm btn-secondary" title="Reset Filters">
                            <i class="fa-solid fa-undo"></i>
                        </button>
                    </div>
                </div>

                <!-- Add Officer Form -->
                <div class="form-row">
                    <input type="text" id="offName" placeholder="नाम (Name)" style="flex:1;">
                    <input type="text" id="offFather" placeholder="पिता का नाम (Father's Name)" style="flex:1;">
                    <div style="flex:1; position:relative;">
                        <input type="text" id="offVibhag" list="vibhag_list" onchange="handleVibhagChange('add')"
                            placeholder="विभाग चुनें/खोजें (Vibhag)"
                            style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;">
                        <datalist id="vibhag_list">
                            <!-- JS Populated -->
                        </datalist>
                    </div>
                </div>
                <div class="form-row" style="margin-top:-10px;">
                    <select id="offPost" style="flex:1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">-- पद चुनें (Post) --</option>
                    </select>
                    <input type="text" id="offMobile" placeholder="User ID / Mobile" style="flex:1;">
                    <input type="text" id="offPass" placeholder="Password" style="flex:1;">
                    <select id="offRole" onchange="handleRoleChange('add')"
                        style="flex:1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="State Admin">प्रदेश एडमिन (State Admin)</option>
                        <option value="Division Admin">मंडल एडमिन (Division Admin)</option>
                        <option value="District Admin">जिला एडमिन (District Admin)</option>
                        <option value="Block Admin">ब्लॉक एडमिन (Block Admin)</option>
                        <option value="Officer" selected>सिमित पहुँच (Regular Officer)</option>
                    </select>
                </div>
                <div class="form-row" style="margin-top:-10px;">
                    <select id="offDivision" onchange="handleLocationChange('add', 'division')"
                        style="flex:1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">-- मंडल चुनें (Division) --</option>
                        <option value="Agra">Agra (आगरा)</option>
                        <option value="Aligarh">Aligarh (अलीगढ़)</option>
                        <option value="Ayodhya">Ayodhya (अयोध्या)</option>
                        <option value="Azamgarh">Azamgarh (आजमगढ़)</option>
                        <option value="Bareilly">Bareilly (बरेली)</option>
                        <option value="Basti">Basti (बस्ती)</option>
                        <option value="Chitrakoot">Chitrakoot (चित्रकूट)</option>
                        <option value="Devipatan">Devipatan (देवीपाटन)</option>
                        <option value="Gorakhpur">Gorakhpur (गोरखपुर)</option>
                        <option value="Jhansi">Jhansi (झांसी)</option>
                        <option value="Kanpur">Kanpur (कानपुर)</option>
                        <option value="Lucknow">Lucknow (लखनऊ)</option>
                        <option value="Meerut">Meerut (मेरठ)</option>
                        <option value="Mirzapur">Mirzapur (मिर्जापुर)</option>
                        <option value="Moradabad">Moradabad (मुरादाबाद)</option>
                        <option value="Prayagraj">Prayagraj (प्रयागराज)</option>
                        <option value="Saharanpur">Saharanpur (सहारनपुर)</option>
                        <option value="Varanasi">Varanasi (वाराणसी)</option>
                    </select>
                    <select id="offDistrict" onchange="handleLocationChange('add', 'district')"
                        style="flex:1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">-- जिला चुनें (District) --</option>
                    </select>
                    <select id="offBlock" style="flex:1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">-- ब्लॉक चुनें (Block) --</option>
                    </select>
                </div>
                <div class="form-row" style="margin-top:-10px;">
                    <input type="text" id="offAddress" placeholder="पता (Address)" style="flex:1;">
                    <div style="flex:1; display:flex; gap:10px; align-items:center;">
                        <label style="font-size:0.8rem;">फोटो:</label>
                        <input type="file" id="offPhoto" accept="image/*" style="font-size:0.7rem;">
                    </div>
                    <div style="flex:1; display:flex; gap:10px; align-items:center;">
                        <label style="font-size:0.8rem;">हस्ताक्षर:</label>
                        <input type="file" id="offSign" accept="image/*" style="font-size:0.7rem;">
                    </div>
                    <button onclick="addOfficer()" class="btn btn-primary" style="flex:0 0 100px;"><i
                            class="fa-solid fa-plus"></i> जोड़ें</button>
                </div>

                <div class="table-responsive">
                    <table id="officersTable">
                        <thead>
                            <tr>
                                <th>नाम (Name)</th>
                                <th>पद (Post)</th>
                                <th>पहुँच (Role/Hierarchy)</th>
                                <th>मीडिया (Photo/Sign)</th>
                                <th>लॉगिन (ID / Pass)</th>
                                <th>एक्शन (Action)</th>
                            </tr>
                        </thead>
                        <tbody><!-- JS Populated --></tbody>
                    </table>
                </div>
            </div>

            <!-- Edit Officer Modal -->
            <div id="editOfficerModal"
                style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
                <div
                    style="background:white; padding:20px; border-radius:10px; width:95%; max-width:700px; max-height: 90vh; overflow-y: auto;">
                    <h3>Edit Officer</h3>
                    <input type="hidden" id="editOffId">
                    <div class="modal-body">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                            <input type="text" id="editOffName" placeholder="Full Name" style="padding:8px;">

                            <div style="grid-column: span 2; display: flex; gap: 10px;">
                                <input type="text" id="editOffVibhag" list="vibhag_list_edit"
                                    onchange="handleVibhagChange('edit')" placeholder="विभाग (Department)"
                                    style="flex:1; padding:8px;">
                                <datalist id="vibhag_list_edit">
                                    <!-- JS Populated -->
                                </datalist>
                                <select id="editOffPost" style="flex:1; padding:8px;">
                                    <option value="">-- पद चुनें (Post) --</option>
                                </select>
                            </div>

                            <input type="text" id="editOffFather" placeholder="Father Name" style="padding:8px;">
                            <input type="text" id="editOffMobile" placeholder="Mobile / User ID" style="padding:8px;">
                            <input type="text" id="editOffPass" placeholder="Password" style="padding:8px;">
                            <select id="editOffRole" onchange="handleRoleChange('edit')" style="padding: 8px;">
                                <option value="State Admin">प्रदेश एडमिन (State Admin)</option>
                                <option value="Division Admin">मंडल एडमिन (Division Admin)</option>
                                <option value="District Admin">जिला एडमिन (District Admin)</option>
                                <option value="Block Admin">ब्लॉक एडमिन (Block Admin)</option>
                                <option value="Officer">सिमित पहुँच (Regular Officer)</option>
                            </select>
                            <select id="editOffDivision" onchange="handleLocationChange('edit', 'division')"
                                style="padding: 8px;">
                                <option value="">-- मंडल चुनें (Division) --</option>
                                <option value="Agra">Agra (आगरा)</option>
                                <option value="Aligarh">Aligarh (अलीगढ़)</option>
                                <option value="Ayodhya">Ayodhya (अयोध्या)</option>
                                <option value="Azamgarh">Azamgarh (आजमगढ़)</option>
                                <option value="Bareilly">Bareilly (बरेली)</option>
                                <option value="Basti">Basti (बस्ती)</option>
                                <option value="Chitrakoot">Chitrakoot (चित्रकूट)</option>
                                <option value="Devipatan">Devipatan (देवीपाटन)</option>
                                <option value="Gorakhpur">Gorakhpur (गोरखपुर)</option>
                                <option value="Jhansi">Jhansi (झांसी)</option>
                                <option value="Kanpur">Kanpur (कानपुर)</option>
                                <option value="Lucknow">Lucknow (लखनऊ)</option>
                                <option value="Meerut">Meerut (मेरठ)</option>
                                <option value="Mirzapur">Mirzapur (मिर्जापुर)</option>
                                <option value="Moradabad">Moradabad (मुरादाबाद)</option>
                                <option value="Prayagraj">Prayagraj (प्रयागराज)</option>
                                <option value="Saharanpur">Saharanpur (सहारनपुर)</option>
                                <option value="Varanasi">Varanasi (वाराणसी)</option>
                            </select>
                            <select id="editOffDistrict" onchange="handleLocationChange('edit', 'district')"
                                style="padding: 8px;">
                                <option value="">-- जिला चुनें (District) --</option>
                            </select>
                            <select id="editOffBlock" style="padding: 8px;">
                                <option value="">-- ब्लॉक चुनें (Block) --</option>
                            </select>
                            <input type="text" id="editOffAddress" placeholder="Address" style="padding:8px;">
                        </div>
                        <div style="display: flex; gap: 20px; margin-top: 15px;">
                            <div style="flex:1;">
                                <label style="font-size:0.8rem;">फोटो अपडेट:</label>
                                <input type="file" id="editOffPhoto" accept="image/*"
                                    style="font-size:0.7rem; width: 100%;">
                            </div>
                            <div style="flex:1;">
                                <label style="font-size:0.8rem;">हस्ताक्षर अपडेट:</label>
                                <input type="file" id="editOffSign" accept="image/*"
                                    style="font-size:0.7rem; width: 100%;">
                            </div>
                        </div>
                        <div
                            style="margin-top:20px; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
                            <button onclick="document.getElementById('editOfficerModal').style.display='none'"
                                class="btn btn-secondary" style="background:#6c757d;">Cancel</button>
                            <button onclick="saveOfficerEdit()" class="btn btn-success">Update</button>
                        </div>
                    </div>
                </div>

                <!-- 4. ISSUES VIEW -->
                <div id="section-issues" class="section-card">
                    <div class="header-flex">
                        <h2>समस्याएं और सुझाव (User Issues)</h2>
                        <input type="text" id="searchIssues" onkeyup="filterTables('issuesTable', 'searchIssues')"
                            placeholder="Search issues..."
                            style="padding:5px 10px; border-radius:4px; border:1px solid #ccc;">
                    </div>
                    <div class="table-responsive">
                        <table id="issuesTable">
                            <thead>
                                <tr>
                                    <th>दिनांक</th>
                                    <th>नाम</th>
                                    <th>मोबाइल</th>
                                    <th>विषय (Subject)</th>
                                    <th>विवरण (Description)</th>
                                    <th>स्थिति (Status)</th>
                                    <th>एक्शन</th>
                                </tr>
                            </thead>
                            <tbody><!-- JS Populated --></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. REPORTS MODULE -->
            <div id="section-reports" class="section-card">
                <div class="tab-container">
                    <div class="tab-item active" id="tab-monthly" onclick="switchReportTab('monthly')">मासिक रिपोर्ट
                        (Monthly
                        Reports)</div>
                    <div class="tab-item" id="tab-finance" onclick="switchReportTab('finance')">वित्तीय रिपोर्ट
                        (Financial
                        Reports)</div>
                </div>

                <!-- SUB-SECTION: MONTHLY REPORTS -->
                <div id="report-view-monthly" class="tab-content active">
                    <div class="header-flex">
                        <h2>मासिक पंजीकरण रिपोर्ट (Monthly Registration Reports)</h2>
                        <div
                            style="display:flex; flex-wrap:wrap; gap:10px; background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #eee; margin-bottom:15px;">
                            <select id="reportFilterMonth" onchange="loadReportsData()"
                                style="padding:8px; border-radius:4px; border:1px solid #ccc; flex:1; min-width:150px;">
                                <option value="">-- महीना (Month) --</option>
                                <option value="2024-01">January 2024</option>
                                <option value="2024-02">February 2024</option>
                                <option value="2024-03">March 2024</option>
                            </select>
                            <select id="reportFilterLevel" onchange="handleReportLevelChange()"
                                style="padding:8px; border-radius:4px; border:1px solid #ccc; flex:1; min-width:150px; font-weight:bold; background:#fffcea;">
                                <option value="State">-- स्तर: State --</option>
                                <option value="Division">-- स्तर: Division --</option>
                                <option value="District">-- स्तर: District --</option>
                                <option value="Block">-- स्तर: Block --</option>
                            </select>
                            <select id="reportFilterDivision" onchange="handleReportLocationChange('division')"
                                style="padding:8px; border-radius:4px; border:1px solid #ccc; flex:1; min-width:150px;">
                                <option value="">-- मंडल (Division) --</option>
                                <option value="Agra">Agra</option>
                                <option value="Aligarh">Aligarh</option>
                                <option value="Ayodhya">Ayodhya</option>
                                <option value="Azamgarh">Azamgarh</option>
                                <option value="Bareilly">Bareilly</option>
                                <option value="Basti">Basti</option>
                                <option value="Chitrakoot">Chitrakoot</option>
                                <option value="Devipatan">Devipatan</option>
                                <option value="Gorakhpur">Gorakhpur</option>
                                <option value="Jhansi">Jhansi</option>
                                <option value="Kanpur">Kanpur</option>
                                <option value="Lucknow">Lucknow</option>
                                <option value="Meerut">Meerut</option>
                                <option value="Mirzapur">Mirzapur</option>
                                <option value="Moradabad">Moradabad</option>
                                <option value="Prayagraj">Prayagraj</option>
                                <option value="Saharanpur">Saharanpur</option>
                                <option value="Varanasi">Varanasi</option>
                            </select>
                            <select id="reportFilterDistrict" onchange="handleReportLocationChange('district')"
                                style="padding:8px; border-radius:4px; border:1px solid #ccc; flex:1; min-width:150px;">
                                <option value="">-- जिला (District) --</option>
                            </select>
                            <select id="reportFilterBlock" onchange="loadReportsData()"
                                style="padding:8px; border-radius:4px; border:1px solid #ccc; flex:1; min-width:150px;">
                                <option value="">-- ब्लॉक (Block) --</option>
                            </select>
                            <button onclick="resetReportFilters()" class="btn btn-sm btn-secondary"
                                title="Reset Filters"><i class="fa-solid fa-rotate-left"></i></button>
                            <button onclick="generateMockReports()" class="btn btn-sm btn-info"><i
                                    class="fa-solid fa-plus"></i>
                                डमी (Mock)</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="reportsTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>महीना (Month)</th>
                                    <th>रिपोर्ट स्तर (Level)</th>
                                    <th>स्थान (Location)</th>
                                    <th>कुल सदस्य</th>
                                    <th>सक्रिय सदस्य</th>
                                    <th>एक्शन</th>
                                </tr>
                            </thead>
                            <tbody><!-- JS Populated --></tbody>
                        </table>
                    </div>
                </div>

                <!-- SUB-SECTION: FINANCIAL REPORTS -->
                <div id="report-view-finance" class="tab-content">
                    <div class="header-flex">
                        <h2>यूनियन वित्तीय स्थिति (Union Financial Status)</h2>
                        <div
                            style="display:flex; flex-wrap:wrap; gap:10px; background:#fafff8; padding:15px; border-radius:8px; border:1px solid #eee; margin-bottom:15px;">
                            <select id="financeFilterLevel" onchange="handleFinanceLevelChange()"
                                style="padding:8px; border-radius:4px; border:1px solid #ccc; flex:1; min-width:150px; font-weight:bold; background:#fffcea;">
                                <option value="State">-- स्तर: State --</option>
                                <option value="Division">-- स्तर: Division --</option>
                                <option value="District">-- स्तर: District --</option>
                                <option value="Block">-- स्तर: Block --</option>
                            </select>
                            <select id="financeFilterDivision" onchange="handleFinanceLocationChange('division')"
                                style="padding:8px; border-radius:4px; border:1px solid #ccc; flex:1; min-width:150px;">
                                <option value="">-- मंडल (Division) --</option>
                                <option value="Agra">Agra</option>
                                <option value="Aligarh">Aligarh</option>
                                <option value="Ayodhya">Ayodhya</option>
                                <option value="Azamgarh">Azamgarh</option>
                                <option value="Bareilly">Bareilly</option>
                                <option value="Basti">Basti</option>
                                <option value="Chitrakoot">Chitrakoot</option>
                                <option value="Devipatan">Devipatan</option>
                                <option value="Gorakhpur">Gorakhpur</option>
                                <option value="Jhansi">Jhansi</option>
                                <option value="Kanpur">Kanpur</option>
                                <option value="Lucknow">Lucknow</option>
                                <option value="Meerut">Meerut</option>
                                <option value="Mirzapur">Mirzapur</option>
                                <option value="Moradabad">Moradabad</option>
                                <option value="Prayagraj">Prayagraj</option>
                                <option value="Saharanpur">Saharanpur</option>
                                <option value="Varanasi">Varanasi</option>
                            </select>
                            <select id="financeFilterDistrict" onchange="handleFinanceLocationChange('district')"
                                style="padding:8px; border-radius:4px; border:1px solid #ccc; flex:1; min-width:150px;">
                                <option value="">-- जिला (District) --</option>
                            </select>
                            <select id="financeFilterBlock" onchange="loadFinanceData()"
                                style="padding:8px; border-radius:4px; border:1px solid #ccc; flex:1; min-width:150px;">
                                <option value="">-- ब्लॉक (Block) --</option>
                            </select>
                            <button onclick="resetFinanceFilters()" class="btn btn-sm btn-secondary"
                                title="Reset Filters"><i class="fa-solid fa-rotate-left"></i></button>
                            <button onclick="generateMockFinanceData()" class="btn btn-sm btn-info"><i
                                    class="fa-solid fa-coins"></i> डमी (Mock)</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="financeTable">
                            <thead>
                                <tr>
                                    <th>रिपोर्ट स्तर (Level)</th>
                                    <th>स्थान (Month/Location)</th>
                                    <th>कुल आय (Income)</th>
                                    <th>कुल खर्च (Expense)</th>
                                    <th>बचत (Net Balance)</th>
                                    <th>एक्शन</th>
                                </tr>
                            </thead>
                            <tbody><!-- JS Populated --></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script src="script.js?v=4"></script>
    <script>
        // --- GLOBAL DATA VARIABLES (In-Memory) ---
        window.allMembers = [];
        window.allOfficers = [];
        window.allIssues = [];
        window.allRequests = [];
        window.allNotices = [];
        window.allMedia = [];
        window.allDocs = [];
        window.allComplaints = [];

        // --- FIREBASE INIT & SYNC (ADMIN) ---
        if (!firebase.apps.length) {
            firebase.initializeApp(window.firebaseConfig);
        }
        window.db = firebase.firestore();
        console.log("Firebase Admin Initialized");

        // Clear Bloated LocalStorage (Fix Quota Issue)
        try {
            const keysToRemove = ['up_sangh_members', 'up_sangh_officers', 'up_sangh_issues', 'up_sangh_media'];
            keysToRemove.forEach(k => localStorage.removeItem(k));
            console.log("Cleaned up bloated LocalStorage keys.");
        } catch (e) {
            console.warn("Error clearing LocalStorage:", e);
        }

        // Real-time Listeners for Admin Dashboard
        if (window.db) {
            // Members Sync
            window.db.collection("members").onSnapshot(snapshot => {
                window.allMembers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.firestoreId = doc.id;
                    window.allMembers.push(data);
                });

                if (window.loadDashboardData) window.loadDashboardData();
                if (window.loadIDCardsFeesData) window.loadIDCardsFeesData();
            });

            // Officers Sync
            window.db.collection("officers").onSnapshot(snapshot => {
                window.allOfficers = [];
                snapshot.forEach(doc => window.allOfficers.push(doc.data()));

                if (window.loadDashboardData) window.loadDashboardData();
            });

            // Issues Sync
            window.db.collection("issues").onSnapshot(snapshot => {
                window.allIssues = [];
                snapshot.forEach(doc => window.allIssues.push(doc.data()));

                if (window.loadDashboardData) window.loadDashboardData();
            });

            // Requests Sync
            window.db.collection("requests").onSnapshot(snapshot => {
                window.allRequests = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    d.firestoreId = doc.id;
                    window.allRequests.push(d);
                });

                if (window.loadDashboardData) window.loadDashboardData();
            });

            // Notices Sync
            window.db.collection("notices").onSnapshot(snapshot => {
                window.allNotices = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    d.firestoreId = doc.id;
                    window.allNotices.push(d);
                });

                if (window.loadNoticesData) window.loadNoticesData();
            });

            // Media Sync
            window.db.collection("media").onSnapshot(snapshot => {
                window.allMedia = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    d.firestoreId = doc.id;
                    window.allMedia.push(d);
                });

                if (window.loadMediaGallery) window.loadMediaGallery();
            });

            // Documents Sync
            window.db.collection("documents").onSnapshot(snapshot => {
                window.allDocs = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    d.firestoreId = doc.id;
                    window.allDocs.push(d);
                });

                if (window.loadDocumentsData) window.loadDocumentsData();
            });

            // Complaints Sync
            window.db.collection("complaints").onSnapshot(snapshot => {
                window.allComplaints = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    d.firestoreId = doc.id;
                    window.allComplaints.push(d);
                });

                if (window.loadComplaintsData) window.loadComplaintsData();
            });
        }


        // Global Error Handler for Debugging
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            console.error('Window Error:', msg, 'Line:', lineNo);
            return false;
        };

        // --- REPORTS DATA LOGIC --- //
        window.generateMockReports = function () {
            const months = ['2024-01', '2024-02', '2024-03'];
            const reports = [];
            let id = 1;

            months.forEach(m => {
                for (let div in locationData) {
                    locationData[div].districts.forEach(dist => {
                        reports.push({
                            id: id++,
                            month: m,
                            division: div,
                            district: dist,
                            total_members: Math.floor(Math.random() * 500) + 100,
                            active_members: Math.floor(Math.random() * 100) + 50,
                            status: 'Submitted'
                        });
                    });
                }
            });

            localStorage.setItem('up_sangh_reports', JSON.stringify(reports));
            alert('डमी रिपोर्ट जनरेट की गई!');
            loadReportsData();
        };

        // --- HIERARCHICAL REPORTING LOGIC --- //
        window.handleReportLevelChange = function () {
            const level = document.getElementById('reportFilterLevel').value;
            // Reset lower level selections
            if (level === 'State') {
                document.getElementById('reportFilterDivision').value = "";
                document.getElementById('reportFilterDistrict').innerHTML = '<option value="">-- जिला (District) --</option>';
                document.getElementById('reportFilterBlock').innerHTML = '<option value="">-- ब्लॉक (Block) --</option>';
            }
            loadReportsData();
        };

        window.handleReportLocationChange = function (level) {
            const div = document.getElementById('reportFilterDivision').value;
            const distSelect = document.getElementById('reportFilterDistrict');
            const blockSelect = document.getElementById('reportFilterBlock');

            if (level === 'division') {
                distSelect.innerHTML = '<option value="">-- जिला (District) --</option>';
                blockSelect.innerHTML = '<option value="">-- ब्लॉक (Block) --</option>';
                if (div && locationData[div]) {
                    locationData[div].districts.forEach(d => {
                        distSelect.innerHTML += `<option value="${d}">${d}</option>`;
                    });
                }
            } else if (level === 'district') {
                const dist = distSelect.value;
                blockSelect.innerHTML = '<option value="">-- ब्लॉक (Block) --</option>';
                if (dist && blockData[dist]) {
                    blockData[dist].forEach(b => {
                        blockSelect.innerHTML += `<option value="${b}">${b}</option>`;
                    });
                }
            }
            loadReportsData();
        };

        window.resetReportFilters = function () {
            document.getElementById('reportFilterMonth').value = "";
            document.getElementById('reportFilterLevel').value = "State";
            document.getElementById('reportFilterDivision').value = "";
            document.getElementById('reportFilterDistrict').innerHTML = '<option value="">-- जिला (District) --</option>';
            document.getElementById('reportFilterBlock').innerHTML = '<option value="">-- ब्लॉक (Block) --</option>';
            loadReportsData();
        };

        window.loadReportsData = function () {
            const members = window.allMembers || [];
            const filterMonth = document.getElementById('reportFilterMonth').value;
            const filterLevel = document.getElementById('reportFilterLevel').value;
            const filterDiv = document.getElementById('reportFilterDivision').value;
            const filterDist = document.getElementById('reportFilterDistrict').value;
            const filterBlock = document.getElementById('reportFilterBlock').value;

            const tbody = document.querySelector('#reportsTable tbody');
            if (!tbody) return;

            let itemsToDisplay = []; // { name, total, active, type }

            if (filterLevel === 'Block') {
                if (filterBlock) {
                    const mList = members.filter(m => (m.block === filterBlock || m.work_block === filterBlock));
                    itemsToDisplay.push({ name: filterBlock, total: mList.length, active: mList.filter(m => m.status === 'Approved').length, type: 'Block' });
                } else if (filterDist) {
                    const blocks = blockData[filterDist] || [];
                    blocks.forEach(b => {
                        const mList = members.filter(m => (m.home_district === filterDist || m.work_district === filterDist) && (m.block === b || m.work_block === b));
                        itemsToDisplay.push({ name: b, total: mList.length, active: mList.filter(m => m.status === 'Approved').length, type: 'Block' });
                    });
                } else {
                    // Show all blocks order by district maybe? For now just show "Select District" if no filter
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">कृपया जिला चुनें (Please select a District for Block report).</td></tr>';
                    return;
                }
            } else if (filterLevel === 'District') {
                if (filterDiv) {
                    const districts = locationData[filterDiv] ? locationData[filterDiv].districts : [];
                    districts.forEach(d => {
                        const mList = members.filter(m => (m.work_district === d || m.home_district === d));
                        itemsToDisplay.push({ name: d, total: mList.length, active: mList.filter(m => m.status === 'Approved').length, type: 'District' });
                    });
                } else {
                    // Show all districts
                    for (let div in locationData) {
                        locationData[div].districts.forEach(d => {
                            const mList = members.filter(m => (m.work_district === d || m.home_district === d));
                            itemsToDisplay.push({ name: d, total: mList.length, active: mList.filter(m => m.status === 'Approved').length, type: 'District' });
                        });
                    }
                }
            } else if (filterLevel === 'Division') {
                for (let div in locationData) {
                    const mList = members.filter(m => (m.division === div || (m.work_district && locationData[div].districts.includes(m.work_district))));
                    itemsToDisplay.push({ name: div, total: mList.length, active: mList.filter(m => m.status === 'Approved').length, type: 'Division' });
                }
            } else {
                // State Level
                const stateTotal = members.length;
                const stateActive = members.filter(m => m.status === 'Approved').length;
                itemsToDisplay.push({ name: "Uttar Pradesh (Total)", total: stateTotal, active: stateActive, type: 'State' });
            }

            let html = '';
            itemsToDisplay.forEach((item, i) => {
                const reportObj = {
                    id: i + 1,
                    month: filterMonth || 'All Time',
                    level: item.type,
                    location: item.name,
                    total_members: item.total,
                    active_members: item.active,
                    status: 'Verified'
                };

                html += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${reportObj.month}</td>
                        <td style="font-weight:bold; color:#007bff;">${item.type}</td>
                        <td>${item.name}</td>
                        <td style="font-weight:bold;">${item.total}</td>
                        <td style="color:green;">${item.active}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick='viewHierarchicalReport(${JSON.stringify(reportObj)})'><i class="fa-solid fa-eye"></i> View</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html || '<tr><td colspan="8" style="text-align:center;">No data found for this selection.</td></tr>';
        };

        window.viewHierarchicalReport = function (r) {
            try {
                let signatoryPost = "General Secretary";
                if (r.level === 'Division') signatoryPost = "Division President";
                if (r.level === 'District') signatoryPost = "District President";
                if (r.level === 'Block') signatoryPost = "Block President";

                const html = `
                <div class="invoice-header">
                    <div>
                        <div class="invoice-title">OFFICIAL REPORT: ${r.level.toUpperCase()} LEVEL</div>
                        <p style="margin:5px 0; color:#666;">उ.प्र. आउटसोर्सिंग एवं संविदा कर्मचारी संघ</p>
                    </div>
                    <div style="text-align:right;">
                        <img src="admin_logo.jpg" style="width:60px; height:60px; border-radius:50%; margin-bottom:5px;">
                        <div style="font-weight:bold;">Ref Code: #UP-${r.level[0]}-${new Date().getTime().toString().slice(-4)}</div>
                        <div style="font-weight:bold; color:#007bff;">${r.level}: ${r.location}</div>
                        <div>Date: ${new Date().toLocaleDateString('en-GB')}</div>
                    </div>
                </div>

                <div class="invoice-details">
                    <div style="border:1px solid #eee; padding:15px; border-radius:8px; background:#f0f7ff; flex:1;">
                        <h4 style="margin-top:0; color:#0056b3; border-bottom:1px solid #eee; padding-bottom:5px;">Geographic Information</h4>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Reporting Level:</span>
                            <span style="font-weight:bold;">${r.level}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Location Name:</span>
                            <span style="font-weight:bold;">${r.location}</span>
                        </div>
                    </div>
                    <div style="border:1px solid #eee; padding:15px; border-radius:8px; background:#f8fff9; flex:1;">
                        <h4 style="margin-top:0; color:#28a745; border-bottom:1px solid #eee; padding-bottom:5px;">Summary Period</h4>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Fiscal Month:</span>
                            <span style="font-weight:bold;">${r.month}</span>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom:10px; border-left:4px solid #007bff; padding-left:10px;">Membership Breakdown</h3>
                <table style="width:100%; border-collapse: collapse; margin-bottom: 20px; border:1px solid #eee;">
                    <thead>
                        <tr style="background:#f8f9fa;">
                            <th style="padding:15px; border-bottom:2px solid #007bff; text-align:left;">Category</th>
                            <th style="padding:15px; border-bottom:2px solid #007bff; text-align:right;">Headcount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding:15px; border-bottom:1px solid #eee;">Total Registered Members</td>
                            <td style="padding:15px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; font-size:1.1rem;">${r.total_members}</td>
                        </tr>
                        <tr>
                            <td style="padding:15px; border-bottom:1px solid #eee;">Verified Members (Active)</td>
                            <td style="padding:15px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; font-size:1.1rem; color:green;">${r.active_members}</td>
                        </tr>
                        <tr>
                            <td style="padding:15px; border-bottom:1px solid #eee;">Pending Verification</td>
                            <td style="padding:15px; border-bottom:1px solid #eee; text-align:right;">${r.total_members - r.active_members}</td>
                        </tr>
                    </tbody>
                </table>

                <div style="margin-top:50px; display:flex; justify-content:space-between; align-items:flex-end;">
                    <div style="font-size:0.8rem; color:#666;">
                        * This document is a digital record of UP Outsourcing Sangh.<br>
                        * Generated by Admin Panel System.<br>
                        * Jurisdiction: ${r.location}
                    </div>
                    <div style="text-align:center; width:200px;">
                        <div style="height:60px; border-bottom:2px solid #333; margin-bottom:8px;"></div>
                        <div style="font-size:0.9rem; font-weight:bold;">${signatoryPost}</div>
                        <div style="font-size:0.8rem; color:#444;">उ.प्र. आउटसोर्सिंग एवं संविदा कर्मचारी संघ</div>
                    </div>
                </div>
            `;
                document.getElementById('invoiceContent').innerHTML = html;
                document.getElementById('viewInvoiceModal').style.display = 'flex';
            } catch (err) {
                console.error("H-Report Error:", err);
                alert("विवरण लोड करने में समस्या आई!");
            }
        };

        // --- FINANCIAL HIERARCHY --- //
        window.handleFinanceLevelChange = function () {
            const level = document.getElementById('financeFilterLevel').value;
            if (level === 'State') {
                document.getElementById('financeFilterDivision').value = "";
                document.getElementById('financeFilterDistrict').innerHTML = '<option value="">-- जिला (District) --</option>';
                document.getElementById('financeFilterBlock').innerHTML = '<option value="">-- ब्लॉक (Block) --</option>';
            }
            loadFinanceData();
        };

        window.handleFinanceLocationChange = function (level) {
            const div = document.getElementById('financeFilterDivision').value;
            const distSelect = document.getElementById('financeFilterDistrict');
            const blockSelect = document.getElementById('financeFilterBlock');

            if (level === 'division') {
                distSelect.innerHTML = '<option value="">-- जिला (District) --</option>';
                blockSelect.innerHTML = '<option value="">-- ब्लॉक (Block) --</option>';
                if (div && locationData[div]) {
                    locationData[div].districts.forEach(d => {
                        distSelect.innerHTML += `<option value="${d}">${d}</option>`;
                    });
                }
            } else if (level === 'district') {
                const dist = distSelect.value;
                blockSelect.innerHTML = '<option value="">-- ब्लॉक (Block) --</option>';
                if (dist && blockData[dist]) {
                    blockData[dist].forEach(b => {
                        blockSelect.innerHTML += `<option value="${b}">${b}</option>`;
                    });
                }
            }
            loadFinanceData();
        };

        window.resetFinanceFilters = function () {
            document.getElementById('financeFilterLevel').value = "State";
            document.getElementById('financeFilterDivision').value = "";
            document.getElementById('financeFilterDistrict').innerHTML = '<option value="">-- जिला (District) --</option>';
            document.getElementById('financeFilterBlock').innerHTML = '<option value="">-- ब्लॉक (Block) --</option>';
            loadFinanceData();
        };

        window.loadFinanceData = function () {
            const financeData = JSON.parse(localStorage.getItem('up_sangh_finance')) || [];
            const members = window.allMembers || [];
            const filterLevel = document.getElementById('financeFilterLevel').value;
            const div = document.getElementById('financeFilterDivision').value;
            const dist = document.getElementById('financeFilterDistrict').value;
            const block = document.getElementById('financeFilterBlock').value;

            const tbody = document.querySelector('#financeTable tbody');
            if (!tbody) return;

            let displayData = [];

            if (filterLevel === 'State') {
                displayData = financeData.map(f => ({ ...f, level: "State" }));
            } else {
                // Determine granularity
                let itemsToAggregate = []; // { name, level }

                if (filterLevel === 'Block') {
                    if (block) {
                        itemsToAggregate.push({ name: block, level: 'Block' });
                    } else if (dist) {
                        const blocks = blockData[dist] || [];
                        blocks.forEach(b => itemsToAggregate.push({ name: b, level: 'Block' }));
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">कृपया जिला चुनें (Please select a District).</td></tr>';
                        return;
                    }
                } else if (filterLevel === 'District') {
                    if (div) {
                        const districts = locationData[div] ? locationData[div].districts : [];
                        districts.forEach(d => itemsToAggregate.push({ name: d, level: 'District' }));
                    } else {
                        for (let d in blockData) itemsToAggregate.push({ name: d, level: 'District' });
                    }
                } else if (filterLevel === 'Division') {
                    for (let d in locationData) itemsToAggregate.push({ name: d, level: 'Division' });
                }

                itemsToAggregate.forEach(item => {
                    let filteredMembers = members.filter(m => {
                        if (item.level === 'Block') return (m.block === item.name || m.work_block === item.name);
                        if (item.level === 'District') return (m.home_district === item.name || m.work_district === item.name);
                        if (item.level === 'Division') return (m.division === item.name || (m.work_district && locationData[item.name].districts.includes(m.work_district)));
                        return true;
                    });

                    // Calculate Membership Fee Income
                    const feeIncome = filteredMembers.reduce((sum, m) => sum + (parseFloat(m.membership_amount) || 0), 0);

                    // Calculate Approved Donations Income
                    const requests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
                    const donationIncome = requests.filter(r =>
                        r.type === 'Donation' &&
                        r.status === 'Approved' &&
                        (item.level === 'State' || filteredMembers.some(m => m.mobile === r.mobile))
                    ).reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);

                    const totalIncome = feeIncome + donationIncome;
                    const totalExpense = totalIncome * 0.2; // Mock expense 20%

                    displayData.push({
                        level: item.level,
                        month: item.name,
                        income: totalIncome,
                        fees: feeIncome,
                        donations: donationIncome,
                        expense: totalExpense,
                        balance: totalIncome - totalExpense,
                        cash: (totalIncome - totalExpense) * 0.9,
                        remarks: `Aggregate for ${item.name}`,
                        isHierarchical: true,
                        location: item.name
                    });
                });
            }


            let html = '';
            displayData.forEach(f => {
                html += `
                    <tr>
                        <td style="font-weight:bold; color:#28a745;">${f.level}</td>
                        <td><strong>${f.month}</strong></td>
                        <td style="color:green; font-weight:bold;">₹${f.income.toLocaleString()}</td>
                        <td style="color:red;">₹${f.expense.toLocaleString()}</td>
                        <td style="color:blue; font-weight:bold;">₹${f.balance.toLocaleString()}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="viewFinanceInvoice(${JSON.stringify(f)})"><i class="fa-solid fa-file-invoice"></i> View</button></td>
                    </tr>
                `;
            });
            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align:center;">No data found.</td></tr>';
        };

        window.viewFinanceInvoice = function (item) {
            try {
                const html = `
                <div class="invoice-header">
                    <div>
                        <div class="invoice-title">FINANCIAL REPORT</div>
                        <p style="margin:5px 0; color:#666;">उ.प्र. आउटसोर्सिंग एवं संविदा कर्मचारी संघ</p>
                    </div>
                    <div style="text-align:right;">
                        <img src="admin_logo.jpg" style="width:60px; height:60px; border-radius:50%; margin-bottom:5px;">
                        <div style="font-weight:bold; color:#007bff;">Report Level: ${item.level}</div>
                        <div style="font-weight:bold;">Location: ${item.location || 'State (Uttar Pradesh)'}</div>
                        <div style="font-weight:bold;">Period: ${item.month}</div>
                        <div>Date: ${new Date().toLocaleDateString('en-GB')}</div>
                    </div>
                </div>

                <div class="invoice-details">
                    <div style="border:1px solid #eee; padding:15px; border-radius:8px; flex:1;">
                        <h4 style="margin-top:0; color:#007bff; border-bottom:1px solid #eee; padding-bottom:5px;">Income Summary</h4>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Membership Fees:</span>
                            <span style="font-weight:bold;">₹${(item.fees || 0).toLocaleString()}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Donations (Sahyog):</span>
                            <span style="font-weight:bold;">₹${(item.donations || 0).toLocaleString()}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-top:10px; border-top:1px solid #eee; padding-top:5px;">
                            <span style="font-weight:bold;">Total Income:</span>
                            <span style="font-weight:bold; color:green;">₹${item.income.toLocaleString()}</span>
                        </div>
                    </div>
                    <div style="border:1px solid #eee; padding:15px; border-radius:8px; flex:1;">
                        <h4 style="margin-top:0; color:#dc3545; border-bottom:1px solid #eee; padding-bottom:5px;">Expense Summary</h4>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Operating Costs:</span>
                            <span style="font-weight:bold; color:red;">₹${item.expense.toLocaleString()}</span>
                        </div>
                    </div>
                </div>


                <table style="width:100%; border-collapse: collapse; margin-bottom: 20px; border:1px solid #eee;">
                    <tr style="background:#f8f9fa;">
                        <th style="padding:15px; border-bottom:2px solid #333;">Description</th>
                        <th style="padding:15px; border-bottom:2px solid #333; text-align:right;">Amount</th>
                    </tr>
                    <tr>
                        <td style="padding:12px; border-bottom:1px solid #eee;">Total Income (Praptee)</td>
                        <td style="padding:12px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; color:green;">₹${item.income.toLocaleString()}</td>
                    </tr>
                    <tr>
                        <td style="padding:12px; border-bottom:1px solid #eee;">Total Expenses (Vyay)</td>
                        <td style="padding:12px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; color:red;">₹${item.expense.toLocaleString()}</td>
                    </tr>
                    <tr style="background:#eef2f7;">
                        <td style="padding:15px; font-weight:bold; font-size:1.1rem;">NET BALANCE (Shesh)</td>
                        <td style="padding:15px; text-align:right; font-weight:bold; font-size:1.1rem; color:#007bff;">₹${item.balance.toLocaleString()}</td>
                    </tr>
                </table>
            `;
                document.getElementById('invoiceContent').innerHTML = html;
                document.getElementById('viewInvoiceModal').style.display = 'flex';
            } catch (err) {
                console.error("Finance View Error:", err);
                alert("वित्तीय विवरण लोड करने में त्रुटि!");
            }
        };

        // --- DASHBOARD NAVIGATION --- //
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section-card').forEach(el => el.classList.remove('active'));
            // Remove active class from sidebar links
            document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));

            // Show selected
            document.getElementById(`section-${sectionId}`).classList.add('active');
            const link = document.getElementById(`link-${sectionId}`);
            if (link) link.classList.add('active');

            // Persist for refresh
            localStorage.setItem('up_sangh_active_section_admin', sectionId);

            // Refresh data whenever section changes
            if (sectionId === 'members') loadMembers();
            if (sectionId === 'officers') loadOfficers();
            if (sectionId === 'issues') loadIssues();
            if (sectionId === 'reports') loadReportsData();
            if (sectionId === 'id-cards-fees') loadIDCardsFeesData();
            if (sectionId === 'complaints') loadComplaintsData();
            if (sectionId === 'media-gallery') loadMediaGallery();
            if (sectionId === 'settings') loadSystemSettings();
            if (sectionId === 'documents') loadDocumentsData();
            if (sectionId === 'roles') loadRolesData();
        }

        // --- DOCUMENTS MANAGEMENT LOGIC --- //
        window.loadDocumentsData = function () {
            const docs = window.allDocs || [];
            const tbody = document.querySelector('#documentsTable tbody');
            if (!tbody) return;

            tbody.innerHTML = docs.reverse().map(d => `
                <tr>
                    <td><i class="fa-solid fa-file-lines" style="color:#007bff;"></i> ${d.title}</td>
                    <td><span class="badge ${d.category === 'Govt Order' ? 'badge-primary' : 'badge-info'}">${d.category}</span></td>
                    <td>${d.date}</td>
                    <td>
                        <button onclick="downloadDocument(${d.id})" class="btn btn-sm btn-outline-info"><i class="fa-solid fa-download"></i></button>
                        <button onclick="deleteDocument(${d.id})" class="btn btn-sm btn-outline-danger"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="center-text">कोई दस्तावेज़ नहीं मिला।</td></tr>';
        };

        window.uploadDocument = async function () {
            const fileInput = document.getElementById('docFile');
            const titleInput = document.getElementById('docTitle');
            const catInput = document.getElementById('docCategory');
            const file = fileInput.files[0];

            if (!file) { alert("फाइल चुनें!"); return; }
            if (!titleInput.value) { alert("टाइटल लिखें!"); return; }

            const base64 = await readFile(file);
            const doc = {
                id: Date.now(),
                title: titleInput.value,
                category: catInput.value,
                data: base64,
                date: new Date().toLocaleDateString('hi-IN'),
                size: (file.size / 1024).toFixed(2) + ' KB'
            };

            window.db.collection('documents').add(doc).then(() => {
                alert('दस्तावेज़ अपलोड हो गया! (Cloud Upload)');
                fileInput.value = '';
                titleInput.value = '';
            }).catch(err => alert("Upload Error: " + err.message));
        };

        window.deleteDocument = async function (id) {
            if (!confirm('मिटाना चाहते हैं?')) return;
            const docs = JSON.parse(localStorage.getItem('up_sangh_docs')) || [];
            const d = docs.find(x => x.id === id);

            if (d && d.firestoreId) {
                window.db.collection('documents').doc(d.firestoreId).delete()
                    .then(() => alert("Deleted (Cloud)"));
            } else {
                const qs = await window.db.collection('documents').where('id', '==', id).get();
                if (!qs.empty) {
                    qs.docs[0].ref.delete().then(() => alert("Deleted (Cloud)"));
                } else {
                    let newDocs = docs.filter(x => x.id !== id);
                    localStorage.setItem('up_sangh_docs', JSON.stringify(newDocs));
                    loadDocumentsData();
                }
            }
        };

        window.downloadDocument = function (id) {
            const docs = JSON.parse(localStorage.getItem('up_sangh_docs')) || [];
            const doc = docs.find(d => d.id === id);
            if (!doc) return;
            const a = document.createElement('a');
            a.href = doc.data;
            a.download = doc.title;
            a.click();
        };

        // --- ROLES & ACCESS LOGIC --- //
        window.loadRolesData = function () {
            const officers = window.allOfficers || [];
            const tbody = document.querySelector('#rolesTable tbody');
            if (!tbody) return;

            tbody.innerHTML = officers.map(o => `
                <tr>
                    <td><strong>${o.name}</strong><br><small>${o.post}</small></td>
                    <td><span class="badge ${o.role === 'Admin' ? 'badge-danger' : 'badge-success'}">${o.role || 'Officer'}</span></td>
                    <td>
                        <select onchange="updateRole(${o.id}, this.value)" class="form-control" style="width:120px; font-size:0.8rem;">
                            <option value="Officer" ${o.role === 'Officer' ? 'selected' : ''}>Officer</option>
                            <option value="Admin" ${o.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            <option value="Operator" ${o.role === 'Operator' ? 'selected' : ''}>Operator</option>
                        </select>
                    </td>
                    <td><button class="btn btn-sm btn-link" onclick="viewPermissions('${o.role}')">View</button></td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="center-text">कोई अधिकारी नहीं मिला।</td></tr>';
        };

        window.updateRole = async function (id, newRole) {
            let officers = JSON.parse(localStorage.getItem('up_sangh_officers')) || [];
            const o = officers.find(o => o.id === id);
            if (o) {
                if (o.firestoreId) {
                    window.db.collection('officers').doc(o.firestoreId).update({ role: newRole })
                        .then(() => alert(`Role updated to ${newRole} (Cloud)`));
                } else {
                    const qs = await window.db.collection('officers').where('id', '==', id).get();
                    if (!qs.empty) {
                        qs.docs[0].ref.update({ role: newRole }).then(() => alert(`Role updated to ${newRole} (Cloud)`));
                    } else {
                        // Local fallback
                        o.role = newRole;
                        localStorage.setItem('up_sangh_officers', JSON.stringify(officers));
                        alert(`Role updated to ${newRole} (Local)`);
                        loadRolesData();
                    }
                }
            }
        };

        window.viewPermissions = function (role) {
            const perms = {
                'Admin': 'Full Access: Dashboard, Members, Officers, Reports, Finance, Settings, Roles, Documents, Media.',
                'Officer': 'Restricted Access: View Dashboard, Reports, and Registered Members for their location.',
                'Operator': 'Limited Access: Only member registration review and issue tracking.'
            };
            alert(`Permissions for ${role}:\n\n${perms[role] || 'Standard Access Level.'}`);
        };

        window.generateMockDocs = function () {
            const mocks = [
                { id: 101, title: 'Union Constitution 2025', category: 'Union Circular', date: '01/01/2025', data: 'data:text/plain;base64,VGVzdA==' },
                { id: 102, title: 'Minimum Wage Order Dec 2024', category: 'Govt Order', date: '15/12/2024', data: 'data:text/plain;base64,VGVzdA==' }
            ];
            localStorage.setItem('up_sangh_docs', JSON.stringify(mocks));
            alert("Mocks added!");
            loadDocumentsData();
        };

        // --- SYSTEM SETTINGS LOGIC --- //
        window.loadSystemSettings = function () {
            // Load Branding
            document.getElementById('settingUnionName').value = localStorage.getItem('up_sangh_name') || 'उत्तर प्रदेश आउटसोर्सिंग एवं संविदा कर्मचारी संघ';
            document.getElementById('settingTagline').value = localStorage.getItem('up_sangh_tagline') || 'संगठित शक्ति, सुरक्षित भविष्य';

            // Calc stats
            let totalSize = 0;
            for (let x in localStorage) {
                if (localStorage.hasOwnProperty(x)) {
                    totalSize += ((localStorage[x].length + x.length) * 2);
                }
            }
            document.getElementById('statTotalRecords').innerText = (totalSize / 1024).toFixed(2) + ' KB';
            document.getElementById('statLastBackup').innerText = new Date().toLocaleString('hi-IN');
        };

        window.updateAdminSecurity = function () {
            const p1 = document.getElementById('newAdminPass').value;
            const p2 = document.getElementById('confirmAdminPass').value;

            if (!p1 || !p2) { alert("कृपया पासवर्ड भरें!"); return; }
            if (p1 !== p2) { alert("पासवर्ड मैच नहीं हो रहे हैं!"); return; }

            localStorage.setItem('admin_password', p1);
            alert("एडमिन पासवर्ड सफलतापूर्वक अपडेट किया गया! (Password Updated)");
            document.getElementById('newAdminPass').value = '';
            document.getElementById('confirmAdminPass').value = '';
        };

        window.updateSystemBranding = function () {
            const name = document.getElementById('settingUnionName').value;
            const tagline = document.getElementById('settingTagline').value;
            const logoFile = document.getElementById('settingLogo').files[0];

            localStorage.setItem('up_sangh_name', name);
            localStorage.setItem('up_sangh_tagline', tagline);

            if (logoFile) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    localStorage.setItem('up_sangh_logo', e.target.result);
                    alert("ब्रांडिंग और लोगो सुरक्षित किए गए! (Branding & Logo Saved)");
                };
                reader.readAsDataURL(logoFile);
            } else {
                alert("ब्रांडिंग सेटिंग्स सुरक्षित की गईं! (Branding Saved)");
            }
        };

        window.exportSystemData = function () {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                data[key] = localStorage.getItem(key);
            }
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `UP_Sangh_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.importSystemData = function () {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            if (!file) { alert("कृपया बैकअप फाइल चुनें!"); return; }

            if (!confirm('चेतावनी: इंपोर्ट करने से वर्तमान डेटा ओवरराइट हो सकता है। क्या आप जारी रखना चाहते हैं?')) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    // Clear and set
                    // localStorage.clear(); // Careful: might clear session or other keys
                    for (let key in data) {
                        localStorage.setItem(key, data[key]);
                    }
                    alert("डेटा सफलतापूर्वक रिस्टोर किया गया! पेज रिफ्रेश हो रहा है...");
                    location.reload();
                } catch (err) {
                    alert("फाइल पढ़ने में त्रुटि! सही JSON फाइल चुनें।");
                }
            };
            reader.readAsText(file);
        };

        // --- MEDIA GALLERY LOGIC --- //
        window.loadMediaGallery = function () {
            const media = window.allMedia || [];
            const grid = document.getElementById('mediaGrid');
            if (!grid) return;

            let images = media.filter(m => m.type.startsWith('image')).length;
            let videos = media.filter(m => m.type.startsWith('video')).length;

            let html = '';
            media.reverse().forEach((m, i) => {
                const isVideo = m.type.startsWith('video');
                html += `
                    <div style="background:white; border:1px solid #eee; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.05); transition:transform 0.2s; position:relative;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="height:150px; background:#f0f0f0; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                            ${isVideo ?
                        `<video src="${m.data}" style="width:100%; height:100%; object-fit:cover;"></video>
                                 <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:white; font-size:2rem; text-shadow:0 2px 4px rgba(0,0,0,0.5);"><i class="fa-solid fa-play"></i></div>` :
                        `<img src="${m.data}" style="width:100%; height:100%; object-fit:cover;">`
                    }
                        </div>
                        <div style="padding:10px;">
                            <p style="margin:0; font-size:0.85rem; font-weight:600; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${m.caption}">${m.caption || 'No Caption'}</p>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                                <span style="font-size:0.7rem; color:#888;">${m.date}</span>
                                <button onclick="deleteMedia(${m.id})" class="btn btn-sm btn-danger" style="padding:2px 8px;"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html || '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#999;">कोई मीडिया नहीं मिला (No media found).</div>';

            // Stats
            document.getElementById('mediaStatTotal').innerText = media.length;
            document.getElementById('mediaStatImages').innerText = images;
            document.getElementById('mediaStatVideos').innerText = videos;
        };

        window.uploadMedia = async function () {
            const fileInput = document.getElementById('mediaFile');
            const captionInput = document.getElementById('mediaCaption');
            const file = fileInput.files[0];

            if (!file) { alert("कृपया फाइल चुनें! (Please select a file)"); return; }

            const base64 = await readFile(file);
            const mediaItem = {
                id: Date.now(),
                type: file.type,
                data: base64,
                caption: captionInput.value || file.name,
                date: new Date().toLocaleDateString('hi-IN')
            };

            window.db.collection('media').add(mediaItem).then(() => {
                alert("मीडिया सफलतापूर्वक जोड़ा गया! (Cloud Upload)");
                fileInput.value = '';
                captionInput.value = '';
            }).catch(err => alert("Error: " + err.message));
        };

        window.deleteMedia = async function (id) {
            if (!confirm('क्या आप इसे हटाना चाहते हैं?')) return;
            const media = JSON.parse(localStorage.getItem('up_sangh_media')) || [];
            const m = media.find(x => x.id === id);

            if (m && m.firestoreId) {
                window.db.collection('media').doc(m.firestoreId).delete()
                    .then(() => alert("Deleted (Cloud)"));
            } else {
                const qs = await window.db.collection('media').where('id', '==', id).get();
                if (!qs.empty) {
                    qs.docs[0].ref.delete().then(() => alert("Deleted (Cloud)"));
                } else {
                    let newMedia = media.filter(x => x.id !== id);
                    localStorage.setItem('up_sangh_media', JSON.stringify(newMedia));
                    loadMediaGallery();
                }
            }
        };

        window.generateMockMedia = function () {
            const mockMedia = [
                {
                    id: Date.now() + 1,
                    type: 'image/jpeg',
                    data: 'https://via.placeholder.com/400x300.png?text=Union+Meeting+1',
                    caption: 'यूनियन की पहली बैठक (First Union Meeting)',
                    date: new Date().toLocaleDateString('hi-IN')
                },
                {
                    id: Date.now() + 2,
                    type: 'image/jpeg',
                    data: 'https://via.placeholder.com/400x300.png?text=Protest+2024',
                    caption: 'अधिकारों के लिए प्रदर्शन (Protest for Rights)',
                    date: new Date().toLocaleDateString('hi-IN')
                },
                {
                    id: Date.now() + 3,
                    type: 'image/jpeg',
                    data: 'https://via.placeholder.com/400x300.png?text=Success+Celebration',
                    caption: 'सफलता का जश्न (Success Celebration)',
                    date: new Date().toLocaleDateString('hi-IN')
                }
            ];
            const existing = JSON.parse(localStorage.getItem('up_sangh_media')) || [];
            localStorage.setItem('up_sangh_media', JSON.stringify([...existing, ...mockMedia]));
            alert("डमी मीडिया जोड़ा गया! (Mock Media Added)");
            if (document.getElementById('section-media-gallery').classList.contains('active')) {
                loadMediaGallery();
            }
        };

        // --- UNION COMPLAINTS LOGIC --- //
        window.loadComplaintsData = function () {
            const complaints = window.allComplaints || [];
            const tbody = document.querySelector('#complaintsTable tbody');
            if (!tbody) return;

            let total = complaints.length;
            let pending = complaints.filter(c => c.status === 'Pending').length;
            let resolved = complaints.filter(c => c.status === 'Resolved').length;

            let html = '';
            complaints.reverse().forEach((c, i) => {
                html += `
                    <tr>
                        <td>${c.date || 'N/A'}</td>
                        <td><strong>${c.name}</strong><br><small>${c.mobile}</small></td>
                        <td>${c.dept || '--'}</td>
                        <td><span class="badge bg-secondary">${c.type}</span></td>
                        <td><div style="max-width:300px; font-size:0.85rem;">${c.message}</div></td>
                        <td><span class="badge ${c.status === 'Resolved' ? 'bg-success' : 'bg-warning'}">${c.status}</span></td>
                        <td>
                            <div style="display:flex; gap:5px;">
                                ${c.status === 'Pending' ? `<button class="btn btn-sm btn-success" onclick="resolveComplaint(${c.id})">Resolve</button>` : ''}
                                <button class="btn btn-sm btn-danger" onclick="deleteComplaint(${c.id})"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align:center;">No complaints found.</td></tr>';

            // Stats
            document.getElementById('complaintStatTotal').innerText = total;
            document.getElementById('complaintStatPending').innerText = pending;
            document.getElementById('complaintStatResolved').innerText = resolved;
        };

        window.resolveComplaint = async function (id) {
            if (!confirm('क्या आप इस शिकायत को हल (Resolved) मार्क करना चाहते हैं?')) return;

            const complaints = JSON.parse(localStorage.getItem('up_sangh_complaints')) || [];
            const c = complaints.find(c => c.id === id);

            if (c && c.firestoreId) {
                window.db.collection('complaints').doc(c.firestoreId).update({ status: 'Resolved' })
                    .then(() => alert("शिकायत हल की गई! (Cloud)"));
            } else {
                const qs = await window.db.collection('complaints').where('id', '==', id).get();
                if (!qs.empty) {
                    qs.docs[0].ref.update({ status: 'Resolved' }).then(() => alert("शिकायत हल की गई! (Cloud)"));
                } else {
                    // Local
                    const idx = complaints.findIndex(x => x.id === id);
                    if (idx !== -1) {
                        complaints[idx].status = 'Resolved';
                        localStorage.setItem('up_sangh_complaints', JSON.stringify(complaints));
                        alert("शिकायत हल की गई! (Local)");
                        loadComplaintsData();
                    }
                }
            }
        };

        window.deleteComplaint = async function (id) {
            if (!confirm('हटाना चाहते हैं?')) return;

            const complaints = JSON.parse(localStorage.getItem('up_sangh_complaints')) || [];
            const c = complaints.find(c => c.id === id);

            if (c && c.firestoreId) {
                window.db.collection('complaints').doc(c.firestoreId).delete()
                    .then(() => alert("Deleted (Cloud)"));
            } else {
                const qs = await window.db.collection('complaints').where('id', '==', id).get();
                if (!qs.empty) {
                    qs.docs[0].ref.delete().then(() => alert("Deleted (Cloud)"));
                } else {
                    let newComplaints = complaints.filter(x => x.id !== id);
                    localStorage.setItem('up_sangh_complaints', JSON.stringify(newComplaints));
                    loadComplaintsData();
                }
            }
        };

        window.generateMockComplaints = function () {
            const types = ["वेतन न मिलना", "उत्पीड़न / शोषण", "छुट्टी न मिलना", "नौकरी से निकालना", "भ्रष्टाचार"];
            const depts = ["Education", "Health", "Revenue", "Police", "PWD"];
            const mockData = [];
            for (let i = 0; i < 5; i++) {
                mockData.push({
                    id: Date.now() + i,
                    name: "User " + (i + 1),
                    mobile: "987654321" + i,
                    dept: depts[i % depts.length],
                    type: types[i % types.length],
                    message: "यह एक डमी शिकायत है। " + types[i % types.length] + " के संबंध में समस्या है।",
                    status: Math.random() > 0.5 ? 'Pending' : 'Resolved',
                    date: new Date().toLocaleDateString('hi-IN')
                });
            }
            localStorage.setItem('up_sangh_complaints', JSON.stringify(mockData));
            alert("डमी शिकायतें जनरेट की गई! (Mock Complaints Generated)");
            if (document.getElementById('section-complaints').classList.contains('active')) {
                loadComplaintsData();
            }
        };

        // --- ID CARDS & FEES LOGIC --- //
        window.loadIDCardsFeesData = function () {
            const members = window.allMembers || [];
            const tbody = document.querySelector('#idCardsFeesTable tbody');
            if (!tbody) return;

            let paidCount = 0;
            let pendingCount = 0;
            let cardsToGen = 0;
            let totalFee = 0;
            const FEE_AMOUNT = 99; // Standard fee

            let html = '';
            [...members].reverse().forEach((m, i) => {
                const fStatus = m.fee_status || 'Pending';
                const cStatus = m.id_card_status || 'Not Generated';

                if (fStatus === 'Paid') {
                    paidCount++;
                    totalFee += FEE_AMOUNT;
                } else {
                    pendingCount++;
                }

                if (cStatus !== 'Generated') {
                    cardsToGen++;
                }

                html += `
                    <tr>
                        <td>${i + 1}</td>
                        <td><strong>${m.name}</strong><br><small>${m.mobile}</small></td>
                        <td>${m.member_id || 'TEMP-' + m.id.toString().slice(-4)}</td>
                        <td><span class="badge ${fStatus === 'Paid' ? 'bg-success' : 'bg-warning'}">${fStatus}</span></td>
                        <td><span class="badge ${cStatus === 'Generated' ? 'bg-primary' : 'bg-secondary'}">${cStatus}</span></td>
                        <td>
                            <div style="display:flex; gap:3px; flex-wrap:wrap;">
                                <button onclick="viewIDCard(${m.id})" class="btn btn-xs btn-info" title="View ID Card"><i class="fa-solid fa-id-card"></i> View</button>
                                <button onclick="markFeePaid(${m.id})" class="btn btn-xs btn-success" ${fStatus === 'Paid' ? 'disabled' : ''} title="Mark Paid"><i class="fa-solid fa-check"></i></button>
                                <button onclick="openEditMember(${m.id})" class="btn btn-xs btn-primary" title="Edit Member"><i class="fa-solid fa-edit"></i></button>
                                <button onclick="deleteMember(${m.id})" class="btn btn-xs btn-danger" title="Delete Member"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center;">No member data found.</td></tr>';

            // Update Stats
            document.getElementById('feeStatPaid').innerText = '₹' + totalFee.toLocaleString();
            document.getElementById('feeStatPending').innerText = pendingCount;
            document.getElementById('feeStatCards').innerText = cardsToGen;
        };

        window.markFeePaid = function (id) {
            let members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
            const m = members.find(m => m.id === id);
            if (m && m.firestoreId) {
                window.db.collection('members').doc(m.firestoreId).update({
                    fee_status: 'Paid',
                    payment_date: new Date().toISOString()
                }).then(() => {
                    alert("शुल्क भुगतान सफल! (Fee Marked as Paid - Pending Sync)");
                }).catch(err => {
                    console.error("Error updating fee:", err);
                    alert("Error updating fee status");
                });
            } else {
                // Fallback for manually added mocks (no firestoreId)
                const idx = members.findIndex(m => m.id === id);
                if (idx !== -1) {
                    members[idx].fee_status = 'Paid';
                    members[idx].payment_date = new Date().toISOString();
                    localStorage.setItem('up_sangh_members', JSON.stringify(members));
                    alert("शुल्क भुगतान सफल! (Local Only)");
                    loadIDCardsFeesData();
                }
            }
        };

        window.viewIDCard = function (id) {
            const members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
            const m = members.find(x => x.id === id);
            if (!m) return;

            const logo = localStorage.getItem('up_sangh_logo') || 'admin_logo.jpg';
            const unionName = localStorage.getItem('up_sangh_name') || 'उ.प्र. आउटसोर्सिंग एवं संविदा कर्मचारी संघ';

            // Create verification data for QR code
            const verificationData = {
                id: m.id,
                member_id: m.member_id || `ID-${m.id}`,
                name: m.name,
                mobile: m.mobile,
                district: m.workDistrict || m.work_district,
                verified: true,
                union: 'UP Outsourcing & Contract Employees Union'
            };


            // Generate QR code URL using Google Charts API
            const qrData = encodeURIComponent(JSON.stringify(verificationData));
            const qrCodeUrl = `https://chart.googleapis.com/chart?cht=qr&chs=150x150&chl=${qrData}`;

            // Format DOB to DD/MM/YYYY
            const formatDate = (dateStr) => {
                if (!dateStr) return '--';
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr; // Return original if invalid
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            };
            const formattedDOB = formatDate(m.dob);

            const cardHtml = `
                <div style="width:420px; height:250px; border-radius:10px; border:2.5px solid #0056b3; background: linear-gradient(135deg, #fff 75%, #f0f7ff 100%); position:relative; overflow:hidden; font-family:'Inter', sans-serif; box-shadow: 0 6px 20px rgba(0,0,0,0.12); margin: 0 auto; padding:10px; box-sizing:border-box;">
                    <!-- Card Header -->
                    <div style="display:flex; align-items:center; gap:10px; border-bottom:2.5px solid #0056b3; padding-bottom:3px; margin-bottom:5px;">
                        <img src="${logo}" style="width:48px; height:48px; border-radius:50%; border:2.5px solid #0056b3; padding:2px; background:white; flex-shrink:0; margin-left:8px;">
                        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; text-align:center; padding-right:8px;">
                            <h5 style="margin:0; font-size:16.5px; color:#0056b3; font-weight:800; line-height:1.05; letter-spacing:-0.1px; white-space:nowrap;">${unionName}</h5>
                            <p style="margin:1px 0 0 0; font-size:9.5px; color:#c0392b; font-weight:700; text-transform:uppercase; line-height:1; letter-spacing:0.2px; white-space:nowrap;">U.P. OUTSOURCING & CONTRACT EMPLOYEES UNION</p>
                        </div>
                    </div>
                    
                    <!-- Card Body -->
                    <div style="display:flex; gap:12px;">
                        <!-- Left: Photo -->
                        <div style="text-align:center; width:100px; flex-shrink:0;">
                            ${m.photo ? `<img src="${m.photo}" style="width:98px; height:108px; border:2px solid #0056b3; border-radius:5px; object-fit:cover; box-shadow:0 2px 8px rgba(0,0,0,0.1);">` : `<div style="width:98px; height:108px; border:2px solid #ddd; border-radius:5px; background:#f9f9f9; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-user" style="font-size:40px; color:#ccc;"></i></div>`}
                            <div style="margin-top:4px; padding:3px 5px; background:linear-gradient(135deg, #0056b3, #003d82); color:white; font-size:10px; border-radius:4px; font-weight:bold; width:100%; box-sizing:border-box; box-shadow:0 2px 5px rgba(0,0,0,0.15);">${m.member_id || 'ID: ' + m.id.toString().slice(-4)}</div>
                        </div>
                        
                        <!-- Right: Details -->
                        <div style="flex:1; font-size:10px; line-height:1.35; color:#2c3e50;">
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">NAME:</strong> <span style="color:#000; font-weight:700; font-size:11px;">${m.name}</span></div>
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">FATHER'S:</strong> <span>${m.fatherName || m.fname || '--'}</span></div>
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">DOB:</strong> <span>${formattedDOB}</span></div>
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">DEPARTMENT:</strong> <span>${m.department || '--'}</span></div>
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">POST:</strong> <span>${m.post || '--'}</span></div>
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">DISTRICT:</strong> <span style="color:#c0392b; font-weight:700;">${m.workDistrict || m.work_district || '--'}</span></div>
                            <div style="margin-bottom:2.5px; display:flex;"><strong style="min-width:88px; color:#0056b3;">MOBILE:</strong> <span>${m.mobile}</span></div>
                            <div style="margin-top:2px; font-size:8.5px; line-height:1.3; max-height:30px; overflow:hidden; display:flex;"><strong style="min-width:88px; color:#0056b3; flex-shrink:0;">ADDRESS:</strong> <span style="color:#555; flex:1; word-wrap:break-word; overflow-wrap:break-word;">${m.home_address || m.address || '--'}</span></div>
                        </div>
                    </div>
                    
                    <!-- Footer: QR & Signature -->
                    <div style="position:absolute; bottom:8px; left:0; right:0; display:flex; justify-content:flex-end; align-items:flex-end; padding:0 18px;">
                        <!-- QR Code, Digital Seal & State President -->
                        <div style="text-align:center;">
                            <!-- QR Code -->
                            <img src="${qrCodeUrl}" style="width:48px; height:48px; display:block; margin:0 auto 3px; border:1px solid #ddd; border-radius:3px; padding:2px; background:white;">
                            <p style="margin:0 0 4px 0; font-size:6px; color:#666; font-weight:700; text-transform:uppercase; letter-spacing:0.2px;">Scan for Verification</p>
                            
                            <!-- Digital Seal -->
                            <img src="digital_seal.jpg" style="width:60px; height:60px; object-fit:contain; opacity:0.9;">
                            <div style="border-top:1.5px solid #333; width:105px; margin:0 auto;"></div>
                            <p style="margin:0; font-size:8px; font-weight:bold; color:#333; text-transform:uppercase; letter-spacing:0.2px;">प्रदेश अध्यक्ष</p>
                        </div>
                    </div>

                    <!-- Bottom Bar -->
                    <div style="position:absolute; bottom:0; left:0; width:100%; height:8px; background:linear-gradient(90deg, #0056b3, #003d82);"></div>
                </div>
            `;
            document.getElementById('idCardContent').innerHTML = cardHtml;
            document.getElementById('viewIDCardModal').style.display = 'flex';
        };

        window.printDiv = function (divId) {
            const printContents = document.getElementById(divId).innerHTML;
            const originalContents = document.body.innerHTML;
            document.body.innerHTML = `
                <style>
                    body { display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
                    @media print { .no-print { display: none; } }
                </style>
                ${printContents}
            `;
            window.print();
            location.reload(); // Quick way to restore original UI
        };

        window.downloadIDCardPDF = function () {
            if (typeof window.jspdf === 'undefined') {
                alert("jsPDF library not loaded.");
                return;
            }
            const { jsPDF } = window.jspdf;
            html2canvas(document.getElementById('idCardContent')).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('l', 'mm', 'a4');
                pdf.addImage(imgData, 'PNG', 10, 10, 85, 54); // ID card size approx 85x54mm
                pdf.save("ID_Card.pdf");
            });
        };

        window.printIDCard = function (id) {
            viewIDCard(id);
            setTimeout(() => {
                printDiv('idCardContent');
            }, 500);
        };

        window.batchPrintIDCards = function () {
            const members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
            const ready = members.filter(m => m.fee_status === 'Paid' && m.id_card_status !== 'Generated');
            if (ready.length === 0) {
                alert("प्रिंट करने के लिए कोई नया कार्ड नहीं है (No new paid cards to print).");
                return;
            }
            alert(ready.length + " कार्ड बैच प्रिंटिंग के लिए भेजे गए! (Sent to Batch Print)");
        };


        // --- DEPARTMENT & POST LOGIC --- //
        const vibhagData = {
            "शिक्षा विभाग (Education)": ["BSA", "ABSA", "शिक्षक (Teacher)", "शिक्षा मित्र", "अनुदेशक", "BEO", "क्लर्क"],
            "स्वास्थ्य विभाग (Health)": ["CMO", "ACMO", "चिकित्साधिकारी (Medical Officer)", "स्टाफ नर्स", "फार्मासिस्ट", "ANM", "CHO"],
            "राजस्व विभाग (Revenue)": ["तहसीलदार", "नायब तहसीलदार", "कानूनगो", "लेखपाल", "अमीन", "कलेक्टर क्लर्क"],
            "पुलिस विभाग (Police)": ["SP", "ASP", "CO", "इंस्पेक्टर", "सब-इंस्पेक्टर", "कांस्टेबल", "कंप्यूटर ऑपरेटर"],
            "पंचायती राज (Panchayati Raj)": ["DPRO", "ADPRO", "BDO", "ADO (Panchayat)", "VDO", "पंचायत सहायक"],
            "सिंचाई विभाग (Irrigation)": ["XEN", "SDO", "JE", "सींचपाल", "नलकूप चालक", "मेट"],
            "कृषि विभाग (Agriculture)": ["DAO", "AD0 (Ag)", "TA (Technical Assistant)", "ATM", "BTM", "किसान मित्र"],
            "नगर विकास (Urban Dev)": ["अधिशासी अधिकारी (EO)", "नगर आयुक्त", "सफाई निरीक्षक", "कर अधीक्षक", "जेई", "क्लर्क"],
            "पशुपालन (Animal Husbandry)": ["मुख्य पशु चिकित्साधिकारी", "पशु चिकित्साधिकारी", "पशुधन प्रसार अधिकारी", "मैत्री"],
            "वन विभाग (Forest)": ["DFO", "SDO", "रेंजर", "डिप्टी रेंजर", "वन रक्षक (Forest Guard)"],
            "परिवहन विभाग (RTO)": ["ARTO", "RI", "परिवहन सिपाही", "ड्राइवर", "कंडक्टर"],
            "समाज कल्याण (Social Welfare)": ["समाज कल्याण अधिकारी", "पर्यवेक्षक", "कंप्यूटर ऑपरेटर"],
            "बाल विकास (ICDS)": ["DPO", "CDPO", "मुख्य सेविका", "आंगनवाड़ी कार्यकर्ता", "सहायिका"],
            "विद्युत विभाग (Electricity)": ["XEN", "SDO", "JE", "लाइनमैन", "एसएसओ (SSO)", "मीटर रीडर"],
            "लोक निर्माण (PWD)": ["EE", "AE", "JE", "मेट", "बेलदार", "रोड रोलर ड्राइवर"],
            "आबकारी विभाग (Excise)": ["जिला आबकारी अधिकारी", "आबकारी निरीक्षक", "आबकारी सिपाही"],
            "सहकारिता (Cooperative)": ["AR (Coop)", "AD0 (Coop)", "सचिव"],
            "ग्राम्य विकास (Rural Dev)": ["CDO", "DDO", "BDO", "ADO (ISB)", "VDO", "रोजगार सेवक"],
            "कौशल विकास (Skill Dev)": ["जिला समन्वयक", "एमआईएस मैनेजर", "प्रशिक्षक"],
            "अन्य विभाग (Others)": ["प्रदेश अध्यक्ष", "प्रदेश उपाध्यक्ष", "प्रदेश महामंत्री", "प्रदेश संयुक्त मंत्री", "प्रदेश संयुक्त सहायक मंत्री", "प्रदेश संगठन मंत्री", "प्रदेश आईटी सेल प्रमुख", "प्रदेश मीडिया प्रभारी", "प्रदेश सोशल मीडिया प्रभारी", "प्रदेश प्रचार मंत्री", "प्रदेश कोषाध्यक्ष", "प्रदेश महिला अध्यक्ष", "प्रदेश युवा अध्यक्ष", "प्रदेश विधि सलाहकार", "प्रदेश सलाहकार", "प्रदेश विशेष आमंत्रित सदस्य"]
        };

        window.initVibhagLists = function () {
            const lists = ['vibhag_list', 'vibhag_list_edit'];
            lists.forEach(id => {
                const dl = document.getElementById(id);
                if (dl) {
                    dl.innerHTML = '';
                    Object.keys(vibhagData).forEach(v => {
                        const opt = document.createElement('option');
                        opt.value = v;
                        dl.appendChild(opt);
                    });
                }
            });
        };

        window.handleVibhagChange = function (formMode, preSelectedPost = null) {
            const prefix = formMode === 'add' ? 'off' : 'editOff';
            const vibVal = document.getElementById(prefix + 'Vibhag').value;
            const postSel = document.getElementById(prefix + 'Post');

            postSel.innerHTML = '<option value="">-- पद चुनें (Post) --</option>';

            if (vibVal && vibhagData[vibVal]) {
                vibhagData[vibVal].forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p; opt.innerText = p;
                    postSel.appendChild(opt);
                });
            } else if (vibVal) {
                // Generic posts if department not in mapping
                ["प्रदेश अध्यक्ष", "प्रदेश उपाध्यक्ष", "प्रदेश महामंत्री", "प्रदेश मंत्री", "प्रदेश सदस्य", "प्रदेश पदाधिकारी"].forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p; opt.innerText = p;
                    postSel.appendChild(opt);
                });
            }

            if (preSelectedPost) {
                postSel.value = preSelectedPost;
            }
        };

        window.handleRoleChange = function (formMode) {
            const prefix = formMode === 'add' ? 'off' : 'editOff';
            const role = document.getElementById(prefix + 'Role').value;
            const divEl = document.getElementById(prefix + 'Division');
            const distEl = document.getElementById(prefix + 'District');
            const blockEl = document.getElementById(prefix + 'Block');

            // Reset visibility
            if (divEl) divEl.style.display = 'block';
            if (distEl) distEl.style.display = 'block';
            if (blockEl) blockEl.style.display = 'block';

            if (role === 'State Admin') {
                if (divEl) divEl.style.display = 'none';
                if (distEl) distEl.style.display = 'none';
                if (blockEl) blockEl.style.display = 'none';
            } else if (role === 'Division Admin') {
                if (distEl) distEl.style.display = 'none';
                if (blockEl) blockEl.style.display = 'none';
            } else if (role === 'District Admin') {
                if (divEl) divEl.style.display = 'none';
                if (blockEl) blockEl.style.display = 'none';
                populateAllDistricts(formMode); // Show all districts
            }
            // Block Admin and Officer show District and Block (Division hidden)
            else if (role === 'Block Admin' || role === 'Officer') {
                if (divEl) divEl.style.display = 'none';
                populateAllDistricts(formMode); // Show all districts
            }
        };

        window.populateAllDistricts = function (formMode) {
            const prefix = formMode === 'add' ? 'off' : 'editOff';
            const distSel = document.getElementById(prefix + 'District');
            if (!distSel) return;

            const currentVal = distSel.value;
            distSel.innerHTML = '<option value="">-- जिला चुनें (District) --</option>';

            const allDists = [];
            for (let div in locationData) {
                locationData[div].districts.forEach(d => {
                    if (!allDists.includes(d)) allDists.push(d);
                });
            }
            allDists.sort().forEach(d => {
                const opt = document.createElement('option');
                opt.value = d; opt.innerText = d;
                distSel.appendChild(opt);
            });
            if (currentVal) distSel.value = currentVal;
        };

        // --- LOCATION DATA & LOGIC --- //
        const locationData = {
            "Agra": { districts: ["Agra", "Firozabad", "Mathura", "Mainpuri"] },
            "Aligarh": { districts: ["Aligarh", "Etah", "Hathras", "Kasganj"] },
            "Ayodhya": { districts: ["Ayodhya", "Ambedkar Nagar", "Amethi", "Barabanki", "Sultanpur"] },
            "Azamgarh": { districts: ["Azamgarh", "Ballia", "Mau"] },
            "Bareilly": { districts: ["Bareilly", "Badaun", "Pilibhit", "Shahjahanpur"] },
            "Basti": { districts: ["Basti", "Sant Kabir Nagar", "Siddharthnagar"] },
            "Chitrakoot": { districts: ["Banda", "Chitrakoot", "Hamirpur", "Mahoba"] },
            "Devipatan": { districts: ["Gonda", "Bahraich", "Balrampur", "Shravasti"] },
            "Gorakhpur": { districts: ["Deoria", "Gorakhpur", "Kushinagar", "Maharajganj"] },
            "Jhansi": { districts: ["Jalaun", "Jhansi", "Lalitpur"] },
            "Kanpur": { districts: ["Auraiya", "Etawah", "Farrukhabad", "Kannauj", "Kanpur Dehat", "Kanpur Nagar"] },
            "Lucknow": { districts: ["Hardoi", "Lakhimpur Kheri", "Lucknow", "Raebareli", "Sitapur", "Unnao"] },
            "Meerut": { districts: ["Baghpat", "Bulandshahar", "Gautam Buddha Nagar", "Ghaziabad", "Meerut", "Hapur"] },
            "Mirzapur": { districts: ["Mirzapur", "Sant Ravidas Nagar (Bhadohi)", "Sonbhadra"] },
            "Moradabad": { districts: ["Bijnor", "Amroha", "Moradabad", "Rampur", "Sambhal"] },
            "Prayagraj": { districts: ["Prayagraj", "Fatehpur", "Kaushambi", "Pratapgarh"] },
            "Saharanpur": { districts: ["Saharanpur", "Muzaffarnagar", "Shamli"] },
            "Varanasi": { districts: ["Chandauli", "Ghazipur", "Jaunpur", "Varanasi"] }
        };

        // Full UP Blocks (Vikas Khand) - ~822 Blocks for all 75 Districts
        const blockData = {
            "Agra": ["Achhnera", "Akola", "Bah", "Barauli Ahir", "Bichpuri", "Etimadpur", "Fatehabad", "Fatehpur Sikri", "Jagner", "Kheragarh", "Pinahat", "Saiyan", "Shamshabad", "Khandauli", "Barauli"],
            "Aligarh": ["Atrauli", "Chandaus", "Gonda", "Iglas", "Jawan Sikanderpur", "Khair", "Lodh", "Tappal", "Akshraward", "Dhanipur", "Gangiri", "Bijauli"],
            "Prayagraj": ["Jasra", "Shankargarh", "Pratappur", "Saidabad", "Dhanupur", "Handia", "Chaka", "Karchhana", "Kaundhiyara", "Koraon", "Uruwa", "Meja", "Manda", "Bahariya", "Phulpur", "Soraon", "Holagarh", "Mauharna", "Shringverpur Dham", "Sewaith"],
            "Ambedkar Nagar": ["Akbarpur", "Baskhari", "Bhiyao", "Jalalpur", "Katehari", "Ramnagar", "Tanda", "Jahangir Ganj", "Ram Nagar"],
            "Amethi": ["Amethi", "Bhadar", "Gauriganj", "Musafirkhana", "Shahgarh", "Shukul Bazar", "Singhpur", "Jagdishpur", "Tiloi"],
            "Amroha": ["Amroha", "Dhanaura", "Gajraula", "Gangeshwari", "Hasanpur", "Joya"],
            "Auraiya": ["Achyalda", "Auraiya", "Bhagyayanagar", "Bidhuna", "Erwa Katra", "Sahar", "Bidhuna"],
            "Ayodhya": ["Amaniganj", "Bikapur", "Haringtonganj", "Masodha", "Maya Bazar", "Milkipur", "Pura Bazar", "Rudauli", "Sohawal", "Tarun"],
            "Azamgarh": ["Ahiraula", "Atraulia", "Azmatgarh", "Bilariaganj", "Jahanaganj", "Lalganj", "Maharajganj", "Martinganj", "Mehnagar", "Mirzapur", "Mohammadpur", "Palhana", "Pawai", "Phulpur", "Rani Ki Sarai", "Sathiyaon", "Tahbarpur", "Tarwa", "Thekma"],
            "Baghpat": ["Baghpat", "Baraut", "Binauli", "Chhaprauli", "Khekra", "Pilana"],
            "Bahraich": ["Balha", "Chittaura", "Fakharpur", "Huzoorpur", "Jarwal", "Kaisarganj", "Mahasi", "Mihinpurwa", "Nawabganj", "Payagpur", "Phakharpur", "Risia", "Shivpur", "Tejwapur", "Visheshwarganj"],
            "Ballia": ["Bansdih", "Bairia", "Belhari", "Beruarbari", "Chilkahar", "Dubhar", "Garwar", "Hanumanganj", "Maniar", "Murlichhapra", "Nagra", "Pandah", "Rasra", "Ratsar Kalan", "Reoti", "Siar", "Sohao"],
            "Balrampur": ["Balrampur", "Gainsari", "Harriya Satgharwa", "Pachperwa", "Rehra Bazar", "Shridattganj", "Tulsipur", "Utraula"],
            "Banda": ["Badausa", "Babatpur", "Bisanda", "Jaspura", "Kamasin", "Mahua", "Naraini", "Oran", "Pailani", "Tindwari"],
            "Barabanki": ["Banki", "Masauli", "Dewa", "Harakh", "Fatehpur", "Haidergarh", "Dariyabad", "Suratganj", "Siddhaur", "Pure Dalai", "Nindura", "Trivediganj", "Ramnagar", "Sirauli Ghauspur", "Banikodar"],
            "Bareilly": ["Aalamganj", "Aonla", "Baheri", "Bhadpura", "Bhojipura", "Bithri Chainpur", "Faridpur", "Fatehganj Paschim", "Kyara", "Majhgawan", "Mirganj", "Nawabganj", "Ramnagar", "Richha", "Shergarh"],
            "Basti": ["Bahadurpur", "Bankati", "Basti", "Dubauliya", "Gaur", "Harraiya", "Kaptanganj", "Kudaraha", "Paras Rampur", "Ramnagar", "Rudhauli", "Saltaua Gopalpur", "Sau Ghat", "Vikram Jot"],
            "Bhadohi": ["Abholi", "Aurai", "Bhadohi", "Deegh", "Gyanpur", "Suriyawan"],
            "Bijnor": ["Afzalgarh", "Dhampur", "Haldaur", "Jalilpur", "Kiratpur", "Kotwali", "Mohammadpur Deomal", "Najibabad", "Nehtaur", "Noorpur", "Seohara"],
            "Budaun": ["Ambiapur", "Asafpur", "Bilsi", "Binawar", "Bisauli", "Dahgavan", "Dataganj", "Islamnagar", "Jagat", "Miyanganj", "Sahaswan", "Salarpur", "Samrer", "Ujhani", "Wazirganj"],
            "Bulandshahr": ["Agauta", "Anupshahr", "Arniya", "B.B. Nagar", "Bulandshahr", "Danpur", "Debai", "Gulaothi", "Jahangirabad", "Khurja", "Lakhaoti", "Pahasu", "Shikarpur", "Siyana", "Sikandrabad", "Unchagaon"],
            "Chandauli": ["Barhani", "Chakia", "Chandauli", "Niyamtabad", "Naugarh", "Sakaldiha", "Shahabganj"],
            "Chitrakoot": ["Karwi", "Manikpur", "Mau", "Pahari", "Ramnagar"],
            "Deoria": ["Baitalpur", "Bankata", "Barhaj", "Bhaluani", "Bhatni", "Bhatpar Rani", "Deoria", "Desahi Deoria", "Gauri Bazar", "Lar", "Pathardewa", "Rampur Karkhana", "Rudrapur", "Salempur", "Tarkulwa"],
            "Etah": ["Aliganj", "Awagarh", "Etah", "Jaithara", "Jalesar", "Marehra", "Nidhauli Kalan", "Sakit"],
            "Etawah": ["Barhpura", "Basrehar", "Bharthana", "Chakarnagar", "Jaswantnagar", "Mahewa", "Saifai", "Takha"],
            "Farrukhabad": ["Barhpur", "Kaimganj", "Kamalganj", "Mohammadabad", "Nawabganj", "Rajepur", "Shamsabad"],
            "Fatehpur": ["Airayan", "Asothar", "Bahua", "Bhitaura", "Deomai", "Dhata", "Haswa", "Hathgam", "Khajuha", "Malwan", "Teliyani", "Vijayipur"],
            "Firozabad": ["Arawon", "Eka", "Firozabad", "Hathwant", "Jasrana", "Kheragarh", "Madanpur", "Narkhi", "Shikohabad", "Sirsaganj", "Tundla"],
            "Gautam Buddha Nagar": ["Bisrakh", "Dadri", "Jewar", "Dankaur"],
            "Ghaziabad": ["Bhojpur", "Loni", "Muradnagar", "Razapur"],
            "Ghazipur": ["Barachawar", "Bhanwarkol", "Deokali", "Ghazipur", "Jakhanian", "Karanda", "Kasimabad", "Manihari", "Mardah", "Mohammadabad", "Reotipur", "Saidpur", "Zamania"],
            "Gonda": ["Babhanjot", "Belsar", "Chhapia", "Colonelganj", "Haldharmau", "Itiathok", "Jhanjhari", "Katra Bazar", "Mankapur", "Mujehana", "Nawabganj", "Pandri Kripal", "Paraspur", "Rupaidih", "Tarabganj", "Wazirganj"],
            "Gorakhpur": ["Bansgaon", "Belghat", "Bhathat", "Brahmpur", "Campierganj", "Chargawan", "Gagaha", "Gola", "Jungle Kauria", "Kauriram", "Khajni", "Pali", "Pipraich", "Piprauli", "Sahjanwa", "Sardar Nagar", "Uruwa"],
            "Hamirpur": ["Gohand", "Kurara", "Maudaha", "Muskara", "Rath", "Sarila", "Sumerpur"],
            "Hapur": ["Dhaulana", "Garhmukteshwar", "Hapur", "Simbaoli"],
            "Hardoi": ["Ahirori", "Behandar", "Bharawan", "Bharkhani", "Bilgram", "Hariyawan", "Harpalpur", "Kachhauna", "Kothawan", "Madhouganj", "Mallawan", "Pali", "Pihani", "Sandila", "Shahabad", "Sursa", "Tadiyawan", "Todarpur"],
            "Hathras": ["Hathras", "Mursan", "Sadabad", "Sahpau", "Sasni", "Sikandra Rao"],
            "Jalaun": ["Dakore", "Jalaun", "Kadaura", "Konch", "Kuthaund", "Madhougarh", "Maheva", "Nadigaon", "Rampura"],
            "Jaunpur": ["Badlapur", "Baksha", "Dharmapur", "Dobhi", "Jalalpur", "Karanjakala", "Kerakat", "Khutahan", "Maharajganj", "Mariahu", "Muftiganj", "Mungra Badshahpur", "Ramnagar", "Rampur", "Shahganj", "Sikrara", "Sirakoni", "Sujanganj"],
            "Jhansi": ["Babina", "Badagaon", "Bamaur", "Bangra", "Chirgaon", "Gursarai", "Mauranipur", "Moth"],
            "Kannauj": ["Chhibramau", "Gughrapur", "Haseran", "Jalalabad", "Kannauj", "Saurikh", "Talgram", "Umarda"],
            "Kanpur Dehat": ["Akbarpur", "Amraaudha", "Derapur", "Jhinjhak", "Maitha", "Malasa", "Rajpur", "Rasulabad", "Sandapur", "Sarbankhera"],
            "Kanpur Nagar": ["Bidhnu", "Chaubepur", "Ghatampur", "Kalyanpur", "Patara", "Sarsaul", "Shivrajpur", "Bhitargaon"],
            "Kasganj": ["Amanpur", "Ganjdundwara", "Kasganj", "Patiyali", "Sahawar", "Soron", "Sidhpura"],
            "Kaushambi": ["Chail", "Kaushambi", "Manjhanpur", "Mooratganj", "Nevil", "Sarsawan", "Sirathu"],
            "Kushinagar": ["Dudhai", "Fazilnagar", "Hata", "Kaptanganj", "Kasaya", "Khadda", "Motichak", "Nebua Naurangia", "Padrauna", "Ramkola", "Seorahi", "Sukrauli", "Tamkuhi Raj", "Vishunpura"],
            "Lakhimpur Kheri": ["Bankeyganj", "Bejam", "Bijua", "Dhaurahra", "Isanagar", "Kheri", "Kumbhi", "Lakhimpur", "Mihila", "Nighasan", "Nakaha", "Pallia", "Pasgawan", "Phoolbehar", "Ramia Behar"],
            "Lalitpur": ["Birdha", "Jakhaura", "Madawara", "Mahroni", "Talbehat", "Bar"],
            "Lucknow": ["Bakshi Ka Talab", "Chinhat", "Gosainganj", "Kakori", "Mall", "Malihabad", "Mohanlalganj", "Sarojini Nagar"],
            "Maharajganj": ["Brijmanganj", "Dhani", "Ghughuli", "Laxmipur", "Maharajganj", "Mithaura", "Nichlaul", "Paniyara", "Pharenda", "Ratanpur", "Siswa"],
            "Mahoba": ["Charkhari", "Jaitpur", "Kabrai", "Panwari"],
            "Mainpuri": ["Barnahal", "Bewar", "Eka", "Ghiror", "Jageer", "Karhal", "Kishni", "Kuraoli", "Mainpuri", "Sultanganj"],
            "Mathura": ["Baldeo", "Chhata", "Chaumuha", "Farah", "Govardhan", "Mathura", "Nandgaon", "Naujhil", "Raya"],
            "Mau": ["Badraon", "Doharighat", "Fatehpur Madaun", "Ghosi", "Kopaganj", "Mohammadabad Gohna", "Pardaha", "Ratanpura"],
            "Meerut": ["Daurala", "Hastinapur", "Janikhurd", "Kharkhoda", "Machhra", "Mawana", "Meerut", "Parikshitgarh", "Rajpura", "Rohta", "Sardhana", "Sarurpur Khurd"],
            "Mirzapur": ["City", "Chanbey", "Hallia", "Jamalpur", "Kon", "Lalganj", "Majhawan", "Narayanpur", "Pahari", "Patehara Kalan", "Rajgarh", "Sikhar"],
            "Moradabad": ["Bhagatpur Tanda", "Chhajlet", "Dilari", "Kundarki", "Moradabad", "Munda Pandey", "Bilari", "Kanth", "Thakurdwara"],
            "Muzaffarnagar": ["Baghra", "Budhana", "Charthawal", "Jansath", "Kandhla", "Khatauli", "Muzaffarnagar", "Purqazi", "Shahpur", "Shamli", "Thana Bhawan"],
            "Pilibhit": ["Amariya", "Barkhera", "Bilsanda", "Bisalpur", "Lalaurikhera", "Marauri", "Puranpur"],
            "Pratapgarh": ["Babaganj", "Belghat", "Bihar", "Gaura", "Kala Kankar", "Kunda", "Lakshmanpur", "Mandhata", "Mangraura", "Patty", "Pratapgarh City", "Rajapur", "Sada", "Sandwa Chandrika", "Sangipur"],
            "Raebareli": ["Amawan", "Bachhrawan", "Deenshah Gaura", "Dih", "Harchandpur", "Jagatpur", "Lalganj", "Maharajganj", "Naseerabad", "Rahi", "Rohaniya", "Sareni", "Sataon", "Sivgarh", "Unchahar"],
            "Rampur": ["Bilaspur", "Chamrawa", "Milak", "Saidnagar", "Shahabad", "Suar"],
            "Saharanpur": ["Baliakheri", "Gangoh", "Nanauta", "Purowala", "Rampur Maniharan", "Sadauli Qadeem", "Sarsawa", "Muzaffarabad", "Naggal"],
            "Sambhal": ["Asmoli", "Bahjoi", "Baniyather", "Gunnaur", "Junawai", "Panwasa", "Rajpura", "Sambhal"],
            "Sant Kabir Nagar": ["Baghauli", "Belhar Kala", "Hainsar Bazar", "Khalilabad", "Mehdawal", "Nath Nagar", "Pauli", "Santha", "Semariyawan"],
            "Shahjahanpur": ["Banda", "Bawarkhera", "Dadrol", "Jalalabad", "Jaitipur", "Kanth", "Katra", "Khutar", "Madnapur", "Mirzapur", "Nigohi", "Powayan", "Sindhauli", "Tilhar"],
            "Shamli": ["Kairana", "Kandhla", "Shamli", "Thana Bhawan", "Un"],
            "Shravasti": ["Gilaula", "Hariharpur Rani", "Ikauna", "Jamunaha", "Sirsiya"],
            "Siddharthnagar": ["Bansi", "Barhani Bazar", "Birdpur", "Domariaganj", "Itwa", "Jogiya", "Khesraha", "Khuniyaon", "Lotan", "Mithwal", "Naugarh", "Shohratgarh", "Uska Bazar"],
            "Sitapur": ["Ailiya", "Behta", "Biswan", "Gondlamau", "Hargaon", "Kasmanda", "Khairabad", "Laharpur", "Machhrehta", "Mahmudabad", "Maholi", "Misrikh", "Pahala", "Pisawan", "Reusa", "Sakaran", "Sidhauli"],
            "Sonbhadra": ["Babhani", "Chatra", "Chopan", "Duddhi", "Ghorawal", "Myorpur", "Nagwa", "Robertsganj"],
            "Sultanpur": ["Akhand Nagar", "Bhadaiya", "Dhanpatganj", "Dubepur", "Jai Singh Pur", "Kurebhar", "Kurwar", "Lambhua", "Motigarpur", "Pratap Pur Kamraicha"],
            "Unnao": ["Asoha", "Auras", "Bangarmau", "Bichhiya", "Bighapur", "Fatehpur Chaurasi", "Ganj Moradabad", "Hasanganj", "Hilauli", "Miyanganj", "Nawabganj", "Purwa", "Safipur", "Sumerpur"],
            "Varanasi": ["Arajiline", "Baragaon", "Chiraigaon", "Cholapur", "Harhua", "Kashi Vidyapeeth", "Pindra", "Sewapuri"]
        };

        window.handleLocationChange = function (formMode, level, preSelectedValue = null) {
            const prefix = formMode === 'add' ? 'off' : 'editOff';
            const divId = prefix + 'Division';
            const distId = prefix + 'District';
            const blockId = prefix + 'Block';

            const divVal = document.getElementById(divId).value;
            const distVal = document.getElementById(distId).value;

            if (level === 'division') {
                const distSel = document.getElementById(distId);
                distSel.innerHTML = '<option value="">-- जिला चुनें (District) --</option>';
                if (divVal && locationData[divVal]) {
                    locationData[divVal].districts.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d; opt.innerText = d;
                        distSel.appendChild(opt);
                    });
                }
                if (preSelectedValue) distSel.value = preSelectedValue;
                // Reset Block
                document.getElementById(blockId).innerHTML = '<option value="">-- ब्लॉक चुनें (Block) --</option>';
            }

            if (level === 'district') {
                const blockSel = document.getElementById(blockId);
                blockSel.innerHTML = '<option value="">-- ब्लॉक चुनें (Block) --</option>';
                const activeDist = preSelectedValue || distVal;
                if (activeDist && blockData[activeDist]) {
                    blockData[activeDist].forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b; opt.innerText = b;
                        blockSel.appendChild(opt);
                    });
                } else if (activeDist) {
                    // Placeholder blocks if data missing
                    ['Block 1', 'Block 2', 'Block 3'].forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = `${activeDist}-${b}`; opt.innerText = `${activeDist}-${b}`;
                        blockSel.appendChild(opt);
                    });
                }
                if (preSelectedValue && formMode === 'edit') {
                    // This is handled by a secondary call if needed, or by setting value after populating
                }
            }
        };

        window.handleFilterLocationChange = function () {
            const divVal = document.getElementById('filterOffDivision').value;
            const distSel = document.getElementById('filterOffDistrict');
            distSel.innerHTML = '<option value="">-- जिला (District) --</option>';

            if (divVal && locationData[divVal]) {
                locationData[divVal].districts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d; opt.innerText = d;
                    distSel.appendChild(opt);
                });
            }
            loadDashboardData(); // Trigger list update
        };

        window.resetOfficerFilters = function () {
            document.getElementById('filterOffDivision').value = '';
            document.getElementById('filterOffDistrict').innerHTML = '<option value="">-- जिला (District) --</option>';
            document.getElementById('searchOfficers').value = '';
            loadDashboardData();
        };

        // --- LOAD DATA ON START --- //
        document.addEventListener('DOMContentLoaded', () => {
            // Admin Check: Redirect to login if no token
            if (!localStorage.getItem('up_sangh_admin_token')) {
                window.location.replace('login.html');
            }
            initVibhagLists();
            handleRoleChange('add'); // Initialize visibility

            // Restore Section
            const lastSection = localStorage.getItem('up_sangh_active_section_admin') || 'dashboard';
            showSection(lastSection);

            loadDashboardData();
            runDesignationMigration();
        });

        function runDesignationMigration() {
            if (localStorage.getItem('up_sangh_designations_migrated_v2')) return;

            const targetPosts = [
                "अध्यक्ष", "उपाध्यक्ष", "महामंत्री", "मंत्री", "संगठन मंत्री", "आईटी सेल प्रमुख",
                "मीडिया प्रभारी", "सोशल मीडिया प्रभारी", "प्रचार मंत्री", "कोषाध्यक्ष",
                "महिला अध्यक्ष", "युवा अध्यक्ष", "संयुक्त मंत्री", "संयुक्त सहायक मंत्री", "विशेष आमंत्रित सदस्य",
                "सदस्य", "पदाधिकारी"
            ];

            const migrate = (data) => {
                if (!Array.isArray(data)) return data;
                return data.map(item => {
                    if (item.post && targetPosts.includes(item.post)) {
                        item.post = "प्रदेश " + item.post;
                    }
                    return item;
                });
            };

            // Migrate Officers
            let officers = JSON.parse(localStorage.getItem('up_sangh_officers')) || [];
            if (officers.length > 0) {
                officers = migrate(officers);
                localStorage.setItem('up_sangh_officers', JSON.stringify(officers));
            }

            // Migrate Requests
            let requests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
            if (requests.length > 0) {
                requests = requests.map(req => {
                    if (req.post && targetPosts.includes(req.post)) {
                        req.post = "प्रदेश " + req.post;
                    }
                    if (req.changes && req.changes.post && targetPosts.includes(req.changes.post)) {
                        req.changes.post = "प्रदेश " + req.changes.post;
                    }
                    return req;
                });
                localStorage.setItem('up_sangh_requests', JSON.stringify(requests));
            }

            localStorage.setItem('up_sangh_designations_migrated_v2', 'true');
            console.log("Migration: Officer designations updated to include 'प्रदेश' prefix.");
        }

        function loadDashboardData() {
            // Check Session
            const sessionData = localStorage.getItem('up_sangh_current_officer_session');
            const currentOfficer = sessionData ? JSON.parse(sessionData) : null;

            // Robust Role Detection
            let role = 'Super Admin'; // Default
            if (currentOfficer && currentOfficer.role) {
                role = currentOfficer.role;
            } else if (!localStorage.getItem('up_sangh_admin_token')) {
                window.location.replace('login.html');
                return;
            }
            console.log("Loading Dashboard for Role:", role);


            // Hierarchy Context
            const targetDiv = currentOfficer ? currentOfficer.division : null;
            const targetDist = currentOfficer ? currentOfficer.district : null;
            const targetBlock = currentOfficer ? currentOfficer.block : null;

            // Normalize for bilingual strings
            const checkMatch = (val, target) => {
                if (!target) return false;
                const v = (val || "").toString().trim();
                const t = (target || "").toString().trim();
                return v.includes(t) || t.includes(v);
            };

            const getSafe = (key) => {
                try {
                    const data = localStorage.getItem(key);
                    if (!data) return [];
                    const parsed = JSON.parse(data);
                    return Array.isArray(parsed) ? parsed : [];
                } catch (e) {
                    console.error("Parse Error for " + key, e);
                    return [];
                }
            };


            // 1. Members Filtering
            const allMembers = window.allMembers || [];
            let members = [...allMembers];

            if (role !== 'Super Admin' && role !== 'State Admin') {
                members = members.filter(m => {
                    const mWorkDist = m.workDistrict || m.work_district || "";
                    const mHomeDist = m.homeDistrict || m.home_district || "";
                    const mBlock = m.block || m.work_block || "";

                    if (role === 'Division Admin' && targetDiv) return checkMatch(mWorkDist, targetDiv);
                    if (role === 'District Admin' && targetDist) return checkMatch(mWorkDist, targetDist) || checkMatch(mHomeDist, targetDist);
                    if (role === 'Block Admin' && targetBlock) {
                        // Allow if district matches and block either matches OR is missing
                        const distMatch = checkMatch(mWorkDist, targetDist);
                        return distMatch && (!mBlock || checkMatch(mBlock, targetBlock));
                    }
                    return false;
                });
            }
            // Show Count (Filtered for non-super admins)
            const memEl = document.getElementById('statTotalMembers');
            if (memEl) memEl.innerText = members.length;
            renderMembersTable(members);

            // Recent Members (on Dashboard Section) - Filtered
            const recent = [...members].reverse().slice(0, 5);
            const rBody = document.querySelector('#recentMembersTable tbody');
            if (rBody) {
                rBody.innerHTML = recent.map(m => `
                    <tr>
                        <td>${m.name}</td>
                        <td>${m.mobile}</td>
                        <td>${m.department}</td>
                        <td>${m.post}</td>
                        <td>${m.workDistrict || m.work_district || '--'}</td>
                        <td>${m.date || '--'}</td>
                    </tr>
                `).join('') || '<tr><td colspan="6" style="text-align:center;">No recent members.</td></tr>';
            }

            // 5. Requests Filtering (Admin)
            const allRequests = window.allRequests || [];
            const openRequests = allRequests.filter(r => r.status === 'Open');

            const reqBody = document.getElementById('adminRequestsBody');
            const reqCount = document.getElementById('reqCountBadge');
            if (reqBody) {
                reqBody.innerHTML = '';
                if (openRequests.length === 0) {
                    reqBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#999;">No pending profile update requests.</td></tr>';
                    if (reqCount) reqCount.style.display = 'none';
                } else {
                    if (reqCount) {
                        reqCount.innerText = openRequests.length;
                        reqCount.style.display = 'inline-block';
                    }
                    openRequests.forEach(req => {
                        const planLabel = req.membership_plan ? `<br><span style="padding:2px 6px; background:#f3e5f5; color:#7b1fa2; font-size:0.65rem; border-radius:10px; font-weight:bold; margin-top:5px; display:inline-block;">Plan: ${req.membership_plan} (₹${req.amount || 299})</span>` : "";
                        const payBadge = req.payment_status === 'Payment Sent'
                            ? `<br><span style="background:#e1f5fe; color:#01579b; font-size:0.65rem; padding:2px 6px; border-radius:10px; font-weight:bold; margin-top:5px; display:inline-block;"><i class="fa-solid fa-circle-check"></i> Payment Sent</span>`
                            : `<br><span style="background:#fff3e0; color:#e65100; font-size:0.65rem; padding:2px 6px; border-radius:10px; font-weight:bold; margin-top:5px; display:inline-block;"><i class="fa-solid fa-circle-info"></i> Unpaid</span>`;

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><span class="badge badge-warning">${req.type || 'Update'}</span></td>
                            <td><strong>${req.name}</strong>${planLabel}${payBadge}</td>
                            <td>${req.mobile}</td>
                            <td>${req.block || ''} / ${req.district || ''}</td>
                            <td>${req.timestamp || '--'}</td>
                            <td>
                                <button onclick="processProfileRequest('${req.reqId}')" class="btn btn-sm btn-primary">Review ></button>
                            </td>
                        `;
                        reqBody.appendChild(tr);
                    });
                }
            }

            // 2. Officers Filtering
            const allOfficers = window.allOfficers || [];
            let officers = [...allOfficers];

            // UI Filters (for Super Admin or filters applied manually)
            const filterDiv = document.getElementById('filterOffDivision') ? document.getElementById('filterOffDivision').value : '';
            const filterDist = document.getElementById('filterOffDistrict') ? document.getElementById('filterOffDistrict').value : '';
            const filterSearch = document.getElementById('searchOfficers') ? document.getElementById('searchOfficers').value.toLowerCase().trim() : '';

            if (role !== 'Super Admin' && role !== 'State Admin') {
                officers = officers.filter(o => {
                    // Treat missing status as 'Approved' for legacy data
                    const status = o.status || 'Approved';
                    if (status !== 'Approved') return false;

                    if (role === 'Division Admin' && targetDiv) return o.division === targetDiv;
                    if (role === 'District Admin' && targetDist) return o.district === targetDist;
                    if (role === 'Block Admin' && targetBlock) return o.district === targetDist && o.block === targetBlock;
                    return false;
                });
            }

            // Apply UI Filters (Global search and dropdowns)
            if (filterDiv) officers = officers.filter(o => o.division === filterDiv);
            if (filterDist) officers = officers.filter(o => o.district === filterDist);
            if (filterSearch) {
                officers = officers.filter(o =>
                    o.name.toLowerCase().includes(filterSearch) ||
                    o.mobile.includes(filterSearch) ||
                    (o.post && o.post.toLowerCase().includes(filterSearch))
                );
            }
            // Show Count (Filtered)
            const offStatEl = document.getElementById('statTotalOfficers');
            if (offStatEl) offStatEl.innerText = officers.length;
            renderOfficersTable(officers);

            // 3. Issues Filtering
            const allIssues = window.allIssues || [];
            let issues = [...allIssues];

            if (role !== 'Super Admin' && role !== 'State Admin') {
                const memberDataMap = {};
                allMembers.forEach(m => memberDataMap[m.mobile] = m);

                issues = issues.filter(iss => {
                    const member = memberDataMap[iss.mobile];
                    if (!member) return false;
                    const mWorkDist = (member.work_district || member.workDistrict || "").trim();

                    if (role === 'Division Admin' && targetDiv) return mWorkDist.includes(targetDiv);
                    if (role === 'District Admin' && targetDist) return mWorkDist === targetDist;
                    if (role === 'Block Admin' && targetBlock) return (member.block === targetBlock || member.work_block === targetBlock);
                    return false;
                });
            }
            // Show Count (Filtered)
            const issEl = document.getElementById('statTotalIssues');
            if (issEl) issEl.innerText = issues.length;
            renderIssuesTable(issues);

            // 4. Role-Based UI Toggles (Full Control Panel Sidebar Link)
            const sideControlLink = document.getElementById('sideLinkControl');
            if (sideControlLink) {
                // Show in sidebar only for Super Admin or State Admin
                if (role === 'Super Admin' || role === 'State Admin') {
                    sideControlLink.style.display = 'block';
                } else {
                    sideControlLink.style.display = 'none';
                }
            }

            // 5. Load Reports & Other Modules
            if (typeof loadReportsData === 'function') {
                loadReportsData();
            }
            if (typeof loadFinanceData === 'function') {
                loadFinanceData();
            }
        }

        // --- RENDER FUNCTIONS --- //
        function renderMembersTable(data) {
            const tbody = document.querySelector('#membersTable tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">कोई सदस्य नहीं मिला। (No Members Found)</td></tr>';
                return;
            }

            let html = '';
            [...data].reverse().forEach((m, i) => {
                const isApproved = m.status === 'Approved';
                const isRejected = m.status === 'Rejected';

                let statusBadge = '';
                if (isApproved) {
                    const approvedInfo = m.approved_by ? `<br><span style="font-size:0.65rem; color:#0e6251;">By: ${m.approved_by} (${m.approved_role || 'Admin'} - ${m.approved_location || ''})</span>` : '';
                    statusBadge = `<span style="color:green; font-size:0.75rem;"><i class="fa-solid fa-check-circle"></i> Verified</span>${approvedInfo}`;
                }
                else if (isRejected) statusBadge = '<span style="color:red; font-size:0.75rem;"><i class="fa-solid fa-ban"></i> Rejected</span>';
                else statusBadge = '<span style="color:orange; font-size:0.75rem;"><i class="fa-solid fa-clock"></i> Pending</span>';

                const verifyBtn = (!isApproved && !isRejected)
                    ? `<button onclick="verifyMember(${m.id})" class="btn btn-sm btn-success" title="Verify" style="margin-bottom:3px;"><i class="fa-solid fa-check"></i></button>`
                    : '';

                const rejectBtn = (!isApproved && !isRejected)
                    ? `<button onclick="rejectMember(${m.id})" class="btn btn-sm btn-warning" title="Reject" style="margin-bottom:3px; background:#e67e22;"><i class="fa-solid fa-ban"></i></button>`
                    : '';

                const photoThumb = m.photo
                    ? `<img src="${m.photo}" style="width: 40px; height: 45px; object-fit: cover; border-radius: 3px; border: 1px solid #ddd;">`
                    : '<i class="fa-solid fa-user" style="font-size: 1.5rem; color: #ccc;"></i>';

                html += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${photoThumb}</td>
                        <td><strong>${m.name}</strong><br><small>S/o ${m.fatherName || '--'}</small></td>
                        <td>${m.mobile}</td>
                        <td>${m.department}</td>
                        <td>${m.post}</td>
                        <td>${m.work_district || m.workDistrict || '--'}</td>
                        <td>${m.date || '--'}</td>
                        <td>
                            <div style="margin-bottom:5px;">${statusBadge}</div>
                            <div style="display:flex; gap:3px; flex-wrap:wrap;">
                                <button onclick="viewMember(${m.id})" class="btn btn-sm btn-primary" title="Details"><i class="fa-solid fa-eye"></i></button>
                                <button onclick="openEditMember(${m.id})" class="btn btn-sm btn-info" title="Edit"><i class="fa-solid fa-edit"></i></button>
                                ${verifyBtn}
                                ${rejectBtn}
                                <button onclick="deleteMember(${m.id})" class="btn btn-sm btn-danger" title="Delete"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
            });
            tbody.innerHTML = html;
        }

        function renderOfficersTable(data) {
            const tbody = document.querySelector('#officersTable tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">कोई पदाधिकारी नहीं जुड़ा है। (No Officers Added)</td></tr>';
                return;
            }

            // Detect current role for button visibility
            const sessionData = localStorage.getItem('up_sangh_current_officer_session');
            const currentOfficer = sessionData ? JSON.parse(sessionData) : null;
            const myRole = currentOfficer ? currentOfficer.role : 'Super Admin';
            const isFullControl = (myRole === 'Super Admin' || myRole === 'State Admin');

            let html = '';
            data.forEach((o, i) => {
                const status = o.status || 'Approved';
                const isApproved = status === 'Approved';
                const isRejected = status === 'Rejected' || status === 'Deleted';

                let statusBadge = '';
                if (isApproved) statusBadge = '<span style="color:green; font-size:0.7rem;"><i class="fa-solid fa-check-circle"></i> Approved</span>';
                else if (isRejected) statusBadge = '<span style="color:red; font-size:0.7rem;"><i class="fa-solid fa-ban"></i> Rejected</span>';
                else statusBadge = '<span style="color:orange; font-size:0.7rem;"><i class="fa-solid fa-clock"></i> Pending</span>';

                const approveBtn = (isFullControl && !isApproved)
                    ? `<button onclick="verifyOfficer(${o.id})" class="btn btn-sm btn-success" title="Approve Officer"><i class="fa-solid fa-check"></i></button>`
                    : '';

                const hierarchy = `${o.role}<br><small>${o.division ? o.division + ' मंडल' : ''} ${o.district ? '| ' + o.district : ''} ${o.block ? '| ' + o.block : ''}</small>`;
                const media = `
                    <div style="display:flex; gap:5px;">
                        ${o.photo ? `<img src="${o.photo}" title="Photo" style="width:30px; height:35px; object-fit:cover; border:1px solid #ccc;">` : '<i class="fa-solid fa-user-circle" title="No Photo"></i>'}
                        ${o.sign ? `<img src="${o.sign}" title="Signature" style="width:40px; height:20px; object-fit:contain; border:1px solid #ccc;">` : '<i class="fa-solid fa-file-signature" title="No Sign"></i>'}
                    </div>
                `;
                html += `
                    <tr>
                        <td><strong>${o.name}</strong><br><small>S/o ${o.fatherName || '--'}</small><br>${statusBadge}</td>
                        <td>${o.vibhag ? `<strong>${o.vibhag}</strong><br>` : ''}${o.post}</td>
                        <td>${hierarchy}</td>
                        <td>${media}</td>
                        <td>ID: ${o.mobile}<br>Pass: ${o.password || '--'}</td>
                        <td>
                            <div style="display:flex; gap:3px;">
                                ${approveBtn}
                                <button onclick="viewOfficer(${o.id})" class="btn btn-sm btn-primary" title="View Details"><i class="fa-solid fa-eye"></i></button>
                                <button onclick="openEditOfficer(${o.id})" class="btn btn-sm btn-warning"><i class="fa-solid fa-edit"></i></button>
                                <button onclick="deleteOfficer(${o.id})" class="btn btn-sm btn-danger"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
            });
            tbody.innerHTML = html;
        }

        function viewOfficer(id) {
            const officers = JSON.parse(localStorage.getItem('up_sangh_officers')) || [];
            const o = officers.find(x => x.id === id);
            if (o) {
                const content = `
                    <div style="display:flex; gap:20px; align-items:start;">
                        ${o.photo ? `<img src="${o.photo}" style="width:120px; border-radius:8px; border:1px solid #ddd;">` : '<i class="fa-solid fa-user-tie" style="font-size:120px; color:#ccc;"></i>'}
                        <div style="flex:1;">
                            <h2 style="margin:0;">${o.name}</h2>
                            <p style="color:#666;">Status: <strong style="color:${o.status === 'Approved' ? 'green' : 'orange'}">${o.status}</strong></p>
                            <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:0.9rem;">
                                <span><strong>विभाग:</strong> ${o.vibhag || '--'}</span>
                                <span><strong>पद:</strong> ${o.post}</span>
                                <span><strong>मोबाइल:</strong> ${o.mobile}</span>
                                <span><strong>मंडल:</strong> ${o.division || '--'}</span>
                                <span><strong>जिला:</strong> ${o.district || '--'}</span>
                                <span><strong>ब्लॉक:</strong> ${o.block || '--'}</span>
                                <span><strong>पिता:</strong> ${o.fatherName || '--'}</span>
                            </div>
                            <div style="margin-top:15px; font-size:0.9rem;">
                                <strong>पता (Address):</strong><br>
                                ${o.address || '--'}
                            </div>
                            <div style="margin-top:10px;">
                                <strong>हस्ताक्षर:</strong><br>
                                ${o.sign ? `<img src="${o.sign}" style="height:40px; border:1px solid #ddd; margin-top:5px;">` : '<span style="color:#999;">Not Available</span>'}
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('officerProfileContent').innerHTML = content;
                document.getElementById('viewOfficerModal').style.display = 'flex';
            }
        }

        window.openEditMember = function (id) {
            const members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
            const m = members.find(x => x.id === id);
            if (m) {
                document.getElementById('editMemId').value = m.id;
                document.getElementById('editMemName').value = m.name;
                document.getElementById('editMemFather').value = m.fatherName || '';
                document.getElementById('editMemDob').value = m.dob || '';
                document.getElementById('editMemMobile').value = m.mobile;
                document.getElementById('editMemPass').value = m.password || '';
                document.getElementById('editMemWorkDist').value = m.workDistrict || m.work_district || '';
                document.getElementById('editMemHomeDist').value = m.homeDistrict || m.home_district || '';
                document.getElementById('editMemDept').value = m.department;
                document.getElementById('editMemPost').value = m.post;
                document.getElementById('editMemAddress').value = m.address || m.homeAddress || '';

                // Populate datalists if empty
                if (document.getElementById('district_list_edit').options.length === 0) {
                    const districts = [];
                    for (let div in locationData) {
                        locationData[div].districts.forEach(d => { if (!districts.includes(d)) districts.push(d); });
                    }
                    document.getElementById('district_list_edit').innerHTML = districts.sort().map(d => `<option value="${d}">`).join('');
                }

                document.getElementById('editMemberModal').style.display = 'flex';
            }
        };

        window.saveMemberEdit = async function () {
            const id = parseInt(document.getElementById('editMemId').value);
            let members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
            const m = members.find(m => m.id === id);

            if (m && m.firestoreId) {
                const updates = {
                    name: document.getElementById('editMemName').value,
                    fatherName: document.getElementById('editMemFather').value,
                    dob: document.getElementById('editMemDob').value,
                    mobile: document.getElementById('editMemMobile').value,
                    password: document.getElementById('editMemPass').value,
                    workDistrict: document.getElementById('editMemWorkDist').value,
                    homeDistrict: document.getElementById('editMemHomeDist').value,
                    department: document.getElementById('editMemDept').value,
                    post: document.getElementById('editMemPost').value,
                    address: document.getElementById('editMemAddress').value
                };

                const photoFile = document.getElementById('editMemPhoto').files[0];
                if (photoFile) {
                    updates.photo = await readFile(photoFile);
                }

                window.db.collection('members').doc(m.firestoreId).update(updates)
                    .then(() => {
                        alert('सदस्य विवरण अपडेट किया गया! (Update Sent)');
                        document.getElementById('editMemberModal').style.display = 'none';
                    })
                    .catch(e => alert("Error updating member: " + e.message));

            } else {
                // Fallback Local
                const index = members.findIndex(m => m.id === id);
                if (index !== -1) {
                    members[index].name = document.getElementById('editMemName').value;
                    members[index].fatherName = document.getElementById('editMemFather').value;
                    members[index].dob = document.getElementById('editMemDob').value;
                    members[index].mobile = document.getElementById('editMemMobile').value;
                    members[index].password = document.getElementById('editMemPass').value;
                    members[index].workDistrict = document.getElementById('editMemWorkDist').value;
                    members[index].homeDistrict = document.getElementById('editMemHomeDist').value;
                    members[index].department = document.getElementById('editMemDept').value;
                    members[index].post = document.getElementById('editMemPost').value;
                    members[index].address = document.getElementById('editMemAddress').value;

                    const photoFile = document.getElementById('editMemPhoto').files[0];
                    if (photoFile) {
                        members[index].photo = await readFile(photoFile);
                    }
                    localStorage.setItem('up_sangh_members', JSON.stringify(members));
                    alert('सदस्य विवरण अपडेट किया गया! (Local Only)');
                    document.getElementById('editMemberModal').style.display = 'none';
                    loadDashboardData();
                }
            }
        };

        function renderIssuesTable(data) {
            const tbody = document.querySelector('#issuesTable tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">कोई समस्या प्राप्त नहीं हुई। (No Issues)</td></tr>';
                return;
            }
            let html = '';
            [...data].reverse().forEach((issue, i) => {
                const isSolved = issue.status === 'Solved';
                const statusBadge = isSolved
                    ? '<span style="color:green; font-weight:bold;">Solved</span>'
                    : '<span style="color:orange; font-weight:bold;">Pending</span>';

                const solveBtn = !isSolved
                    ? `<button onclick="solveIssue(${issue.id})" class="btn btn-sm btn-success" title="Solve problem"><i class="fa-solid fa-check-circle"></i></button>`
                    : '';

                html += `
                    <tr>
                        <td>${issue.date}</td>
                        <td>${issue.name}</td>
                        <td>${issue.mobile}</td>
                        <td>${issue.subject || issue.type}</td>
                        <td>${issue.message}</td>
                        <td>${statusBadge}</td>
                        <td>
                            ${solveBtn}
                            <button onclick="deleteIssue(${issue.id})" class="btn btn-sm btn-danger" title="Delete"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
            tbody.innerHTML = html;
        }

        // --- ACTION FUNCTIONS --- //

        // Helper to read file as Base64
        function readFile(file) {
            return new Promise((resolve) => {
                if (!file) resolve(null);
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        // Add Officer
        window.addOfficer = async function () {
            const name = document.getElementById('offName').value;
            const vibhag = document.getElementById('offVibhag').value;
            const post = document.getElementById('offPost').value;
            const mobile = document.getElementById('offMobile').value;
            const password = document.getElementById('offPass').value;
            const role = document.getElementById('offRole').value;
            const division = document.getElementById('offDivision').value;
            const district = document.getElementById('offDistrict').value;
            const block = document.getElementById('offBlock').value;
            const father = document.getElementById('offFather').value;
            const address = document.getElementById('offAddress').value;

            const photoFile = document.getElementById('offPhoto').files[0];
            const signFile = document.getElementById('offSign').files[0];

            // Smart Defaults for Admins (Fix for "Profile not creating")
            // If Admin role is selected but Dept/Post not filled, use Role as default
            const finalPost = post || (role.includes('Admin') ? role : '');
            const finalVibhag = vibhag || (role.includes('Admin') ? 'Union Administration' : '');

            // Specific Role Validation
            if (role === 'Division Admin' && !division) {
                alert('Division Admin बनाने के लिए "मंडल (Division)" चुनना अनिवार्य है।');
                return;
            }
            if (role === 'District Admin' && !district) {
                alert('District Admin बनाने के लिए "जिला (District)" चुनना अनिवार्य है।');
                return;
            }
            if (role === 'Block Admin' && (!district || !block)) {
                alert('Block Admin बनाने के लिए "जिला" और "ब्लॉक" चुनना अनिवार्य है।');
                return;
            }

            if (name && finalPost && mobile) {
                const photoBase64 = photoFile ? await readFile(photoFile) : null;
                const signBase64 = signFile ? await readFile(signFile) : null;

                // Check adding user's role
                const sessionStr = localStorage.getItem('up_sangh_current_officer_session');
                const currentUser = sessionStr ? JSON.parse(sessionStr) : null;
                const creatorRole = currentUser ? currentUser.role : 'Super Admin';

                // Only Super/State Admins can add pre-approved officers
                const initialStatus = (creatorRole === 'Super Admin' || creatorRole === 'State Admin') ? 'Approved' : 'Pending';

                const newOfficer = {
                    id: Date.now(),
                    name,
                    vibhag: finalVibhag,
                    post: finalPost,
                    mobile, password, role,
                    division, district, block,
                    fatherName: father, address,
                    photo: photoBase64, sign: signBase64,
                    status: initialStatus,
                    date: new Date().toLocaleDateString('hi-IN')
                };

                window.db.collection('officers').add(newOfficer)
                    .then(() => {
                        // Reset
                        document.querySelectorAll('#section-officers input, #section-officers select').forEach(i => {
                            if (i.type === 'file') i.value = "";
                            else i.value = (i.tagName === 'SELECT' ? (i.options[0] ? i.options[0].value : '') : '');
                        });
                        // Clear post selection specifically as it's dynamic
                        document.getElementById('offPost').innerHTML = '<option value="">-- पद चुनें (Post) --</option>';

                        alert('पदाधिकारी/एडमिन सफलतापूर्वक जोड़े गए! (Officer Added to Cloud)');
                    })
                    .catch(err => {
                        console.error("Add Officer Error", err);
                        alert("Error adding officer to cloud.");
                    });

            } else {
                alert('कृपया नाम (Name), मोबाइल (Mobile) और पद (Post) भरना अनिवार्य है।');
            }
        };

        // Edit Officer
        window.openEditOfficer = function (id) {
            const officers = JSON.parse(localStorage.getItem('up_sangh_officers')) || [];
            const o = officers.find(x => x.id === id);
            if (o) {
                document.getElementById('editOffId').value = o.id;
                document.getElementById('editOffName').value = o.name;
                document.getElementById('editOffVibhag').value = o.vibhag || '';

                // Populate Posts based on Vibhag
                handleVibhagChange('edit', o.post);

                document.getElementById('editOffMobile').value = o.mobile;
                document.getElementById('editOffPass').value = o.password || '';
                document.getElementById('editOffRole').value = o.role || 'Officer';

                // Hierarchical Location Loading
                const divEl = document.getElementById('editOffDivision');
                divEl.value = o.division || '';

                // Populate Districts based on Division
                handleLocationChange('edit', 'division', o.district);

                // Populate Blocks based on District
                if (o.district) {
                    handleLocationChange('edit', 'district', o.block);
                    document.getElementById('editOffBlock').value = o.block || '';
                }

                document.getElementById('editOffFather').value = o.fatherName || '';
                document.getElementById('editOffAddress').value = o.address || '';

                handleRoleChange('edit'); // Set visibility based on loaded role
                document.getElementById('editOfficerModal').style.display = 'flex';
            }
        }

        window.saveOfficerEdit = async function () {
            const id = parseInt(document.getElementById('editOffId').value);
            let officers = JSON.parse(localStorage.getItem('up_sangh_officers')) || [];
            // Try to find the document with firestoreId if available.
            // Since we sync, the local object might have firestoreId if it came from sync.
            // If not, we have to find by ID then query cloud (inefficient but works if ID is unique timestamp).
            // Better: our Sync logic saves firestoreId? Wait, script.js stores firestoreId? None of the snapshot code in script.js stored firestoreId for officers! I added it for members only.
            // I MUST UPDATE script.js snapshot for officers too!
            // Or update the snapshot logic IN THIS FILE to store firestoreId for officers.
            // I added `data.firestoreId = doc.id` for members in my replacement above.
            // I should do it for officers too.
            // Let's assume I fix the officer snapshot logic in the replacement above.
            // I WILL FIX IT IN THE REPLACEMENT ABOVE (Lines 1462+).
            // (Self-correction: I will update the Officer Sync logic in the first chunk to include ID).

            const o = officers.find(x => x.id === id);

            // Re-find in cloud if possible or use local match
            if (o) {
                const updates = {
                    name: document.getElementById('editOffName').value,
                    vibhag: document.getElementById('editOffVibhag').value,
                    post: document.getElementById('editOffPost').value,
                    mobile: document.getElementById('editOffMobile').value,
                    password: document.getElementById('editOffPass').value,
                    role: document.getElementById('editOffRole').value,
                    division: document.getElementById('editOffDivision').value,
                    district: document.getElementById('editOffDistrict').value,
                    block: document.getElementById('editOffBlock').value,
                    fatherName: document.getElementById('editOffFather').value,
                    address: document.getElementById('editOffAddress').value
                };

                const photoFile = document.getElementById('editOffPhoto').files[0];
                const signFile = document.getElementById('editOffSign').files[0];

                if (photoFile) updates.photo = await readFile(photoFile);
                if (signFile) updates.sign = await readFile(signFile);

                // Find Firestore Doc ID
                // If we have o.firestoreId, use it.
                // If not, we have to query.
                let docId = o.firestoreId;
                if (!docId) {
                    // Try query by 'id' field (timestamp)
                    try {
                        const qs = await window.db.collection('officers').where('id', '==', id).get();
                        if (!qs.empty) docId = qs.docs[0].id;
                    } catch (err) { console.error(err); }
                }

                if (docId) {
                    window.db.collection('officers').doc(docId).update(updates).then(() => {
                        alert("Officer Updated (Cloud)");
                        document.getElementById('editOfficerModal').style.display = 'none';
                    });
                } else {
                    // Fallback Local
                    alert("Cloud record not found. Updating local only.");
                    const index = officers.findIndex(x => x.id === id);
                    if (index !== -1) {
                        Object.assign(officers[index], updates);
                        localStorage.setItem('up_sangh_officers', JSON.stringify(officers));
                        loadDashboardData();
                        document.getElementById('editOfficerModal').style.display = 'none';
                    }
                }
            }
        };

        // Delete Functions
        window.deleteOfficer = async function (id) {
            if (confirm('हटाना चाहते हैं?')) {
                // Find ID
                const officers = JSON.parse(localStorage.getItem('up_sangh_officers')) || [];
                const o = officers.find(x => x.id === id);
                let docId = o ? o.firestoreId : null;
                if (!docId) {
                    const qs = await window.db.collection('officers').where('id', '==', id).get();
                    if (!qs.empty) docId = qs.docs[0].id;
                }

                if (docId) {
                    window.db.collection('officers').doc(docId).delete().then(() => alert("Deleted from Cloud"));
                } else {
                    let newOfficers = officers.filter(o => o.id !== id);
                    localStorage.setItem('up_sangh_officers', JSON.stringify(newOfficers));
                    loadDashboardData();
                }
            }
        };

        window.deleteIssue = async function (id) {
            if (confirm('हटाना चाहते हैं?')) {
                const qs = await window.db.collection('issues').where('id', '==', id).get();
                if (!qs.empty) {
                    qs.docs[0].ref.delete().then(() => alert("Issue Deleted"));
                } else {
                    // Local fallback
                    let issues = JSON.parse(localStorage.getItem('up_sangh_issues')) || [];
                    issues = issues.filter(i => i.id !== id);
                    localStorage.setItem('up_sangh_issues', JSON.stringify(issues));
                    loadDashboardData();
                }
            }
        };

        window.solveIssue = async function (id) {
            if (confirm('क्या आप इस समस्या को "Solved" मार्क करना चाहते हैं?')) {
                const qs = await window.db.collection('issues').where('id', '==', id).get();
                if (!qs.empty) {
                    qs.docs[0].ref.update({ status: 'Solved' }).then(() => alert("Marked Solved"));
                } else {
                    let issues = JSON.parse(localStorage.getItem('up_sangh_issues')) || [];
                    const index = issues.findIndex(i => i.id === id);
                    if (index !== -1) {
                        issues[index].status = 'Solved';
                        localStorage.setItem('up_sangh_issues', JSON.stringify(issues));
                        alert('समस्या हल की गई (Issue Marked as Solved)!');
                        loadDashboardData();
                    }
                }
            }
        };

        // deleteMember is already global in script.js but we may need to reload dashboard
        const originalDeleteMember = window.deleteMember;
        window.deleteMember = async function (id) {
            if (confirm('क्या आप सुनिश्चित हैं कि आप इस सदस्य को हटाना चाहते हैं?')) {
                // Find Firestore ID
                const members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
                const m = members.find(x => x.id === id);
                if (m && m.firestoreId) {
                    window.db.collection('members').doc(m.firestoreId).delete().then(() => {
                        alert("Member Deleted (Cloud)");
                    });
                } else {
                    // Only Local
                    let newMembers = members.filter(m => m.id !== id);
                    localStorage.setItem('up_sangh_members', JSON.stringify(newMembers));
                    loadDashboardData();
                }
            }
        }

        window.verifyMember = async function (id) {
            console.log("verifyMember called for ID:", id);
            let members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
            // Use loose comparison (==) to handle string/number diffs
            const m = members.find(m => m.id == id);

            if (!m) {
                alert("Member not found in local data!");
                return;
            }

            if (m.firestoreId) {
                console.log("Attempting Cloud Verification for:", m.firestoreId);
                window.db.collection('members').doc(m.firestoreId).update({ status: 'Approved' })
                    .then(() => {
                        alert('सदस्य सत्यापित किया गया (Cloud Verified)!');
                        loadDashboardData();
                    })
                    .catch(err => {
                        console.error("Cloud Verify Error:", err);
                        alert("Verification Failed: " + err.message);
                    });
            } else {
                console.log("Local Verification");
                const index = members.findIndex(m => m.id == id);
                if (index !== -1) {
                    members[index].status = 'Approved';
                    localStorage.setItem('up_sangh_members', JSON.stringify(members));
                    alert('सदस्य सत्यापित किया गया (Local Verified)!');
                    loadDashboardData();
                }
            }
        };

        window.generateMockFees = function () {
            let members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
            if (members.length === 0) {
                alert("कोई सदस्य नहीं मिला। पहले डमी सदस्य बनाएँ।");
                return;
            }
            members.forEach(m => {
                m.fee_status = Math.random() > 0.5 ? 'Paid' : 'Pending';
                m.id_card_status = m.fee_status === 'Paid' && Math.random() > 0.3 ? 'Generated' : 'Not Generated';
                if (m.fee_status === 'Paid') m.payment_date = new Date().toISOString();
            });
            localStorage.setItem('up_sangh_members', JSON.stringify(members));
            alert("डमी शुल्क डेटा जनरेट किया गया! (Mock Fees Generated)");
            if (document.getElementById('section-id-cards-fees').classList.contains('active')) {
                loadIDCardsFeesData();
            }
        };

        window.verifyOfficer = async function (id) {
            if (!confirm('क्या आप इस पदाधिकारी को सत्यापित करना चाहते हैं?')) return;
            let officers = JSON.parse(localStorage.getItem('up_sangh_officers')) || [];
            const o = officers.find(x => x.id === id);
            if (o) {
                const qs = await window.db.collection('officers').where('id', '==', id).get();
                if (!qs.empty) {
                    qs.docs[0].ref.update({ status: 'Approved' }).then(() => alert("Officer Verified (Cloud)"));
                } else {
                    o.status = 'Approved';
                    localStorage.setItem('up_sangh_officers', JSON.stringify(officers));
                    alert("Officer Verified (Local)");
                    loadDashboardData();
                }
            }
        };

        window.rejectMember = async function (id) {
            if (confirm('क्या आप सुनिश्चित हैं कि आप इस आवेदन को अस्वीकार (Reject) करना चाहते हैं?')) {
                let members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
                const m = members.find(m => m.id == id);

                if (m && m.firestoreId) {
                    window.db.collection('members').doc(m.firestoreId).update({ status: 'Rejected' })
                        .then(() => {
                            alert("Rejected (Cloud)");
                            loadDashboardData();
                        })
                        .catch(err => {
                            console.error("Cloud Reject Error:", err);
                            alert("Rejection Failed: " + err.message);
                        });
                } else {
                    const index = members.findIndex(m => m.id == id);
                    if (index !== -1) {
                        members[index].status = 'Rejected';
                        localStorage.setItem('up_sangh_members', JSON.stringify(members));
                        alert('आवेदन अस्वीकार कर दिया गया (Local Only)!');
                        loadDashboardData();
                    }
                }
            }
        };

        window.filterTables = function (tableId, inputId) {
            const input = document.getElementById(inputId);
            const filter = input.value.toLowerCase();
            const table = document.getElementById(tableId);
            const tr = table.getElementsByTagName("tr");

            for (let i = 1; i < tr.length; i++) {
                let rowText = tr[i].innerText.toLowerCase();
                tr[i].style.display = rowText.includes(filter) ? "" : "none";
            }
        };

        window.openAddMemberModal = function () {
            // Populate datalists in modal
            const districts = [];
            for (let div in locationData) {
                locationData[div].districts.forEach(d => { if (!districts.includes(d)) districts.push(d); });
            }
            document.getElementById('district_list_mem').innerHTML = districts.sort().map(d => `<option value="${d}">`).join('');

            const depts = Object.keys(vibhagData);
            document.getElementById('dept_list_mem').innerHTML = depts.map(d => `<option value="${d}">`).join('');

            // Generic posts
            const posts = ["अध्यक्ष", "उपाध्यक्ष", "मंत्री", "सदस्य", "कंप्यूटर ऑपरेटर", "ड्राइवर", "सहायक"];
            document.getElementById('post_list_mem').innerHTML = posts.map(p => `<option value="${p}">`).join('');

            document.getElementById('addMemberModal').style.display = 'flex';
        };

        window.saveNewMember = async function () {
            const name = document.getElementById('newMemName').value;
            const father = document.getElementById('newMemFather').value;
            const dob = document.getElementById('newMemDob').value;
            const mobile = document.getElementById('newMemMobile').value;
            const pass = document.getElementById('newMemPass').value;
            const workDist = document.getElementById('newMemWorkDist').value;
            const homeDist = document.getElementById('newMemHomeDist').value;
            const dept = document.getElementById('newMemDept').value;
            const post = document.getElementById('newMemPost').value;
            const addr = document.getElementById('newMemAddress').value;
            const photoFile = document.getElementById('newMemPhoto').files[0];

            if (name && mobile && dept && post) {
                let photoBase64 = "";
                if (photoFile) photoBase64 = await readFile(photoFile);

                const newMember = {
                    id: Date.now(),
                    name,
                    fatherName: father,
                    dob,
                    mobile,
                    password: pass,
                    workDistrict: workDist,
                    homeDistrict: homeDist,
                    homeAddress: addr, // Map to homeAddress for consistency
                    department: dept,
                    post,
                    photo: photoBase64,
                    status: 'Pending',
                    date: new Date().toLocaleDateString('hi-IN')
                };

                window.db.collection('members').add(newMember).then((docRef) => {
                    // Success
                    alert('सदस्य सफलतापूर्वक जोड़ा गया! (Saved to Cloud)');
                    document.getElementById('addMemberModal').style.display = 'none';
                    // Reset form
                    ['newMemName', 'newMemFather', 'newMemDob', 'newMemMobile', 'newMemPass', 'newMemWorkDist', 'newMemHomeDist', 'newMemDept', 'newMemPost', 'newMemAddress'].forEach(id => document.getElementById(id).value = '');
                    document.getElementById('newMemPhoto').value = '';
                }).catch(err => {
                    console.error("Save Member Error", err);
                    alert("Error saving member to cloud");
                });

            } else {
                alert('कृपया मुख्य जानकारी भरें!');
            }
        };

        window.processProfileRequest = async function (reqId) {
            try {
                // Fetch latest requests from Cloud/Local
                const requests = JSON.parse(localStorage.getItem('up_sangh_requests')) || [];
                const req = requests.find(r => r.reqId === reqId);
                if (!req) { alert("Request not found."); return; }

                // --- BRANCH: Donation (Sahyog) ---
                if (req.type === 'Donation') {
                    // ... (Existing donation logic usually just updates local, need to see if we track donations in Cloud)
                    // Assuming 'member_donations' collection is needed? Or just update request status?
                    // For now, I will just update Request Status in Cloud.
                    // And maybe update Member's donation record if it exists in their doc?
                    // Current system uses 'up_sangh_member_donations'.
                    // I will update the Request in Cloud first.

                    const amt = req.amount || 0;
                    const txn = req.txnId || 'N/A';
                    if (confirm(`Process Donation for ${req.name}?\nAmount: ₹${amt}\nTxn ID: ${txn}\n\nClick OK to Approve.`)) {
                        // Find Request Doc
                        const qs = await window.db.collection('requests').where('reqId', '==', reqId).get();
                        if (!qs.empty) {
                            qs.docs[0].ref.update({ status: 'Approved' }).then(() => alert("Donation Approved (Cloud)"));
                        }
                    }
                    return;
                }

                // --- BRANCH: Renewal/Fee ---
                if (req.type === 'Membership Renewal' || req.type === 'Initial Fee Payment') {
                    const plan = req.membership_plan || 'Yearly';
                    const amt = req.amount || 299;
                    if (confirm(`Process ${req.type} for ${req.name}?\nPlan: ${plan} (₹${amt})\n\nClick OK to Approve.`)) {
                        // Find Member by mobile
                        const memQS = await window.db.collection('members').where('mobile', '==', req.mobile).get();
                        if (!memQS.empty) {
                            const mDoc = memQS.docs[0];
                            const updates = {
                                fee_status: 'Paid',
                                membership_plan: plan,
                                membership_amount: amt,
                                valid_till: (plan === 'Lifetime' ? 'Lifetime' : '31 Dec 2026')
                            };
                            if (req.type === 'Initial Fee Payment') {
                                updates.status = 'Approved';
                                updates.payment_date = new Date().toISOString();
                            }

                            mDoc.ref.update(updates);

                            // Update Request
                            const qs = await window.db.collection('requests').where('reqId', '==', reqId).get();
                            if (!qs.empty) qs.docs[0].ref.update({ status: 'Approved' });

                            alert(req.type + " Approved (Cloud Success)!");
                        } else {
                            alert("Member not found in Cloud.");
                        }
                    }
                    return;
                }

                // --- BRANCH: Profile Update ---
                const c = req.changes;
                // ... msg ...
                if (confirm(`Approve profile updates for ${req.name}?`)) {
                    const memQS = await window.db.collection('members').where('mobile', '==', req.mobile).get();
                    if (!memQS.empty) {
                        const mDoc = memQS.docs[0];
                        const mData = mDoc.data();
                        // Apply
                        const updates = {};
                        Object.keys(c).forEach(key => {
                            if (c[key] !== undefined && c[key] !== null) {
                                let targetKey = key;
                                if (key === 'father_name') targetKey = 'fatherName';
                                if (key === 'home_address') targetKey = 'homeAddress';
                                if (key === 'home_district') targetKey = 'homeDistrict';
                                if (key === 'work_district') targetKey = 'workDistrict';
                                updates[targetKey] = c[key];
                            }
                        });
                        updates.status = 'Approved';

                        await mDoc.ref.update(updates);

                        const qs = await window.db.collection('requests').where('reqId', '==', reqId).get();
                        if (!qs.empty) qs.docs[0].ref.update({ status: 'Approved' });
                        alert('Request Approved! Member profile updated (Cloud).');
                    } else {
                        alert("Member not found in Cloud.");
                    }
                } else if (confirm("Do you want to REJECT this request?")) {
                    const qs = await window.db.collection('requests').where('reqId', '==', reqId).get();
                    if (!qs.empty) qs.docs[0].ref.update({ status: 'Rejected' }).then(() => alert("Request Rejected"));
                }

            } catch (err) {
                console.error("Process Profile Request Error:", err);
                alert("Critical Error: " + err.message);
            }
        };

        window.viewMember = function (id) {
            const members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
            const m = members.find(x => x.id === id);
            if (m) {
                const wDist = m.work_district || m.workDistrict || '--';
                const wTehsil = m.work_tahsil || '';
                const wBlock = m.work_block || m.block || '';

                const hDist = m.home_district || m.homeDistrict || '--';
                const hTehsil = m.home_tahsil || '';
                const hBlock = m.home_block || '';

                const content = `
                    <div style="display:flex; gap:20px; align-items:start; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            ${m.photo ? `<img src="${m.photo}" style="width:120px; border-radius:8px; border:1px solid #ddd;">` : '<i class="fa-solid fa-user-circle" style="font-size:120px; color:#ccc;"></i>'}
                            <div style="margin-top:10px;">
                                <strong>हस्ताक्षर (Signature):</strong><br>
                                ${m.signature ? `<img src="${m.signature}" style="max-width:150px; height:60px; object-fit:contain; border:1px solid #eee; margin-top:5px; background:#f9f9f9;">` : '<span style="color:#999; font-size:0.8rem;">Not Uploaded</span>'}
                            </div>
                        </div>
                        <div style="flex:1; min-width: 250px;">
                            <h2 style="margin:0;">${m.name}</h2>
                            <p style="color:#666;">Status: <strong style="color:${m.status === 'Approved' ? 'green' : (m.status === 'Rejected' ? 'red' : 'orange')}">${m.status}</strong></p>
                            <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:0.9rem;">
                                <span><strong>पिता:</strong> ${m.father_name || m.fatherName || '--'}</span>
                                <span><strong>मोबाइल:</strong> ${m.mobile}</span>
                                <span><strong>जन्म तिथि:</strong> ${m.dob || '--'}</span>
                                <span><strong>विभाग:</strong> ${m.department}</span>
                                <span><strong>पद:</strong> ${m.post}</span>
                                <span><strong>कार्यस्थल (District-T-B):</strong><br>${wDist}${wTehsil ? ' - ' + wTehsil : ''}${wBlock ? ' - ' + wBlock : ''}</span>
                                <span><strong>गृह जनपद (District-T-B):</strong><br>${hDist}${hTehsil ? ' - ' + hTehsil : ''}${hBlock ? ' - ' + hBlock : ''}</span>
                            </div>
                            <div style="margin-top:15px; font-size:0.9rem;">
                                <strong>पूरा पता (Address Details):</strong><br>
                                ${m.home_address || m.homeAddress || m.address || '--'}
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('memberProfileContent').innerHTML = content;
                document.getElementById('viewMemberModal').style.display = 'flex';
            }
        };

        // --- Mock Data Generation Tools ---
        window.generateMockMembers = function (count) {
            if (!confirm(`क्या आप ${count} डमी सदस्य जोड़ना चाहते हैं?`)) return;

            const names = ["अमित कुमार", "राजेश सिंह", "सुनील वर्मा", "नेहा शर्मा", "विकास यादव", "संदीप मोर्या", "दीपक गुप्ता", "राहुल तिवारी", "मनोज कुशवाहा", "प्रियंका भारती"];
            const districts = ["लखनऊ", "कानपुर", "वाराणसी", "प्रयागराज", "मेरठ", "गोरखपुर", "झाँसी", "बरेली", "अलीगढ़", "मथुरा"];
            const depts = ["स्वास्थ्य", "शिक्षा", "राजस्व", "पुलिस", "पशुपालन", "नगर निगम", "लोक निर्माण", "कृषि"];
            const posts = ["कनिष्ठ सहायक", "कंप्यूटर ऑपरेटर", "ड्राइवर", "सहायक", "प्यून", "मैनेजर"];

            let members = JSON.parse(localStorage.getItem('up_sangh_members')) || [];
            const timestamp = Date.now();

            for (let i = 1; i <= count; i++) {
                const randomName = names[Math.floor(Math.random() * names.length)];
                const randomDist = districts[Math.floor(Math.random() * districts.length)];
                const randomDept = depts[Math.floor(Math.random() * depts.length)];
                const randomPost = posts[Math.floor(Math.random() * posts.length)];

                members.push({
                    id: timestamp + i,
                    name: `${randomName} (${i})`,
                    fatherName: "श्री जनक राम",
                    dob: "1990-01-01",
                    mobile: `9${Math.floor(Math.random() * 900000000 + 100000000)}`,
                    password: "123",
                    workDistrict: randomDist,
                    homeDistrict: randomDist,
                    homeAddress: `ग्राम-पोस्ट, जिला-${randomDist}`,
                    department: randomDept,
                    post: randomPost,
                    photo: "",
                    status: 'Approved',
                    date: new Date().toLocaleDateString('hi-IN')
                });
            }

            localStorage.setItem('up_sangh_members', JSON.stringify(members));
            alert(`${count} सदस्य सफलतापूर्वक जोड़े गए!`);
            loadDashboardData();
        };

        window.generateMockDistrictAdmins = function () {
            if (!confirm('क्या आप प्रत्येक जिले के लिए एक डमी "जिला एडमिन" जोड़ना चाहते हैं?')) return;

            let officers = JSON.parse(localStorage.getItem('up_sangh_officers')) || [];
            const timestamp = Date.now();
            let count = 0;

            const allDists = [];
            for (let div in locationData) {
                locationData[div].districts.forEach(d => { if (!allDists.includes(d)) allDists.push(d); });
            }

            allDists.forEach((dist, index) => {
                officers.push({
                    id: timestamp + index,
                    name: `${dist} Admin`,
                    fatherName: "श्री एडमिन पिता",
                    mobile: `8${(100 + index).toString().padStart(9, '0')}`, // Unique 10-digit starting with 8
                    password: "123",
                    role: 'District Admin',
                    district: dist,
                    division: "",
                    block: "",
                    vibhag: "अन्य विभाग (Others)",
                    post: "जिला अध्यक्ष",
                    address: `${dist}, उत्तर प्रदेश`,
                    photo: "",
                    sign: "",
                    status: 'Approved',
                    date: new Date().toLocaleDateString('hi-IN')
                });
                count++;
            });

            localStorage.setItem('up_sangh_officers', JSON.stringify(officers));
            alert(`${count} जिला एडमिन सफलतापूर्वक जोड़े गए! पासवर्ड '123' है।`);
            loadDashboardData();
        };

        window.clearAllMembers = function () {
            if (confirm('क्या आप सुनिश्चित हैं कि आप सभी सदस्यों को हटाना चाहते हैं? यह प्रक्रिया वापस नहीं ली जा सकती।')) {
                localStorage.removeItem('up_sangh_members');
                alert('सभी सदस्य हटा दिए गए।');
                loadDashboardData();
            }
        };

        window.clearAllOfficers = function () {
            if (confirm('क्या आप सभी पदाधिकारियों को हटाना चाहते हैं? आपको फिर से लॉगिन करना पड़ सकता है यदि आपका अकाउंट इसमें शामिल है।')) {
                localStorage.removeItem('up_sangh_officers');
                alert('सभी पदाधिकारी हटा दिए गए।');
                loadDashboardData();
            }
        };

        window.generateMockIssues = function () {
            const types = ["पेमेंट समस्या (Payment Issue)", "रजिस्ट्रेशन त्रुटि (Reg Error)", "आईडी कार्ड नहीं मिला (ID Card Pending)", "लॉगिन समस्या (Login Issue)"];
            const names = ["रामसेवक", "हरिप्रसाद", "ओमप्रकाश", "शिव कुमार", "मुन्नी देवी"];
            const subjects = ["वेतन नहीं मिला", "डेटा गलत है", "कार्ड कब आएगा?", "लॉगिन नहीं हो रहा"];
            const issues = [];
            const timestamp = Date.now();

            for (let i = 1; i <= 20; i++) {
                issues.push({
                    id: timestamp + i,
                    name: names[Math.floor(Math.random() * names.length)],
                    mobile: `7${Math.floor(Math.random() * 900000000 + 100000000)}`,
                    subject: subjects[Math.floor(Math.random() * subjects.length)],
                    type: types[Math.floor(Math.random() * types.length)],
                    message: `यह एक डमी शिकायत संख्या ${i} है जो टेस्टिंग के लिए बनाई गई है।`,
                    status: Math.random() > 0.5 ? 'Solved' : 'Pending',
                    date: new Date().toLocaleDateString('hi-IN')
                });
            }
            localStorage.setItem('up_sangh_issues', JSON.stringify(issues));
            alert('20 डमी समस्याएं जनरेट की गईं!');
            loadDashboardData();
        };

        window.generateCompleteMockDataset = function () {
            if (!confirm('क्या आप सभी सेक्शन के लिए पूरा डमी डेटा जनरेट करना चाहते हैं?')) return;

            // 1. Members
            generateMockMembers(100);
            // 2. Officers
            generateMockDistrictAdmins();
            // 3. Reports
            generateMockReports();
            // 4. Issues
            generateMockIssues();
            // 5. Finance
            generateMockFinanceData();

            alert('पूरा डमी डेटासेट सफलतापूर्वक जनरेट किया गया!');
            loadDashboardData();
        };

        window.clearAllData = function () {
            if (!confirm('क्या आप पूरे डेटाबेस (सदस्य, पदाधिकारी, रिपोर्ट, समस्याएं, फाइनेंस) को साफ़ करना चाहते हैं?')) return;

            localStorage.removeItem('up_sangh_members');
            localStorage.removeItem('up_sangh_officers');
            localStorage.removeItem('up_sangh_reports');
            localStorage.removeItem('up_sangh_issues');
            localStorage.removeItem('up_sangh_finance');

            alert('सारा डेटा क्लियर कर दिया गया है।');
            loadDashboardData();
        };

        // --- NEW: FINANCIAL REPORTS LOGIC --- //
        window.switchReportTab = function (type) {
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));

            if (type === 'monthly') {
                document.getElementById('tab-monthly').classList.add('active');
                document.getElementById('report-view-monthly').classList.add('active');
                loadReportsData();
            } else {
                document.getElementById('tab-finance').classList.add('active');
                document.getElementById('report-view-finance').classList.add('active');
                loadFinanceData();
            }
        };

        window.generateMockFinanceData = function () {
            const months = ['January 2024', 'February 2024', 'March 2024', 'April 2024'];
            const finance = [];
            months.forEach(m => {
                const income = Math.floor(Math.random() * 50000) + 10000;
                const expense = Math.floor(Math.random() * 30000) + 5000;
                finance.push({
                    month: m,
                    income: income,
                    expense: expense,
                    balance: income - expense,
                    cash: (income - expense) * 0.8,
                    remarks: "Monthly Collection & Regular Expenses"
                });
            });
            localStorage.setItem('up_sangh_finance', JSON.stringify(finance));
            if (document.getElementById('tab-finance') && document.getElementById('tab-finance').classList.contains('active')) {
                loadFinanceData();
            }
        };

        window.loadFinanceData = function () {
            const data = JSON.parse(localStorage.getItem('up_sangh_finance')) || [];
            const tbody = document.querySelector('#financeTable tbody');
            if (!tbody) return;

            let html = '';
            data.forEach(f => {
                html += `
                    <tr>
                        <td>${f.month}</td>
                        <td style="color:green; font-weight:bold;">₹${f.income.toLocaleString()}</td>
                        <td style="color:red;">₹${f.expense.toLocaleString()}</td>
                        <td style="color:blue; font-weight:bold;">₹${f.balance.toLocaleString()}</td>
                        <td>₹${f.cash.toLocaleString()}</td>
                        <td><small>${f.remarks}</small></td>
                        <td><button class="btn btn-sm btn-primary" onclick="viewInvoice('${f.month}')"><i class="fa-solid fa-file-invoice"></i> View</button></td>
                    </tr>
                `;
            });
            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align:center;">No financial data found.</td></tr>';
        };

        window.viewMonthlyReportInvoice = function (reportId) {
            try {
                const reports = JSON.parse(localStorage.getItem('up_sangh_reports')) || [];
                const rid = parseInt(reportId);
                const r = reports.find(x => x.id === rid);
                if (!r) {
                    alert("Report not found for ID: " + rid);
                    return;
                }

                const html = `
                <div class="invoice-header">
                    <div>
                        <div class="invoice-title">MONTHLY REGISTRATION REPORT</div>
                        <p style="margin:5px 0; color:#666;">उ.प्र. आउटसोर्सिंग एवं संविदा कर्मचारी संघ</p>
                    </div>
                    <div style="text-align:right;">
                        <img src="admin_logo.jpg" style="width:60px; height:60px; border-radius:50%; margin-bottom:5px;">
                        <div style="font-weight:bold;">Report ID: #R-${r.id}</div>
                        <div>Month: ${r.month}</div>
                        <div>Printed: ${new Date().toLocaleDateString('en-GB')}</div>
                    </div>
                </div>

                <div class="invoice-details">
                    <div style="border:1px solid #eee; padding:15px; border-radius:8px; background:#f9f9f9;">
                        <h4 style="margin-top:0; color:#007bff; border-bottom:1px solid #eee; padding-bottom:5px;">Jurisdiction Info</h4>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Division (मंडल):</span>
                            <span style="font-weight:bold;">${r.division}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>District (जिला):</span>
                            <span style="font-weight:bold;">${r.district}</span>
                        </div>
                    </div>
                    <div style="border:1px solid #eee; padding:15px; border-radius:8px; background:#f9f9f9;">
                        <h4 style="margin-top:0; color:#28a745; border-bottom:1px solid #eee; padding-bottom:5px;">Report Status</h4>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Submitted:</span>
                            <span style="font-weight:bold;">${r.month}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Verification:</span>
                            <span style="font-weight:bold; color:green;">${r.status}</span>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom:10px; border-left:4px solid #007bff; padding-left:10px;">Membership Statistics</h3>
                <table style="width:100%; border-collapse: collapse; margin-bottom: 20px; border:1px solid #eee;">
                    <thead>
                        <tr style="background:#f8f9fa;">
                            <th style="padding:15px; border-bottom:2px solid #333; text-align:left;">Category</th>
                            <th style="padding:15px; border-bottom:2px solid #333; text-align:right;">Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding:12px; border-bottom:1px solid #eee;">Total Registrations (कुल पंजीकरण)</td>
                            <td style="padding:12px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; font-size:1.1rem;">${r.total_members}</td>
                        </tr>
                        <tr>
                            <td style="padding:12px; border-bottom:1px solid #eee;">Verified / Active Members (सक्रिय सदस्य)</td>
                            <td style="padding:12px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; font-size:1.1rem; color:green;">${r.active_members}</td>
                        </tr>
                        <tr>
                            <td style="padding:12px; border-bottom:1px solid #eee;">Awaiting Approval (लंबित)</td>
                            <td style="padding:12px; border-bottom:1px solid #eee; text-align:right;">${r.total_members - r.active_members}</td>
                        </tr>
                    </tbody>
                </table>

                <div style="margin-top:40px; display:flex; justify-content:space-between; align-items:flex-end;">
                    <div style="font-size:0.85rem; color:#888;">
                        * This report is generated by the Central Admin Panel.<br>
                        * Unauthorized reproduction is prohibited.<br>
                        * Verified by: Automated System (UP Sangh HQ)
                    </div>
                    <div style="text-align:center; width:180px;">
                        <div style="height:50px; border-bottom:1px solid #333; margin-bottom:5px;"></div>
                        <div style="font-size:0.85rem; font-weight:bold;">General Secretary</div>
                        <div style="font-size:0.75rem; color:#666;">उ.प्र. आउटसोर्सिंग एवं संविदा कर्मचारी संघ</div>
                    </div>
                </div>
            `;
                document.getElementById('invoiceContent').innerHTML = html;
                document.getElementById('viewInvoiceModal').style.display = 'flex';
            } catch (err) {
                console.error("Invoice Error:", err);
                alert("विवरण लोड करने में समस्या आई! (View Error)");
            }
        };

        window.viewInvoice = function (monthStr) {
            try {
                const data = JSON.parse(localStorage.getItem('up_sangh_finance')) || [];
                const item = data.find(x => x.month === monthStr);
                if (!item) {
                    alert("Finance data not found for " + monthStr);
                    return;
                }

                const html = `
                <div class="invoice-header">
                    <div>
                        <div class="invoice-title">FINANCIAL REPORT</div>
                        <p style="margin:5px 0; color:#666;">उ.प्र. आउटसोर्सिंग एवं संविदा कर्मचारी संघ</p>
                    </div>
                    <div style="text-align:right;">
                        <img src="admin_logo.jpg" style="width:60px; height:60px; border-radius:50%; margin-bottom:5px;">
                        <div style="font-weight:bold;">Month: ${item.month}</div>
                        <div>Date: ${new Date().toLocaleDateString('en-GB')}</div>
                    </div>
                </div>

                <div class="invoice-details">
                    <div style="border:1px solid #eee; padding:15px; border-radius:8px;">
                        <h4 style="margin-top:0; color:#007bff; border-bottom:1px solid #eee; padding-bottom:5px;">Income Summary</h4>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Membership Fees:</span>
                            <span style="font-weight:bold; color:green;">₹${item.income.toLocaleString()}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Donations:</span>
                            <span style="font-weight:bold; color:green;">₹0</span>
                        </div>
                    </div>
                    <div style="border:1px solid #eee; padding:15px; border-radius:8px;">
                        <h4 style="margin-top:0; color:#dc3545; border-bottom:1px solid #eee; padding-bottom:5px;">Expense Summary</h4>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Operating Costs:</span>
                            <span style="font-weight:bold; color:red;">₹${item.expense.toLocaleString()}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span>Misc Expenses:</span>
                            <span style="font-weight:bold; color:red;">₹0</span>
                        </div>
                    </div>
                </div>

                <table style="width:100%; border-collapse: collapse; margin-bottom: 20px; border:1px solid #eee;">
                    <tr style="background:#f8f9fa;">
                        <th style="padding:15px; border-bottom:2px solid #333;">Description</th>
                        <th style="padding:15px; border-bottom:2px solid #333; text-align:right;">Amount</th>
                    </tr>
                    <tr>
                        <td style="padding:12px; border-bottom:1px solid #eee;">Total Monthly Income (Praptee)</td>
                        <td style="padding:12px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; color:green;">₹${item.income.toLocaleString()}</td>
                    </tr>
                    <tr>
                        <td style="padding:12px; border-bottom:1px solid #eee;">Total Monthly Expenses (Vyay)</td>
                        <td style="padding:12px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; color:red;">₹${item.expense.toLocaleString()}</td>
                    </tr>
                    <tr style="background:#eef2f7;">
                        <td style="padding:15px; font-weight:bold; font-size:1.1rem;">NET BALANCE (Shesh)</td>
                        <td style="padding:15px; text-align:right; font-weight:bold; font-size:1.1rem; color:#007bff;">₹${item.balance.toLocaleString()}</td>
                    </tr>
                </table>

                <div style="margin-top:30px; display:flex; justify-content:space-between; align-items:flex-end;">
                    <div style="font-size:0.85rem; color:#888;">
                        * This is an automated financial report.<br>
                        * Remarks: ${item.remarks}
                    </div>
                    <div style="text-align:center; width:150px;">
                        <div style="height:40px; border-bottom:1px solid #333; margin-bottom:5px;"></div>
                        <div style="font-size:0.8rem; font-weight:bold;">Authorized Signatory</div>
                        <div style="font-size:0.7rem; color:#666;">(Accountant - UP Sangh)</div>
                    </div>
                </div>
            `;
                document.getElementById('invoiceContent').innerHTML = html;
                document.getElementById('viewInvoiceModal').style.display = 'flex';
            } catch (err) {
                console.error("Finance View Error:", err);
                alert("वित्तीय विवरण लोड करने में त्रुटि! (View Error)");
            }
        };

        window.printInvoice = function () {
            try {
                window.focus();
                window.print();
            } catch (e) {
                console.error("Print error:", e);
                alert("प्रिंटिंग में समस्या आई! (Print Error)");
            }
        };

        window.downloadInvoicePDF = function (btnElement) {
            if (typeof window.jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                alert("Libraries (jsPDF/html2canvas) not loaded. Please check your internet connection and refresh.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const content = document.getElementById('invoiceContent');
            if (!content) return;

            const btn = btnElement || (typeof event !== 'undefined' ? (event.currentTarget || event.target) : null);
            let oldText = "";
            if (btn) {
                btn.disabled = true;
                oldText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> कृपया प्रतीक्षा करें...';
            }

            html2canvas(content, {
                scale: 3, // Even higher quality
                useCORS: true,
                allowTaint: true,
                logging: true,
                backgroundColor: "#ffffff",
                scrollX: 0,
                scrollY: 0,
                windowWidth: 800
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Union_Report_${new Date().getTime()}.pdf`);

                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = oldText || '<i class="fa-solid fa-file-pdf"></i> डाऊनलोड (PDF)';
                }
            }).catch(err => {
                console.error("PDF Export Error:", err);
                alert("PDF जनरेट करने में त्रुटि हुई! (PDF Generation Failed)");
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = oldText || '<i class="fa-solid fa-file-pdf"></i> डाऊनलोड (PDF)';
                }
            });
        };
        window.loadNoticesData = function () {
            const notices = JSON.parse(localStorage.getItem('up_sangh_notices')) || [];
            const tbody = document.getElementById('noticesBody');
            if (!tbody) return;

            tbody.innerHTML = notices.reverse().map(n => `
                <tr>
                    <td>${n.date}</td>
                    <td><strong>${n.title}</strong></td>
                    <td><div style="max-width:300px; font-size:0.85rem;">${n.content}</div></td>
                    <td><span class="badge bg-info">${n.target}</span></td>
                    <td>
                        <button onclick="deleteNotice(${n.id})" class="btn btn-sm btn-outline-danger"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="center-text">कोई नोटिस नहीं मिला।</td></tr>';
        };

        window.publishNotice = function () {
            const title = document.getElementById('noticeTitle').value;
            const content = document.getElementById('noticeContent').value;
            const target = document.getElementById('noticeTarget').value;

            if (!title || !content) { alert("टाइटल और कंटेंट लिखें!"); return; }

            const notice = {
                id: Date.now(),
                title,
                content,
                target,
                date: new Date().toLocaleDateString('hi-IN')
            };

            window.db.collection('notices').add(notice).then(() => {
                document.getElementById('noticeTitle').value = '';
                document.getElementById('noticeContent').value = '';
                alert("नोटिस पब्लिश हो गया! (Cloud Published)");
            });
        };

        window.deleteNotice = async function (id) {
            if (!confirm('मिटाना चाहते हैं?')) return;
            const qs = await window.db.collection('notices').where('id', '==', id).get();
            if (!qs.empty) {
                qs.docs[0].ref.delete().then(() => alert("Deleted (Cloud)"));
            } else {
                let notices = JSON.parse(localStorage.getItem('up_sangh_notices')) || [];
                notices = notices.filter(n => n.id !== id);
                localStorage.setItem('up_sangh_notices', JSON.stringify(notices));
                loadNoticesData();
            }
        };

        // Initialize Notices on Load
        setTimeout(() => {
            if (window.loadNoticesData) loadNoticesData();
        }, 1000);

    </script>

    <!-- Modal Elements (Outside Script) -->
    <!-- View Member Modal -->
    <div id="viewMemberModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:20px; border-radius:10px; width:95%; max-width:600px; max-height: 90vh; overflow-y: auto; position:relative;">
            <button onclick="document.getElementById('viewMemberModal').style.display='none'"
                style="position:absolute; right:15px; top:15px; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            <h3 style="border-bottom:1px solid #eee; padding-bottom:10px;">सदस्य विवरण (Member Profile)</h3>
            <div id="memberProfileContent" style="margin-top:20px;">
                <!-- JS Populated -->
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:20px; border-radius:10px; width:95%; max-width:700px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom:20px;">नया सदस्य जोड़ें (Add New Member)</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <input type="text" id="newMemName" placeholder="नाम (Full Name)"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="newMemFather" placeholder="पिता का नाम (Father Name)"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="date" id="newMemDob" placeholder="DOB"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="newMemMobile" placeholder="मोबाइल नंबर (Mobile)"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="password" id="newMemPass" placeholder="पासवर्ड (Password)"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="newMemWorkDist" list="district_list_mem"
                    placeholder="कार्यस्थल जिला (Work District)"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="newMemHomeDist" list="district_list_mem" placeholder="गृह जनपद (Home District)"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="newMemDept" list="dept_list_mem" placeholder="विभाग (Department)"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="newMemPost" list="post_list_mem" placeholder="पद (Post)"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <textarea id="newMemAddress" placeholder="पूरा पता (Full Address)"
                    style="grid-column: span 2; padding:10px; border:1px solid #ccc; border-radius:4px;"></textarea>

                <div style="grid-column: span 2;">
                    <label style="font-size:0.8rem; display:block; margin-bottom:5px;">सदस्य फोटो (Member Photo -
                        Optional):</label>
                    <input type="file" id="newMemPhoto" accept="image/*"
                        style="width:100%; padding:5px; border:1px solid #ccc; border-radius:4px;">
                </div>

                <datalist id="district_list_mem"></datalist>
                <datalist id="dept_list_mem"></datalist>
                <datalist id="post_list_mem"></datalist>
            </div>
            <div style="margin-top:20px; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="document.getElementById('addMemberModal').style.display='none'"
                    class="btn btn-secondary">Cancel</button>
                <button onclick="saveNewMember()" class="btn btn-success">Save Member</button>
            </div>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editMemberModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:20px; border-radius:10px; width:95%; max-width:700px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom:20px;">सदस्य एडिट करें (Edit Member)</h3>
            <input type="hidden" id="editMemId">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <input type="text" id="editMemName" placeholder="नाम"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="editMemFather" placeholder="पिता का नाम"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="date" id="editMemDob" style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="editMemMobile" placeholder="मोबाइल"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="editMemPass" placeholder="पासवर्ड"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="editMemWorkDist" list="district_list_edit" placeholder="कार्यस्थल जिला"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="editMemHomeDist" list="district_list_edit" placeholder="गृह जनपद"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="editMemDept" placeholder="विभाग"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="editMemPost" placeholder="पद"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <textarea id="editMemAddress" placeholder="पूरा पता"
                    style="grid-column: span 2; padding:10px; border:1px solid #ccc; border-radius:4px;"></textarea>

                <div style="grid-column: span 2;">
                    <label style="font-size:0.8rem;">Update Photo (Optional):</label>
                    <input type="file" id="editMemPhoto" accept="image/*" style="width:100%; padding:5px;">
                </div>
                <datalist id="district_list_edit"></datalist>
            </div>
            <div style="margin-top:20px; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="document.getElementById('editMemberModal').style.display='none'"
                    class="btn btn-secondary">Cancel</button>
                <button onclick="saveMemberEdit()" class="btn btn-success">Update Member</button>
            </div>
        </div>
    </div>

    <!-- Edit Officer Modal (Restored) -->
    <div id="editOfficerModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:20px; border-radius:10px; width:95%; max-width:700px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom:20px;">पदाधिकारी एडिट करें (Edit Officer)</h3>
            <input type="hidden" id="editOffId">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <input type="text" id="editOffName" placeholder="नाम (Name)"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">

                <select id="editOffVibhag" onchange="handleVibhagChange('edit')"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                    <option value="">-- विभाग चुनें (Department) --</option>
                    <option value="Sangh">आउटसोर्सिंग संघ (Sangh)</option>
                    <!-- Populated by JS -->
                </select>

                <select id="editOffPost" style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                    <option value="">-- पद चुनें (Post) --</option>
                </select>

                <input type="text" id="editOffMobile" placeholder="मोबाइल (Mobile)"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="editOffPass" placeholder="पासवर्ड (Password)"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">

                <select id="editOffRole" onchange="handleRoleChange('edit')"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                    <option value="Officer">Officer (Normal)</option>
                    <option value="Block Admin">Block Admin</option>
                    <option value="District Admin">District Admin</option>
                    <option value="Division Admin">Division Admin</option>
                    <option value="State Admin">State Admin</option>
                </select>

                <!-- Location Fields -->
                <select id="editOffDivision" onchange="handleLocationChange('edit', 'division')"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px; display:none;">
                    <option value="">-- मंडल चुनें (Division) --</option>
                    <!-- Populated by JS -->
                </select>

                <select id="editOffDistrict" onchange="handleLocationChange('edit', 'district')"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px; display:none;">
                    <option value="">-- जिला चुनें (District) --</option>
                </select>

                <select id="editOffBlock" style="padding:10px; border:1px solid #ccc; border-radius:4px; display:none;">
                    <option value="">-- ब्लॉक चुनें (Block) --</option>
                </select>

                <input type="text" id="editOffFather" placeholder="पिता का नाम"
                    style="padding:10px; border:1px solid #ccc; border-radius:4px;">
                <textarea id="editOffAddress" placeholder="पूरा पता"
                    style="grid-column:span 2; padding:10px; border:1px solid #ccc; border-radius:4px;"></textarea>

                <div style="grid-column:span 2;">
                    <label>Update Photo:</label>
                    <input type="file" id="editOffPhoto" accept="image/*" style="width:100%;">
                </div>
                <div style="grid-column:span 2;">
                    <label>Update Signature:</label>
                    <input type="file" id="editOffSign" accept="image/*" style="width:100%;">
                </div>
            </div>
            <div style="margin-top:20px; text-align:right; display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="document.getElementById('editOfficerModal').style.display='none'"
                    class="btn btn-secondary">Cancel</button>
                <button onclick="saveOfficerEdit()" class="btn btn-success">Update Officer</button>
            </div>
        </div>
    </div>

    <!-- View Officer Modal -->
    <div id="viewOfficerModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:20px; border-radius:10px; width:95%; max-width:600px; max-height: 90vh; overflow-y: auto; position:relative;">
            <button onclick="document.getElementById('viewOfficerModal').style.display='none'"
                style="position:absolute; right:15px; top:15px; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            <h3 style="border-bottom:1px solid #eee; padding-bottom:10px;">पदाधिकारी विवरण (Officer Profile)</h3>
            <div id="officerProfileContent" style="margin-top:20px;"></div>
        </div>
    </div>

    <!-- View Invoice Modal -->
    <div id="viewInvoiceModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1002; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:30px; border-radius:10px; width:95%; max-width:800px; max-height: 95vh; overflow-y: auto; position:relative;">
            <button onclick="document.getElementById('viewInvoiceModal').style.display='none'" class="btn-close-invoice"
                style="position:absolute; right:15px; top:15px; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>

            <div id="invoiceContent" class="invoice-box">
                <!-- JS Populated -->
            </div>

            <div style="margin-top: 20px; text-align: right; border-top: 1px solid #eee; padding-top: 20px;"
                class="no-print">
                <button onclick="printInvoice()" class="btn btn-primary"><i class="fa-solid fa-print"></i> प्रिंट
                    (Print)</button>
                <button onclick="downloadInvoicePDF(this)" class="btn btn-success"><i class="fa-solid fa-file-pdf"></i>
                    डाऊनलोड (PDF)</button>
            </div>
        </div>
    </div>

    <!-- View ID Card Modal -->
    <div id="viewIDCardModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1003; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:15px; border-radius:15px; width:95%; max-width:450px; position:relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <button onclick="document.getElementById('viewIDCardModal').style.display='none'"
                style="position:absolute; right:10px; top:10px; border:none; background:#eee; width:30px; height:30px; border-radius:50%; font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
            <div id="idCardContent" style="margin-top:10px;">
                <!-- Professional ID Card Layout -->
            </div>
            <div style="margin-top: 15px; text-align: center; display: flex; gap: 10px; justify-content: center;">
                <button onclick="printDiv('idCardContent')" class="btn btn-primary btn-sm"><i
                        class="fa-solid fa-print"></i> Print Card</button>
                <button onclick="downloadIDCardPDF()" class="btn btn-success btn-sm"><i
                        class="fa-solid fa-file-pdf"></i> Download</button>
            </div>
        </div>
    </div>
</body>

</html>